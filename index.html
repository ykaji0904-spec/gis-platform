<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GIS Platform - „Éõ„Éº„ÇπÂª∂Èï∑„Ç∑„Éü„É•„É¨„Éº„Çø„Éº</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans JP', sans-serif; overflow: hidden; background: #0a0a0a; }
        #cesiumContainer { width: 100vw; height: 100vh; }

        .top-bar { position: fixed; top: 0; left: 0; right: 0; height: 48px; background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(255, 255, 255, 0.08); display: flex; align-items: center; padding: 0 10px; z-index: 1000; gap: 8px; }
        .map-type-switch { display: flex; background: rgba(255, 255, 255, 0.08); border-radius: 20px; padding: 3px; }
        .map-type-btn { padding: 5px 10px; border: none; background: transparent; color: rgba(255,255,255,0.6); font-size: 10px; cursor: pointer; border-radius: 16px; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        .map-type-btn.active { background: rgba(0, 212, 255, 0.2); color: #00d4ff; }
        .map-type-btn .material-icons { font-size: 14px; }
        .search-box { flex: 1; max-width: 200px; }
        .search-input { width: 100%; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 16px; padding: 6px 12px; color: white; font-size: 11px; outline: none; }
        .search-input::placeholder { color: rgba(255,255,255,0.4); }
        .layer-btn { display: flex; align-items: center; gap: 4px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); padding: 5px 10px; border-radius: 16px; cursor: pointer; color: rgba(255,255,255,0.8); font-size: 10px; }
        .layer-btn .material-icons { font-size: 14px; }
        .avatar { width: 28px; height: 28px; background: linear-gradient(135deg, #ff6b6b, #ffa06b); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 11px; margin-left: auto; }

        .layer-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; }
        .layer-modal-overlay.show { display: block; }
        .layer-modal { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(20, 20, 20, 0.98); border-radius: 16px 16px 0 0; z-index: 2001; max-height: 70vh; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s ease; }
        .layer-modal.show { transform: translateY(0); }
        .layer-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; background: rgba(20, 20, 20, 0.98); }
        .layer-modal-title { color: white; font-size: 14px; font-weight: 600; }
        .layer-modal-close { background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; padding: 4px; }
        .layer-section { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .layer-section-title { color: rgba(255,255,255,0.4); font-size: 10px; text-transform: uppercase; margin-bottom: 10px; font-weight: 500; }
        .layer-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .layer-card { display: flex; flex-direction: column; align-items: center; padding: 10px 4px; border-radius: 10px; cursor: pointer; background: rgba(255,255,255,0.03); border: 2px solid transparent; transition: all 0.2s; }
        .layer-card:hover { background: rgba(255,255,255,0.06); }
        .layer-card.active { background: rgba(0, 212, 255, 0.1); border-color: #00d4ff; }
        .layer-card-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 6px; }
        .layer-card-icon .material-icons { font-size: 20px; }
        .layer-card-icon.fire { background: rgba(244, 67, 54, 0.15); color: #f44336; }
        .layer-card-icon.water { background: rgba(33, 150, 243, 0.15); color: #2196f3; }
        .layer-card-icon.hose { background: rgba(255, 152, 0, 0.15); color: #ff9800; }
        .layer-card-icon.measure { background: rgba(0, 212, 255, 0.15); color: #00d4ff; }
        .layer-card-icon.building { background: rgba(139, 195, 74, 0.15); color: #8bc34a; }
        .layer-card-icon.trail { background: rgba(76, 175, 80, 0.15); color: #4caf50; }
        .layer-card-icon.flood { background: rgba(33, 150, 243, 0.15); color: #2196f3; }
        .layer-card-icon.tsunami { background: rgba(0, 188, 212, 0.15); color: #00bcd4; }
        .layer-card-icon.landslide { background: rgba(255, 87, 34, 0.15); color: #ff5722; }
        .layer-card-name { color: white; font-size: 9px; text-align: center; line-height: 1.2; }

        .mode-indicator { position: fixed; top: 56px; left: 50%; transform: translateX(-50%); background: rgba(244, 67, 54, 0.9); padding: 6px 12px; border-radius: 16px; display: none; align-items: center; gap: 6px; z-index: 1000; }
        .mode-indicator.show { display: flex; }
        .mode-indicator.water-mode { background: rgba(33, 150, 243, 0.9); }
        .mode-indicator.hose-mode { background: rgba(255, 152, 0, 0.9); }
        .mode-indicator.measure-mode { background: rgba(0, 212, 255, 0.9); }
        .mode-indicator .material-icons { color: white; font-size: 14px; }
        .mode-indicator span { color: white; font-size: 11px; font-weight: 500; }

        .bottom-panel { position: fixed; bottom: 56px; left: 8px; right: 8px; background: rgba(10, 10, 10, 0.95); padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1); z-index: 900; display: none; }
        .bottom-panel.active { display: block; }
        .bottom-panel.fire { border-color: rgba(244, 67, 54, 0.25); }
        .bottom-panel.water { border-color: rgba(33, 150, 243, 0.25); }
        .bottom-panel.hose, .bottom-panel.hose-info { border-color: rgba(255, 152, 0, 0.25); }
        .bottom-panel.measure { border-color: rgba(0, 212, 255, 0.25); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .panel-title { font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 4px; }
        .panel-title.fire { color: #f44336; }
        .panel-title.water { color: #2196f3; }
        .panel-title.hose { color: #ff9800; }
        .panel-title.measure { color: #00d4ff; }
        .panel-title .material-icons { font-size: 14px; }
        .panel-close { background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; padding: 4px; }
        .panel-stats { display: flex; gap: 12px; flex-wrap: wrap; }
        .panel-stat { flex: 1; min-width: 60px; }
        .panel-stat-label { color: rgba(255,255,255,0.4); font-size: 8px; text-transform: uppercase; margin-bottom: 2px; }
        .panel-stat-value { color: white; font-size: 13px; font-weight: 600; }
        .panel-stat-value.highlight { color: #00d4ff; }
        .panel-stat-value.fire-highlight { color: #f44336; }
        .panel-stat-value.water-highlight { color: #2196f3; }
        .panel-stat-value.measure-highlight { color: #00d4ff; }
        .panel-stat-value.ok { color: #4ade80; }
        .panel-stat-value.warning { color: #ef4444; }
        .panel-hint { color: rgba(255,255,255,0.3); font-size: 9px; margin-top: 8px; }
        .panel-actions { display: flex; gap: 6px; margin-top: 10px; }
        .panel-btn { flex: 1; padding: 8px; border: none; border-radius: 6px; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .panel-btn .material-icons { font-size: 14px; }
        .panel-btn.primary { background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%); color: white; }
        .panel-btn.secondary { background: rgba(255,255,255,0.08); color: white; }
        .panel-btn.danger { background: rgba(244, 67, 54, 0.15); color: #f44336; }

        .section-title { color: rgba(255,255,255,0.35); font-size: 8px; text-transform: uppercase; margin-bottom: 6px; }
        .sim-param-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .sim-param-item { display: flex; flex-direction: column; gap: 2px; }
        .sim-param-item label { font-size: 9px; color: rgba(255,255,255,0.5); }
        .sim-param-input-wrap { display: flex; align-items: center; gap: 4px; }
        .sim-param-input-wrap input { width: 50px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; padding: 4px 6px; color: white; font-size: 11px; text-align: right; }
        .sim-param-input-wrap span { font-size: 9px; color: rgba(255,255,255,0.4); }
        .recalc-btn { margin-top: 10px; width: 100%; padding: 8px; background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%); border: none; border-radius: 6px; color: white; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .recalc-btn .material-icons { font-size: 14px; }
        .segment-table-wrap { max-height: 150px; overflow-y: auto; margin-top: 6px; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; }
        .segment-table { width: 100%; border-collapse: collapse; font-size: 9px; }
        .segment-table th { background: rgba(255,255,255,0.05); padding: 6px 4px; text-align: center; color: rgba(255,255,255,0.6); font-weight: 500; position: sticky; top: 0; }
        .segment-table td { padding: 5px 4px; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); color: rgba(255,255,255,0.8); }
        .segment-table tr.green td { background: rgba(74, 222, 128, 0.1); }
        .segment-table tr.yellow td { background: rgba(251, 191, 36, 0.1); }
        .segment-table tr.red td { background: rgba(239, 68, 68, 0.1); }
        .segment-table td:first-child { font-weight: 600; color: white; }
        .segment-table td:last-child { font-weight: 600; }
        .segment-table .elev-up { color: #ef4444; }
        .segment-table .elev-down { color: #4ade80; }
        .sim-legend { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.08); }
        .legend-item { display: flex; align-items: center; gap: 3px; font-size: 8px; color: rgba(255,255,255,0.5); }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
        .legend-dot.green { background: #4ade80; }
        .legend-dot.yellow { background: #fbbf24; }
        .legend-dot.red { background: #ef4444; }
        .legend-dot.conf { background: #ff9800; }
        .legend-dot.end { background: #3b82f6; }
        .sim-params { background: rgba(255,255,255,0.02); border-radius: 8px; padding: 10px; margin-top: 8px; }
        .sim-params-title { color: rgba(255,255,255,0.5); font-size: 9px; font-weight: 500; margin-bottom: 4px; }

        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10, 10, 10, 0.95); border-top: 1px solid rgba(255, 255, 255, 0.08); padding: 6px 10px; z-index: 1000; display: flex; align-items: center; justify-content: space-between; }
        .my-location { display: flex; align-items: center; gap: 6px; background: rgba(255, 255, 255, 0.05); padding: 6px 10px; border-radius: 6px; cursor: pointer; }
        .my-location .material-icons { font-size: 16px; color: #4ade80; }
        .my-location-coords { color: white; font-size: 10px; font-family: monospace; }
        .view-toggle { display: flex; background: rgba(255, 255, 255, 0.05); border-radius: 6px; }
        .view-btn { padding: 6px 12px; border: none; background: transparent; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 10px; display: flex; align-items: center; gap: 3px; }
        .view-btn.active { background: rgba(0, 212, 255, 0.15); color: #00d4ff; border-radius: 6px; }
        .view-btn .material-icons { font-size: 12px; }

        .credit-bar { position: fixed; bottom: 52px; right: 8px; background: rgba(0,0,0,0.6); padding: 3px 8px; border-radius: 4px; font-size: 8px; color: rgba(255,255,255,0.7); z-index: 800; }
        .coord-display { position: fixed; bottom: 52px; left: 8px; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; font-size: 9px; color: rgba(255,255,255,0.8); font-family: monospace; z-index: 800; }
        .loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(10,10,10,0.95); padding: 16px 24px; border-radius: 10px; color: white; font-size: 11px; display: none; z-index: 2000; }
        .loading.show { display: block; }
        .toast { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(50,50,50,0.95); padding: 10px 16px; border-radius: 8px; color: white; font-size: 11px; z-index: 2100; display: none; }
        .toast.show { display: block; animation: fadeInOut 2.5s ease; }
        @keyframes fadeInOut { 0%,100% { opacity: 0; } 10%,90% { opacity: 1; } }
        .search-results { position: fixed; top: 52px; left: 100px; width: 200px; max-height: 200px; overflow-y: auto; background: rgba(20,20,20,0.98); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); z-index: 1100; display: none; }
        .search-results.show { display: block; }
        .search-result-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .search-result-item:hover { background: rgba(255,255,255,0.05); }
        .search-result-name { color: white; font-size: 11px; }
        .search-result-address { color: rgba(255,255,255,0.5); font-size: 9px; margin-top: 2px; }
        .cesium-viewer-toolbar, .cesium-viewer-animationContainer, .cesium-viewer-timelineContainer, .cesium-viewer-fullscreenContainer, .cesium-viewer-bottom { display: none !important; }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div class="loading" id="loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
    <div class="toast" id="toast"></div>
    <div class="credit-bar">¬© Cesium ion</div>
    <div class="coord-display" id="coordDisplay">--</div>
    <div class="search-results" id="searchResults"></div>

    <div class="top-bar">
        <div class="map-type-switch">
            <button class="map-type-btn active" id="mapBtnSatellite" onclick="setBasemap('satellite')"><span class="material-icons">satellite</span><span>Ë°õÊòü</span></button>
            <button class="map-type-btn" id="mapBtnStd" onclick="setBasemap('std')"><span class="material-icons">map</span><span>Âú∞Âõ≥</span></button>
        </div>
        <div class="search-box"><input type="text" class="search-input" id="searchInput" placeholder="‰ΩèÊâÄ„ÉªÂ†¥ÊâÄ„ÇíÊ§úÁ¥¢..." onkeydown="if(event.key==='Enter')doSearch()"></div>
        <div class="layer-btn" onclick="openLayerModal()"><span class="material-icons">layers</span><span>„É¨„Ç§„É§</span></div>
        <div class="avatar">K</div>
    </div>

    <div class="mode-indicator" id="modeIndicator"><span class="material-icons" id="modeIcon">local_fire_department</span><span id="modeText">ÁÅ´ÁÇπËøΩÂä†</span></div>

    <div class="layer-modal-overlay" id="layerModalOverlay" onclick="closeLayerModal()"></div>
    <div class="layer-modal" id="layerModal">
        <div class="layer-modal-header"><span class="layer-modal-title">„É¨„Ç§„É§ÈÅ∏Êäû</span><button class="layer-modal-close" onclick="closeLayerModal()"><span class="material-icons">close</span></button></div>
        <div class="layer-section">
            <div class="layer-section-title">Âú∞Âõ≥„É¨„Ç§„É§</div>
            <div class="layer-grid">
                <div class="layer-card active" id="layerBuildings" onclick="toggleMapLayer('buildings')"><div class="layer-card-icon building"><span class="material-icons">location_city</span></div><span class="layer-card-name">3DÂª∫Áâ©</span></div>
                <div class="layer-card" id="layerTrails" onclick="toggleMapLayer('trails')"><div class="layer-card-icon trail"><span class="material-icons">hiking</span></div><span class="layer-card-name">ÁôªÂ±±ÈÅì</span></div>
            </div>
        </div>
        <div class="layer-section">
            <div class="layer-section-title">„Ç™„Éö„É¨„Éº„Ç∑„Éß„É≥</div>
            <div class="layer-grid">
                <div class="layer-card" id="opFire" onclick="setOperation('fire')"><div class="layer-card-icon fire"><span class="material-icons">local_fire_department</span></div><span class="layer-card-name">ÁÅ´ÁÇπ</span></div>
                <div class="layer-card" id="opWater" onclick="setOperation('water')"><div class="layer-card-icon water"><span class="material-icons">water_drop</span></div><span class="layer-card-name">Ê∞¥Âà©</span></div>
                <div class="layer-card" id="opHose" onclick="setOperation('hose')"><div class="layer-card-icon hose"><span class="material-icons">route</span></div><span class="layer-card-name">„Éõ„Éº„ÇπÂª∂Èï∑</span></div>
                <div class="layer-card" id="opMeasure" onclick="setOperation('measure')"><div class="layer-card-icon measure"><span class="material-icons">straighten</span></div><span class="layer-card-name">2ÁÇπË®àÊ∏¨</span></div>
            </div>
        </div>
        <div class="layer-section">
            <div class="layer-section-title">ÊÉÖÂ†±„É¨„Ç§„É§Ôºà„Éè„Ç∂„Éº„ÉâÔºâ</div>
            <div class="layer-grid">
                <div class="layer-card" id="layerFlood" onclick="toggleHazardLayer('flood')"><div class="layer-card-icon flood"><span class="material-icons">water</span></div><span class="layer-card-name">Ê¥™Ê∞¥</span></div>
                <div class="layer-card" id="layerTsunami" onclick="toggleHazardLayer('tsunami')"><div class="layer-card-icon tsunami"><span class="material-icons">waves</span></div><span class="layer-card-name">Ê¥•Ê≥¢</span></div>
                <div class="layer-card" id="layerLandslide" onclick="toggleHazardLayer('landslide')"><div class="layer-card-icon landslide"><span class="material-icons">landslide</span></div><span class="layer-card-name">ÂúüÁ†Ç</span></div>
            </div>
        </div>
    </div>

    <div class="bottom-panel fire" id="firePanel">
        <div class="panel-header"><span class="panel-title fire"><span class="material-icons">local_fire_department</span>ÁÅ´ÁÇπ</span><button class="panel-close" onclick="closePanel('fire')"><span class="material-icons">close</span></button></div>
        <div class="panel-stats">
            <div class="panel-stat"><div class="panel-stat-label">Á∑ØÂ∫¶</div><div class="panel-stat-value" id="fireLat">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">ÁµåÂ∫¶</div><div class="panel-stat-value" id="fireLon">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">Ê®ôÈ´ò</div><div class="panel-stat-value fire-highlight" id="fireElev">-</div></div>
        </div>
        <div class="panel-actions"><button class="panel-btn danger" onclick="deleteSelectedFire()"><span class="material-icons">delete</span>ÂâäÈô§</button></div>
    </div>

    <div class="bottom-panel water" id="waterPanel">
        <div class="panel-header"><span class="panel-title water"><span class="material-icons">water_drop</span>Ê∞¥Âà©</span><button class="panel-close" onclick="closePanel('water')"><span class="material-icons">close</span></button></div>
        <div class="panel-stats">
            <div class="panel-stat"><div class="panel-stat-label">Á®ÆÂà•</div><div class="panel-stat-value water-highlight" id="waterType">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">Á∑ØÂ∫¶</div><div class="panel-stat-value" id="waterLat">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">ÁµåÂ∫¶</div><div class="panel-stat-value" id="waterLon">-</div></div>
        </div>
        <div class="panel-actions"><button class="panel-btn danger" onclick="deleteSelectedWater()"><span class="material-icons">delete</span>ÂâäÈô§</button></div>
    </div>

    <div class="bottom-panel hose-info" id="hoseInfoPanel">
        <div class="panel-header"><span class="panel-title hose"><span class="material-icons">route</span>„Éõ„Éº„ÇπÂª∂Èï∑„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥</span><button class="panel-close" onclick="closePanel('hoseInfo')"><span class="material-icons">close</span></button></div>
        <div class="panel-stats">
            <div class="panel-stat"><div class="panel-stat-label">Á∑èÂª∂Èï∑</div><div class="panel-stat-value highlight" id="hoseInfoDist">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">„Éõ„Éº„Çπ</div><div class="panel-stat-value" id="hoseInfoCount">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">ÂèØÊê¨Âè∞Êï∞</div><div class="panel-stat-value" id="hoseInfoRelay">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">Á≠íÂÖàÂúß</div><div class="panel-stat-value" id="hoseInfoEndP">-</div></div>
        </div>
        <div class="section-title" style="margin-top:8px;">Âå∫ÈñìË©≥Á¥∞</div>
        <div class="segment-table-wrap"><table class="segment-table"><thead><tr><th>Âå∫Èñì</th><th>Ë∑ùÈõ¢</th><th>Êú¨Êï∞</th><th>È´ò‰ΩéÂ∑Æ</th><th>ÊêçÂ§±</th><th>ÊÆãÂúß</th></tr></thead><tbody id="segmentTableBody"></tbody></table></div>
        <div class="sim-legend"><div class="legend-item"><div class="legend-dot conf"></div>ÂèØÊê¨</div><div class="legend-item"><div class="legend-dot end"></div>Á≠íÂÖà</div><div class="legend-item"><div class="legend-dot green"></div>‚â•0.4</div><div class="legend-item"><div class="legend-dot yellow"></div>‚â•0.2</div><div class="legend-item"><div class="legend-dot red"></div>&lt;0.2</div></div>
        <div class="sim-params">
            <div class="sim-params-title">Ë®àÁÆóÊù°‰ª∂</div>
            <div class="sim-param-grid">
                <div class="sim-param-item"><label>ÈÄÅÊ∞¥Âúß</label><div class="sim-param-input-wrap"><input type="number" id="paramPumpOut" value="0.6" step="0.05"><span>MPa</span></div></div>
                <div class="sim-param-item"><label>ÂèóÊ∞¥Âúß</label><div class="sim-param-input-wrap"><input type="number" id="paramInlet" value="0.2" step="0.05"><span>MPa</span></div></div>
                <div class="sim-param-item"><label>Á≠íÂÖàÂúß</label><div class="sim-param-input-wrap"><input type="number" id="paramNozzle" value="0.4" step="0.05"><span>MPa</span></div></div>
                <div class="sim-param-item"><label>ÊêçÂ§±/Êú¨</label><div class="sim-param-input-wrap"><input type="number" id="paramLossPerHose" value="0.02" step="0.005"><span>MPa</span></div></div>
            </div>
            <button class="recalc-btn" onclick="onParamChange()"><span class="material-icons">refresh</span>ÂÜçË®àÁÆó</button>
        </div>
        <div class="panel-actions"><button class="panel-btn danger" onclick="deleteSelectedHose()"><span class="material-icons">delete</span>ÂâäÈô§</button></div>
    </div>

    <div class="bottom-panel hose" id="hosePanel">
        <div class="panel-header"><span class="panel-title hose"><span class="material-icons">route</span>„Éõ„Éº„ÇπÂª∂Èï∑(ÊûóÈáé)</span><button class="panel-close" onclick="closeHosePanel()"><span class="material-icons">close</span></button></div>
        <div class="panel-stats">
            <div class="panel-stat"><div class="panel-stat-label">Á∑èÂª∂Èï∑</div><div class="panel-stat-value highlight" id="hoseTotalDist">0m</div></div>
            <div class="panel-stat"><div class="panel-stat-label">Êú¨Êï∞(20m)</div><div class="panel-stat-value" id="hoseTotalCount">0Êú¨</div></div>
            <div class="panel-stat"><div class="panel-stat-label">È´ò‰ΩéÂ∑Æ</div><div class="panel-stat-value" id="hoseElevInfo">-</div></div>
        </div>
        <div class="panel-hint" id="hoseHint">ÈÄ£Á∂ö„Çø„ÉÉ„Éó„Åß„Éù„Ç§„É≥„ÉàËøΩÂä†</div>
        <div class="panel-actions">
            <button class="panel-btn secondary" onclick="undoHosePoint()"><span class="material-icons">undo</span>Êàª„Åô</button>
            <button class="panel-btn danger" onclick="resetHoseLine()"><span class="material-icons">delete</span></button>
            <button class="panel-btn primary" onclick="confirmHoseLine()"><span class="material-icons">check</span>Á¢∫ÂÆö</button>
        </div>
    </div>

    <div class="bottom-panel measure" id="measurePanel">
        <div class="panel-header"><span class="panel-title measure">2ÁÇπË®àÊ∏¨</span><button class="panel-close" onclick="closeMeasurePanel()"><span class="material-icons">close</span></button></div>
        <div class="panel-stats">
            <div class="panel-stat"><div class="panel-stat-label">Âú∞Ë°®Ë∑ùÈõ¢</div><div class="panel-stat-value measure-highlight" id="measureDistance">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">Áõ¥Á∑öË∑ùÈõ¢</div><div class="panel-stat-value" id="measureStraight">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">È´ò‰ΩéÂ∑Æ</div><div class="panel-stat-value" id="measureElev">-</div></div>
        </div>
        <div class="panel-hint" id="measureHint">2ÁÇπ„Çí„Çø„ÉÉ„Éó</div>
        <div class="panel-actions"><button class="panel-btn secondary" onclick="resetMeasure()"><span class="material-icons">refresh</span>„É™„Çª„ÉÉ„Éà</button></div>
    </div>

    <div class="bottom-bar">
        <div class="my-location" onclick="goToMyLocation()"><span class="material-icons">my_location</span><span class="my-location-coords" id="myLocationText">ÂèñÂæó‰∏≠...</span></div>
        <div class="view-toggle">
            <button class="view-btn" onclick="setViewMode('2d')"><span class="material-icons">map</span>2D</button>
            <button class="view-btn active" onclick="setViewMode('3d')"><span class="material-icons">view_in_ar</span>3D</button>
        </div>
    </div>

    <script>
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0YjkwN2E2MC1jYjM5LTRmNzUtOTEyZS1hYTBlNmYzNWRhMjUiLCJpZCI6MjU5MjkyLCJpYXQiOjE3MzI2MTg4MDB9.vvcLKVhx_sUMFYMYwZzArW2DfXRxXdJdgfxDqpE7ba8';
        const viewer = new Cesium.Viewer('cesiumContainer', { terrain: Cesium.Terrain.fromWorldTerrain(), baseLayerPicker: false, geocoder: false, homeButton: false, sceneModePicker: false, navigationHelpButton: false, animation: false, timeline: false, fullscreenButton: false, infoBox: false, selectionIndicator: false });
        viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(132.4553, 34.3853, 3000), orientation: { heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0 }, duration: 2 });

        const layers = { buildings: true, trails: false, flood: false, tsunami: false, landslide: false };
        let currentTool = null, osmBuildingsTileset = null, trailEntities = [], loadedTrailTiles = new Set(), trailLoadActive = false;
        let hazardLayers = { flood: null, tsunami: null, landslide: null };
        let currentBasemap = 'satellite', stdLayer = null, satelliteLayer = null;

        async function initBasemaps() { satelliteLayer = viewer.imageryLayers.get(0); stdLayer = new Cesium.ImageryLayer(new Cesium.UrlTemplateImageryProvider({ url: 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', maximumLevel: 18 })); viewer.imageryLayers.add(stdLayer); stdLayer.show = false; }
        initBasemaps();
        function setBasemap(type) { document.querySelectorAll('.map-type-btn').forEach(b => b.classList.remove('active')); if (type === 'satellite') { document.getElementById('mapBtnSatellite').classList.add('active'); if (satelliteLayer) satelliteLayer.show = true; if (stdLayer) stdLayer.show = false; } else { document.getElementById('mapBtnStd').classList.add('active'); if (satelliteLayer) satelliteLayer.show = false; if (stdLayer) stdLayer.show = true; } currentBasemap = type; }

        async function init3DBuildings() { try { osmBuildingsTileset = await Cesium.createOsmBuildingsAsync(); viewer.scene.primitives.add(osmBuildingsTileset); osmBuildingsTileset.show = layers.buildings; } catch(e) {} }
        init3DBuildings();

        function openLayerModal() { document.getElementById('layerModalOverlay').classList.add('show'); document.getElementById('layerModal').classList.add('show'); updateLayerCards(); }
        function closeLayerModal() { document.getElementById('layerModalOverlay').classList.remove('show'); document.getElementById('layerModal').classList.remove('show'); }
        function updateLayerCards() {
            document.getElementById('layerBuildings').classList.toggle('active', layers.buildings);
            document.getElementById('layerTrails').classList.toggle('active', layers.trails);
            document.getElementById('layerFlood').classList.toggle('active', layers.flood);
            document.getElementById('layerTsunami').classList.toggle('active', layers.tsunami);
            document.getElementById('layerLandslide').classList.toggle('active', layers.landslide);
            document.querySelectorAll('#opFire, #opWater, #opHose, #opMeasure').forEach(el => el.classList.remove('active'));
            if (currentTool === 'fire') document.getElementById('opFire').classList.add('active');
            if (currentTool === 'water') document.getElementById('opWater').classList.add('active');
            if (currentTool === 'hose') document.getElementById('opHose').classList.add('active');
            if (currentTool === 'measure') document.getElementById('opMeasure').classList.add('active');
        }
        function toggleMapLayer(layer) { layers[layer] = !layers[layer]; if (layer === 'buildings' && osmBuildingsTileset) osmBuildingsTileset.show = layers.buildings; if (layer === 'trails') { trailEntities.forEach(e => e.show = layers.trails); if (layers.trails) loadTrails(); } updateLayerCards(); }
        function toggleHazardLayer(layer) { const wasOn = layers[layer]; ['flood', 'tsunami', 'landslide'].forEach(h => { layers[h] = false; if (hazardLayers[h]) { viewer.imageryLayers.remove(hazardLayers[h]); hazardLayers[h] = null; } }); if (!wasOn) { layers[layer] = true; loadHazardLayer(layer); } updateLayerCards(); }
        function loadHazardLayer(layer) { const urls = { flood: 'https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png', tsunami: 'https://disaportaldata.gsi.go.jp/raster/04_tsunami_newlegend_data/{z}/{x}/{y}.png', landslide: 'https://disaportaldata.gsi.go.jp/raster/05_dosekiryukeikaikuiki/{z}/{x}/{y}.png' }; if (urls[layer]) { hazardLayers[layer] = viewer.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({ url: urls[layer], maximumLevel: 17 })); hazardLayers[layer].alpha = 0.6; } }
        function setOperation(op) { if (currentTool === op) { clearTool(); updateLayerCards(); return; } clearTool(); currentTool = op; const ind = document.getElementById('modeIndicator'), icon = document.getElementById('modeIcon'), text = document.getElementById('modeText'); if (op === 'fire') { icon.textContent = 'local_fire_department'; text.textContent = 'ÁÅ´ÁÇπËøΩÂä†'; ind.className = 'mode-indicator show'; } else if (op === 'water') { icon.textContent = 'water_drop'; text.textContent = 'Ê∞¥Âà©ËøΩÂä†'; ind.className = 'mode-indicator show water-mode'; } else if (op === 'hose') { icon.textContent = 'route'; text.textContent = '„Éõ„Éº„ÇπÂª∂Èï∑(ÊûóÈáé)'; ind.className = 'mode-indicator show hose-mode'; document.getElementById('hosePanel').classList.add('active'); resetHoseLine(); } else if (op === 'measure') { icon.textContent = 'straighten'; text.textContent = '2ÁÇπË®àÊ∏¨'; ind.className = 'mode-indicator show measure-mode'; document.getElementById('measurePanel').classList.add('active'); resetMeasure(); } updateLayerCards(); closeLayerModal(); }
        function clearTool() { currentTool = null; document.getElementById('modeIndicator').className = 'mode-indicator'; document.getElementById('hosePanel').classList.remove('active'); document.getElementById('measurePanel').classList.remove('active'); }

        async function loadTrails() { if (trailLoadActive) return; const c = viewer.camera.positionCartographic, lat = Cesium.Math.toDegrees(c.latitude), lon = Cesium.Math.toDegrees(c.longitude); const key = `${Math.floor(lat/0.05)}_${Math.floor(lon/0.05)}`; if (loadedTrailTiles.has(key)) return; trailLoadActive = true; showLoading(true); try { const query = `[out:json][timeout:30];(way["highway"~"path|footway|track"](around:5000,${lat},${lon}););out body;>;out skel qt;`; const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`); const data = await res.json(), nodes = {}; data.elements.filter(e => e.type === 'node').forEach(n => nodes[n.id] = [n.lon, n.lat]); data.elements.filter(e => e.type === 'way').forEach(way => { if (trailEntities.some(e => e.osmId === way.id)) return; const pos = way.nodes.filter(nid => nodes[nid]).map(nid => Cesium.Cartesian3.fromDegrees(nodes[nid][0], nodes[nid][1])); if (pos.length >= 2) { const e = viewer.entities.add({ polyline: { positions: pos, width: 3, material: Cesium.Color.LIGHTGREEN.withAlpha(0.8), clampToGround: true } }); e.show = layers.trails; e.osmId = way.id; trailEntities.push(e); } }); loadedTrailTiles.add(key); } catch(e) {} trailLoadActive = false; showLoading(false); }

        async function doSearch() { const q = document.getElementById('searchInput').value.trim(); if (!q) return; showLoading(true); try { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&countrycodes=jp&limit=5`); const data = await res.json(); const sr = document.getElementById('searchResults'); if (data.length === 0) sr.innerHTML = '<div class="search-result-item"><span class="search-result-name">ÁµêÊûú„Å™„Åó</span></div>'; else sr.innerHTML = data.map(r => `<div class="search-result-item" onclick="flyToSearch(${r.lon}, ${r.lat})"><div class="search-result-name">${r.display_name.split(',')[0]}</div><div class="search-result-address">${r.display_name}</div></div>`).join(''); sr.classList.add('show'); } catch(e) { showToast('Ê§úÁ¥¢„Ç®„É©„Éº'); } showLoading(false); }
        function flyToSearch(lon, lat) { viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(lon, lat, 1500), duration: 1.5 }); document.getElementById('searchResults').classList.remove('show'); }
        document.addEventListener('click', (e) => { if (!e.target.closest('.search-box') && !e.target.closest('.search-results')) document.getElementById('searchResults').classList.remove('show'); });
        function goToMyLocation() { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(pos => { viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(pos.coords.longitude, pos.coords.latitude, 1000), duration: 1.5 }); document.getElementById('myLocationText').textContent = `${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`; }, () => { document.getElementById('myLocationText').textContent = 'ÂèñÂæóÂ§±Êïó'; }); } }
        goToMyLocation();
        viewer.camera.moveEnd.addEventListener(() => { const c = viewer.camera.positionCartographic; document.getElementById('coordDisplay').textContent = `${Cesium.Math.toDegrees(c.latitude).toFixed(5)}, ${Cesium.Math.toDegrees(c.longitude).toFixed(5)}`; });

        let firePoints = [], firePointEntities = [], selectedFirePoint = null, firePointIdCounter = 0, fireAreaEntity = null;
        function addFirePoint(lon, lat, height) { const id = `fire-${++firePointIdCounter}`; firePoints.push({ id, lon, lat, height }); const e = viewer.entities.add({ id: id, position: Cesium.Cartesian3.fromDegrees(lon, lat, height), billboard: { image: createFireIcon(), width: 28, height: 28, verticalOrigin: Cesium.VerticalOrigin.BOTTOM, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND } }); firePointEntities.push(e); updateFireArea(); return id; }
        function createFireIcon() { const c = document.createElement('canvas'); c.width = 28; c.height = 28; const ctx = c.getContext('2d'); ctx.beginPath(); ctx.arc(14, 14, 12, 0, Math.PI * 2); ctx.fillStyle = '#f44336'; ctx.fill(); ctx.fillStyle = 'white'; ctx.font = 'bold 14px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('üî•', 14, 14); return c.toDataURL(); }
        function selectFirePoint(id) { const f = firePoints.find(p => p.id === id); if (!f) return; closeAllPanels(); selectedFirePoint = f; document.getElementById('fireLat').textContent = f.lat.toFixed(5) + '¬∞'; document.getElementById('fireLon').textContent = f.lon.toFixed(5) + '¬∞'; document.getElementById('fireElev').textContent = f.height.toFixed(1) + 'm'; document.getElementById('firePanel').classList.add('active'); }
        function updateFireArea() { if (fireAreaEntity) { viewer.entities.remove(fireAreaEntity); fireAreaEntity = null; } if (firePoints.length < 3) return; const hull = convexHull(firePoints.map(f => [f.lon, f.lat])); if (hull.length < 3) return; fireAreaEntity = viewer.entities.add({ polygon: { hierarchy: hull.map(c => Cesium.Cartesian3.fromDegrees(c[0], c[1])), material: Cesium.Color.RED.withAlpha(0.15), outline: true, outlineColor: Cesium.Color.RED, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND } }); }
        function convexHull(pts) { if (pts.length < 3) return pts; const s = [...pts].sort((a, b) => a[0] - b[0] || a[1] - b[1]); const cr = (o, a, b) => (a[0] - o[0]) * (b[1] - o[1]) - (a[1] - o[1]) * (b[0] - o[0]); const l = []; for (const p of s) { while (l.length >= 2 && cr(l[l.length - 2], l[l.length - 1], p) <= 0) l.pop(); l.push(p); } const u = []; for (let i = s.length - 1; i >= 0; i--) { const p = s[i]; while (u.length >= 2 && cr(u[u.length - 2], u[u.length - 1], p) <= 0) u.pop(); u.push(p); } u.pop(); l.pop(); return l.concat(u); }
        function deleteSelectedFire() { if (!selectedFirePoint) { showToast('ÁÅ´ÁÇπ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì'); return; } const id = selectedFirePoint.id; firePoints = firePoints.filter(f => f.id !== id); const entity = firePointEntities.find(e => e.id === id || e._id === id); if (entity) { viewer.entities.remove(entity); firePointEntities = firePointEntities.filter(e => e !== entity); } selectedFirePoint = null; closePanel('fire'); updateFireArea(); showToast('ÁÅ´ÁÇπ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü'); }

        let waterSources = [], waterEntities = [], selectedWater = null, waterIdCounter = 0;
        function addWaterSource(type, name, lon, lat) { const id = `water-${++waterIdCounter}`; waterSources.push({ id, type, name, lon, lat }); const e = viewer.entities.add({ id: id, position: Cesium.Cartesian3.fromDegrees(lon, lat, 0), billboard: { image: createWaterIcon(), width: 20, height: 20, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND } }); waterEntities.push(e); return id; }
        function createWaterIcon() { const c = document.createElement('canvas'); c.width = 20; c.height = 20; const ctx = c.getContext('2d'); ctx.beginPath(); ctx.arc(10, 10, 8, 0, Math.PI * 2); ctx.fillStyle = '#2196f3'; ctx.fill(); ctx.fillStyle = 'white'; ctx.font = 'bold 10px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('Ê∞¥', 10, 10); return c.toDataURL(); }
        function selectWater(id) { const w = waterSources.find(x => x.id === id); if (!w) return; closeAllPanels(); selectedWater = w; document.getElementById('waterType').textContent = { hydrant: 'Ê∂àÁÅ´Ê†ì', tank: 'Èò≤ÁÅ´Ê∞¥ÊßΩ', natural: 'Ëá™ÁÑ∂Ê∞¥Âà©' }[w.type] || w.type; document.getElementById('waterLat').textContent = w.lat.toFixed(5) + '¬∞'; document.getElementById('waterLon').textContent = w.lon.toFixed(5) + '¬∞'; document.getElementById('waterPanel').classList.add('active'); }
        function deleteSelectedWater() { if (!selectedWater) { showToast('Ê∞¥Âà©„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì'); return; } const id = selectedWater.id; waterSources = waterSources.filter(w => w.id !== id); const entity = waterEntities.find(e => e.id === id || e._id === id); if (entity) { viewer.entities.remove(entity); waterEntities = waterEntities.filter(e => e !== entity); } selectedWater = null; closePanel('water'); showToast('Ê∞¥Âà©„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü'); }

        let hoseLinePoints = [], hoseLineSegments = [], hoseLineMarkers = [], hoseLineEntities = [], hoseLineIdCounter = 0, selectedHoseLine = null;
        function updateHoseDisplay() { let totalDist = 0, cumElev = 0; for (let i = 1; i < hoseLinePoints.length; i++) { totalDist += geodesicDistance(hoseLinePoints[i-1].lon, hoseLinePoints[i-1].lat, hoseLinePoints[i].lon, hoseLinePoints[i].lat); cumElev += Math.abs(hoseLinePoints[i].height - hoseLinePoints[i-1].height); } document.getElementById('hoseTotalDist').textContent = formatDistance(totalDist); document.getElementById('hoseTotalCount').textContent = Math.ceil(totalDist / 20) + 'Êú¨'; document.getElementById('hoseElevInfo').textContent = hoseLinePoints.length > 1 ? cumElev.toFixed(1) + 'm' : '-'; if (hoseLinePoints.length) document.getElementById('hoseHint').textContent = `${hoseLinePoints.length}ÁÇπ`; }
        function addHosePoint(lon, lat, height, cartesian) { hoseLinePoints.push({ lon, lat, height, cartesian }); const m = viewer.entities.add({ position: cartesian, point: { pixelSize: 8, color: Cesium.Color.ORANGE, outlineColor: Cesium.Color.WHITE, outlineWidth: 1, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND } }); hoseLineMarkers.push(m); if (hoseLinePoints.length >= 2) { const seg = viewer.entities.add({ polyline: { positions: [hoseLinePoints[hoseLinePoints.length-2].cartesian, cartesian], width: 5, material: new Cesium.PolylineDashMaterialProperty({ color: Cesium.Color.ORANGE, dashLength: 12 }), clampToGround: true } }); hoseLineSegments.push(seg); } updateHoseDisplay(); }
        function undoHosePoint() { if (!hoseLinePoints.length) return; hoseLinePoints.pop(); if (hoseLineMarkers.length) viewer.entities.remove(hoseLineMarkers.pop()); if (hoseLineSegments.length) viewer.entities.remove(hoseLineSegments.pop()); updateHoseDisplay(); }
        function resetHoseLine() { hoseLinePoints = []; hoseLineMarkers.forEach(e => viewer.entities.remove(e)); hoseLineMarkers = []; hoseLineSegments.forEach(e => viewer.entities.remove(e)); hoseLineSegments = []; updateHoseDisplay(); document.getElementById('hoseHint').textContent = 'ÈÄ£Á∂ö„Çø„ÉÉ„Éó„Åß„Éù„Ç§„É≥„ÉàËøΩÂä†'; }

        const hoseParams = { pumpOutputMPa: 0.6, minInletPressureMPa: 0.2, nozzleRequiredMPa: 0.4, lossPerHoseMPa: 0.02, hoseLengthM: 20 };
        const hoseSimState = { relayCandidateEntitiesByLine: new Map(), startEndMarkersByLine: new Map(), colorSegmentsByLine: new Map() };
        function calcLossForDistance(L, dh, params) { const nHose = Math.ceil(L / params.hoseLengthM); const frictionLoss = params.lossPerHoseMPa * nHose; let headLoss = dh >= 0 ? 0.01 * dh : 0.01 * dh / 3; return frictionLoss + headLoss; }
        function interpolatePath(points, intervalM = 10) { const result = []; if (points.length < 2) return points; result.push({ ...points[0], distFromStart: 0 }); let totalDist = 0; for (let i = 1; i < points.length; i++) { const p1 = points[i - 1], p2 = points[i]; const segDist = geodesicDistance(p1.lon, p1.lat, p2.lon, p2.lat); const segDh = (p2.height || 0) - (p1.height || 0); const numSteps = Math.max(1, Math.ceil(segDist / intervalM)); for (let s = 1; s <= numSteps; s++) { const t = s / numSteps; result.push({ lon: p1.lon + (p2.lon - p1.lon) * t, lat: p1.lat + (p2.lat - p1.lat) * t, height: (p1.height || 0) + segDh * t, distFromStart: totalDist + segDist * t }); } totalDist += segDist; } return result; }
        function computeRelayPositionsInterpolated(points, params) { const relays = []; const relayBudget = params.pumpOutputMPa - params.minInletPressureMPa; const nozzleBudget = params.pumpOutputMPa - params.nozzleRequiredMPa; if (points.length < 2) return { relays, interpolated: points }; const interp = interpolatePath(points, 10); let pumpIdx = 0, safetyCount = 0; const maxIter = interp.length; while (pumpIdx < interp.length - 1 && safetyCount < maxIter) { safetyCount++; let accLoss = 0, lastSafeIdx = pumpIdx; for (let i = pumpIdx + 1; i < interp.length; i++) { const p1 = interp[i - 1], p2 = interp[i]; const segDist = geodesicDistance(p1.lon, p1.lat, p2.lon, p2.lat); const segDh = (p2.height || 0) - (p1.height || 0); accLoss += calcLossForDistance(segDist, segDh, params); const isEnd = (i === interp.length - 1); const budget = isEnd ? nozzleBudget : relayBudget; if (accLoss > budget) { if (lastSafeIdx > pumpIdx) { relays.push({ index: lastSafeIdx, distFromStart: interp[lastSafeIdx].distFromStart, lon: interp[lastSafeIdx].lon, lat: interp[lastSafeIdx].lat, height: interp[lastSafeIdx].height }); pumpIdx = lastSafeIdx; } else { pumpIdx = i; } break; } lastSafeIdx = i; if (isEnd) pumpIdx = interp.length; } } return { relays, interpolated: interp }; }
        function computePumpSegmentsFromRelays(interpolated, relays, params) { const pumpSegments = []; const relayIndices = [0, ...relays.map(r => r.index)]; for (let p = 0; p < relayIndices.length; p++) { const startIdx = relayIndices[p]; const endIdx = p < relayIndices.length - 1 ? relayIndices[p + 1] : interpolated.length - 1; let segDist = 0, segElev = 0, segLoss = 0; for (let i = startIdx + 1; i <= endIdx; i++) { const p1 = interpolated[i - 1], p2 = interpolated[i]; const d = geodesicDistance(p1.lon, p1.lat, p2.lon, p2.lat); const dh = (p2.height || 0) - (p1.height || 0); segDist += d; segElev += dh; segLoss += calcLossForDistance(d, dh, params); } const segHose = Math.ceil(segDist / params.hoseLengthM); const remainingP = params.pumpOutputMPa - segLoss; const isLast = p === relayIndices.length - 1; pumpSegments.push({ pumpNum: p + 1, nextLabel: isLast ? 'Á≠íÂÖà' : `P${p + 2}`, distance: segDist, hoses: segHose, elevation: segElev, loss: segLoss, remainingPressure: remainingP }); } return pumpSegments; }
        function renderStartEndMarkers(lineId, pathLLH) { const prev = hoseSimState.startEndMarkersByLine.get(lineId) || []; prev.forEach(e => viewer.entities.remove(e)); const markers = []; if (pathLLH.length >= 1) { const start = pathLLH[0]; markers.push(viewer.entities.add({ position: Cesium.Cartesian3.fromDegrees(start.lon, start.lat, start.height || 0), point: { pixelSize: 12, color: Cesium.Color.RED, outlineColor: Cesium.Color.WHITE, outlineWidth: 2, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND }, label: { text: 'P1', font: 'bold 11px sans-serif', fillColor: Cesium.Color.WHITE, outlineColor: Cesium.Color.BLACK, outlineWidth: 2, style: Cesium.LabelStyle.FILL_AND_OUTLINE, verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0, -10) } })); } if (pathLLH.length >= 2) { const end = pathLLH[pathLLH.length - 1]; markers.push(viewer.entities.add({ position: Cesium.Cartesian3.fromDegrees(end.lon, end.lat, end.height || 0), point: { pixelSize: 10, color: Cesium.Color.BLUE, outlineColor: Cesium.Color.WHITE, outlineWidth: 2, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND }, label: { text: 'Á≠íÂÖà', font: 'bold 10px sans-serif', fillColor: Cesium.Color.WHITE, outlineColor: Cesium.Color.BLACK, outlineWidth: 2, style: Cesium.LabelStyle.FILL_AND_OUTLINE, verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0, -10) } })); } hoseSimState.startEndMarkersByLine.set(lineId, markers); }
        function renderRelayMarkersFromPositions(lineId, relays) { const prev = hoseSimState.relayCandidateEntitiesByLine.get(lineId) || []; prev.forEach(e => viewer.entities.remove(e)); const ents = relays.map((r, k) => viewer.entities.add({ id: `relay-${lineId}-${k}`, position: Cesium.Cartesian3.fromDegrees(r.lon, r.lat, r.height || 0), point: { pixelSize: 14, color: Cesium.Color.fromCssColorString('#ff9800'), outlineColor: Cesium.Color.WHITE, outlineWidth: 2, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND }, label: { text: `P${k + 2}`, font: 'bold 11px sans-serif', fillColor: Cesium.Color.WHITE, outlineColor: Cesium.Color.BLACK, outlineWidth: 2, style: Cesium.LabelStyle.FILL_AND_OUTLINE, verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0, -10) } })); hoseSimState.relayCandidateEntitiesByLine.set(lineId, ents); }
        function renderColorizedByPumpSegments(lineId, interpolated, relays, pumpSegments) { const prevSegs = hoseSimState.colorSegmentsByLine?.get(lineId) || []; prevSegs.forEach(e => viewer.entities.remove(e)); if (!hoseSimState.colorSegmentsByLine) hoseSimState.colorSegmentsByLine = new Map(); const segs = []; const relayIndices = [0, ...relays.map(r => r.index)]; for (let p = 0; p < pumpSegments.length; p++) { const seg = pumpSegments[p]; const startIdx = relayIndices[p]; const endIdx = p < relayIndices.length - 1 ? relayIndices[p + 1] : interpolated.length - 1; let color = seg.remainingPressure >= 0.4 ? Cesium.Color.fromCssColorString('#4ade80') : seg.remainingPressure >= 0.2 ? Cesium.Color.fromCssColorString('#fbbf24') : Cesium.Color.fromCssColorString('#ef4444'); const positions = []; for (let i = startIdx; i <= endIdx; i++) positions.push(Cesium.Cartesian3.fromDegrees(interpolated[i].lon, interpolated[i].lat, interpolated[i].height || 0)); if (positions.length >= 2) segs.push(viewer.entities.add({ polyline: { positions: positions, width: 4, material: color, clampToGround: true } })); } hoseSimState.colorSegmentsByLine.set(lineId, segs); }
        function updateHoseInfoPanel(data) { document.getElementById('hoseInfoDist').textContent = formatDistance(data.totalLengthM); document.getElementById('hoseInfoCount').textContent = data.totalHoses20m + 'Êú¨'; const endPEl = document.getElementById('hoseInfoEndP'); endPEl.textContent = data.endPressureMPa.toFixed(2) + ' MPa'; endPEl.className = data.endPressureMPa >= hoseParams.nozzleRequiredMPa ? 'panel-stat-value ok' : data.endPressureMPa >= hoseParams.minInletPressureMPa ? 'panel-stat-value highlight' : 'panel-stat-value warning'; document.getElementById('hoseInfoRelay').textContent = `${data.totalPumps}Âè∞`; if (data.pumpSegments) { const tbody = document.getElementById('segmentTableBody'); let html = ''; for (const seg of data.pumpSegments) { const colorClass = seg.remainingPressure >= 0.4 ? 'green' : seg.remainingPressure >= 0.2 ? 'yellow' : 'red'; const elevClass = seg.elevation >= 0 ? 'elev-up' : 'elev-down'; const elevStr = seg.elevation >= 0 ? `+${seg.elevation.toFixed(0)}` : `${seg.elevation.toFixed(0)}`; html += `<tr class="${colorClass}"><td>P${seg.pumpNum}‚Üí${seg.nextLabel}</td><td>${seg.distance.toFixed(0)}m</td><td>${seg.hoses}Êú¨</td><td class="${elevClass}">${elevStr}m</td><td>${seg.loss.toFixed(2)}</td><td>${seg.remainingPressure.toFixed(2)}</td></tr>`; } tbody.innerHTML = html; } }
        function runSimulationForLine(lineId, pathLLH) { hoseParams.pumpOutputMPa = parseFloat(document.getElementById('paramPumpOut').value) || 0.6; hoseParams.minInletPressureMPa = parseFloat(document.getElementById('paramInlet').value) || 0.2; hoseParams.nozzleRequiredMPa = parseFloat(document.getElementById('paramNozzle').value) || 0.4; hoseParams.lossPerHoseMPa = parseFloat(document.getElementById('paramLossPerHose').value) || 0.02; const { relays, interpolated } = computeRelayPositionsInterpolated(pathLLH, hoseParams); const pumpSegments = computePumpSegmentsFromRelays(interpolated, relays, hoseParams); renderStartEndMarkers(lineId, pathLLH); renderRelayMarkersFromPositions(lineId, relays); renderColorizedByPumpSegments(lineId, interpolated, relays, pumpSegments); const endP = pumpSegments.length > 0 ? pumpSegments[pumpSegments.length - 1].remainingPressure : hoseParams.pumpOutputMPa; const totalLength = pumpSegments.reduce((s, p) => s + p.distance, 0); const totalHoses = pumpSegments.reduce((s, p) => s + p.hoses, 0); updateHoseInfoPanel({ totalLengthM: totalLength, totalHoses20m: totalHoses, endPressureMPa: endP, totalPumps: 1 + relays.length, pumpSegments: pumpSegments }); }
        function onParamChange() { if (selectedHoseLine && selectedHoseLine.pathLLH) runSimulationForLine(selectedHoseLine.id, selectedHoseLine.pathLLH); }
        function confirmHoseLine() { if (hoseLinePoints.length < 2) { showToast('2ÁÇπ‰ª•‰∏äÂøÖË¶Å'); return; } const pathLLH = hoseLinePoints.map(p => ({ lon: p.lon, lat: p.lat, height: p.height })); const id = `hose-${++hoseLineIdCounter}`; let totalDist = 0; for (let i = 1; i < hoseLinePoints.length; i++) totalDist += geodesicDistance(hoseLinePoints[i-1].lon, hoseLinePoints[i-1].lat, hoseLinePoints[i].lon, hoseLinePoints[i].lat); const lineEntity = viewer.entities.add({ id: id, polyline: { positions: hoseLinePoints.map(p => p.cartesian), width: 4, material: Cesium.Color.ORANGE.withAlpha(0.5), clampToGround: true } }); const hoseData = { id, entity: lineEntity, totalDist, pathLLH }; hoseLineEntities.push(hoseData); hoseLineMarkers.forEach(e => viewer.entities.remove(e)); hoseLineSegments.forEach(e => viewer.entities.remove(e)); hoseLinePoints = []; hoseLineMarkers = []; hoseLineSegments = []; updateHoseDisplay(); clearTool(); selectedHoseLine = hoseData; runSimulationForLine(id, pathLLH); closeAllPanels(); document.getElementById('hoseInfoPanel').classList.add('active'); showToast('„Éõ„Éº„ÇπÁµåË∑Ø„ÇíÁ¢∫ÂÆö„Åó„Åæ„Åó„Åü'); }
        function selectHoseLine(id) { const h = hoseLineEntities.find(x => x.id === id); if (!h) return; selectedHoseLine = h; closeAllPanels(); if (h.pathLLH) runSimulationForLine(id, h.pathLLH); document.getElementById('hoseInfoPanel').classList.add('active'); }
        function deleteSelectedHose() { if (!selectedHoseLine) { showToast('„Éõ„Éº„Çπ„É©„Ç§„É≥„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì'); return; } const id = selectedHoseLine.id; const hd = hoseLineEntities.find(h => h.id === id); if (hd && hd.entity) viewer.entities.remove(hd.entity); hoseLineEntities = hoseLineEntities.filter(h => h.id !== id); (hoseSimState.relayCandidateEntitiesByLine.get(id) || []).forEach(e => viewer.entities.remove(e)); hoseSimState.relayCandidateEntitiesByLine.delete(id); (hoseSimState.startEndMarkersByLine.get(id) || []).forEach(e => viewer.entities.remove(e)); hoseSimState.startEndMarkersByLine.delete(id); (hoseSimState.colorSegmentsByLine?.get(id) || []).forEach(e => viewer.entities.remove(e)); hoseSimState.colorSegmentsByLine?.delete(id); selectedHoseLine = null; closePanel('hoseInfo'); showToast('„Éõ„Éº„Çπ„É©„Ç§„É≥„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü'); }
        function closeHosePanel() { document.getElementById('hosePanel').classList.remove('active'); resetHoseLine(); clearTool(); }

        let measurePoints = [], measureMarkers = [], measureLine = null;
        function addMeasurePoint(lon, lat, height, cartesian) { measurePoints.push({ lon, lat, height, cartesian }); const m = viewer.entities.add({ position: cartesian, point: { pixelSize: 10, color: Cesium.Color.CYAN, outlineColor: Cesium.Color.WHITE, outlineWidth: 2, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND } }); measureMarkers.push(m); if (measurePoints.length === 2) { if (measureLine) viewer.entities.remove(measureLine); measureLine = viewer.entities.add({ polyline: { positions: [measurePoints[0].cartesian, measurePoints[1].cartesian], width: 3, material: Cesium.Color.CYAN, clampToGround: true } }); const p1 = measurePoints[0], p2 = measurePoints[1]; const groundDist = geodesicDistance(p1.lon, p1.lat, p2.lon, p2.lat); const elevDiff = p2.height - p1.height; const straightDist = Math.sqrt(groundDist * groundDist + elevDiff * elevDiff); document.getElementById('measureDistance').textContent = formatDistance(groundDist); document.getElementById('measureStraight').textContent = formatDistance(straightDist); document.getElementById('measureElev').textContent = (elevDiff >= 0 ? '+' : '') + elevDiff.toFixed(1) + 'm'; document.getElementById('measureHint').textContent = 'Ë®àÊ∏¨ÂÆå‰∫Ü'; } else { document.getElementById('measureHint').textContent = `${measurePoints.length}ÁÇπÁõÆ`; } }
        function resetMeasure() { measurePoints = []; measureMarkers.forEach(e => viewer.entities.remove(e)); measureMarkers = []; if (measureLine) { viewer.entities.remove(measureLine); measureLine = null; } document.getElementById('measureDistance').textContent = '-'; document.getElementById('measureStraight').textContent = '-'; document.getElementById('measureElev').textContent = '-'; document.getElementById('measureHint').textContent = '2ÁÇπ„Çí„Çø„ÉÉ„Éó'; }
        function closeMeasurePanel() { document.getElementById('measurePanel').classList.remove('active'); resetMeasure(); clearTool(); }

        function closeAllPanels() { ['firePanel', 'waterPanel', 'hoseInfoPanel', 'hosePanel', 'measurePanel'].forEach(id => document.getElementById(id).classList.remove('active')); selectedFirePoint = null; selectedWater = null; }
        function closePanel(type) { document.getElementById(type + 'Panel').classList.remove('active'); if (type === 'fire') selectedFirePoint = null; if (type === 'water') selectedWater = null; if (type === 'hoseInfo') selectedHoseLine = null; }

        const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        handler.setInputAction(async function(click) { const picked = viewer.scene.pick(click.position); if (picked && picked.id) { const entity = picked.id; const pickedId = typeof entity.id === 'string' ? entity.id : (entity._id || ''); if (pickedId.startsWith('fire-')) { selectFirePoint(pickedId); return; } if (pickedId.startsWith('water-')) { selectWater(pickedId); return; } if (pickedId.startsWith('hose-')) { selectHoseLine(pickedId); return; } } const ray = viewer.camera.getPickRay(click.position); const cartesian = viewer.scene.globe.pick(ray, viewer.scene); if (!cartesian) return; const carto = Cesium.Cartographic.fromCartesian(cartesian); const lon = Cesium.Math.toDegrees(carto.longitude), lat = Cesium.Math.toDegrees(carto.latitude); let height = 0; try { const u = await Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, [Cesium.Cartographic.fromDegrees(lon, lat)]); height = u[0].height || 0; } catch(e) { height = carto.height || 0; } if (currentTool === 'fire') { const id = addFirePoint(lon, lat, height); selectFirePoint(id); } else if (currentTool === 'water') { const id = addWaterSource('hydrant', `Ê∂àÁÅ´Ê†ì#${waterIdCounter + 1}`, lon, lat); selectWater(id); } else if (currentTool === 'hose') { addHosePoint(lon, lat, height, cartesian); } else if (currentTool === 'measure') { if (measurePoints.length >= 2) resetMeasure(); addMeasurePoint(lon, lat, height, cartesian); } }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        function geodesicDistance(lon1, lat1, lon2, lat2) { return new Cesium.EllipsoidGeodesic(Cesium.Cartographic.fromDegrees(lon1, lat1), Cesium.Cartographic.fromDegrees(lon2, lat2)).surfaceDistance; }
        function formatDistance(m) { return m >= 1000 ? (m/1000).toFixed(2) + 'km' : m.toFixed(0) + 'm'; }
        function showLoading(show) { document.getElementById('loading').classList.toggle('show', show); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.remove('show'); void t.offsetWidth; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }
        function setViewMode(mode) { document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active')); event.target.closest('.view-btn').classList.add('active'); viewer.scene.mode = mode === '2d' ? Cesium.SceneMode.SCENE2D : Cesium.SceneMode.SCENE3D; }
    </script>
</body>
</html>
