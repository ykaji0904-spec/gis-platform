<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIS Platform - HardSkill OS</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans JP', sans-serif; overflow: hidden; background: #0a0a0a; }
        #cesiumContainer { width: 100vw; height: 100vh; }

        /* Top Bar */
        .top-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 52px;
            background: rgba(10, 10, 10, 0.92); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 12px; z-index: 1000;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon {
            width: 28px; height: 28px;
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
        }
        .logo-icon .material-icons { color: white; font-size: 18px; }
        .logo-text { color: white; font-weight: 700; font-size: 16px; }

        .top-controls { display: flex; gap: 6px; align-items: center; }
        
        .quick-toggle {
            display: flex; align-items: center; gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 6px 10px; border-radius: 16px;
            cursor: pointer; transition: all 0.2s;
            color: rgba(255, 255, 255, 0.5); font-size: 11px;
        }
        .quick-toggle:hover { background: rgba(255, 255, 255, 0.1); }
        .quick-toggle.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff; color: #00d4ff;
        }
        .quick-toggle .material-icons { font-size: 14px; }

        .user-section { display: flex; align-items: center; gap: 10px; }
        .status-indicator { display: flex; align-items: center; gap: 4px; color: #4ade80; font-size: 10px; }
        .status-dot { width: 6px; height: 6px; background: #4ade80; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .avatar {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, #ff6b6b, #ffa06b);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 600; font-size: 12px; cursor: pointer;
        }

        /* Unified Bottom Toolbar */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 12px; z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
        }

        .my-location {
            display: flex; align-items: center; gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px; border-radius: 8px;
            min-width: 180px;
        }
        .my-location .material-icons { color: #4ade80; font-size: 18px; }
        .my-location-text { display: flex; flex-direction: column; }
        .my-location-label { color: rgba(255,255,255,0.5); font-size: 9px; }
        .my-location-coords { color: white; font-size: 11px; font-family: monospace; }

        .tools-group {
            display: flex; gap: 4px; align-items: center;
        }
        .tool-btn {
            width: 40px; height: 40px;
            background: rgba(255, 255, 255, 0.05); border: none; border-radius: 8px;
            color: rgba(255, 255, 255, 0.6); cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .tool-btn:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .tool-btn.active { background: rgba(0, 212, 255, 0.2); color: #00d4ff; }
        .tool-btn .material-icons { font-size: 18px; }
        .tool-divider { width: 1px; height: 24px; background: rgba(255, 255, 255, 0.1); margin: 0 4px; }

        .view-toggle {
            display: flex; background: rgba(255, 255, 255, 0.05); border-radius: 6px; overflow: hidden;
        }
        .view-btn {
            padding: 8px 12px; border: none;
            background: transparent; color: rgba(255,255,255,0.5);
            cursor: pointer; transition: all 0.2s; font-size: 11px;
            display: flex; align-items: center; gap: 4px;
        }
        .view-btn:hover { background: rgba(255,255,255,0.05); }
        .view-btn.active { background: rgba(0, 212, 255, 0.2); color: #00d4ff; }
        .view-btn .material-icons { font-size: 14px; }

        /* Measurement Panel */
        .measure-panel {
            position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%);
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px);
            padding: 14px 20px; border-radius: 12px;
            border: 1px solid rgba(0, 212, 255, 0.3); z-index: 900;
            min-width: 260px; display: none;
        }
        .measure-panel.active { display: block; }
        .measure-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .measure-title { color: #00d4ff; font-size: 11px; font-weight: 600; }
        .measure-close { background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 16px; }
        .measure-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
        .measure-label { color: rgba(255, 255, 255, 0.5); font-size: 11px; }
        .measure-value { color: white; font-size: 13px; font-weight: 600; font-family: monospace; }
        .measure-value.highlight { color: #00d4ff; font-size: 16px; }
        .measure-hint { color: rgba(255,255,255,0.4); font-size: 10px; text-align: center; margin-top: 10px; }
        .measure-actions { display: flex; gap: 6px; margin-top: 10px; }
        .measure-btn { flex: 1; padding: 6px; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; }
        .measure-btn.primary { background: #00d4ff; color: #000; }
        .measure-btn.secondary { background: rgba(255,255,255,0.1); color: white; }

        /* Right Panel - Team */
        .right-panel {
            position: fixed; top: 64px; right: 12px; width: 200px;
            background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(20px);
            border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 900; display: none;
        }
        .right-panel.show { display: block; }
        .panel-header {
            padding: 10px 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; justify-content: space-between;
        }
        .panel-title { color: white; font-weight: 600; font-size: 12px; }
        .panel-close { background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; }
        .panel-content { padding: 6px; max-height: 250px; overflow-y: auto; }

        .team-member {
            display: flex; align-items: center; gap: 8px;
            padding: 8px; cursor: pointer; transition: all 0.2s;
            border-radius: 6px;
        }
        .team-member:hover { background: rgba(255, 255, 255, 0.05); }
        .member-avatar {
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 600; font-size: 10px; position: relative;
        }
        .member-avatar::after {
            content: ''; position: absolute; bottom: -1px; right: -1px;
            width: 8px; height: 8px; background: #4ade80;
            border: 2px solid #0a0a0a; border-radius: 50%;
        }
        .member-info { flex: 1; }
        .member-name { color: white; font-size: 11px; font-weight: 500; }
        .member-role { color: rgba(255, 255, 255, 0.4); font-size: 9px; }

        /* Alert Banner */
        .alert-banner {
            position: fixed; top: 64px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: rgba(239, 68, 68, 0.9); backdrop-filter: blur(10px);
            padding: 10px 20px; border-radius: 10px;
            display: flex; align-items: center; gap: 10px;
            z-index: 1100; opacity: 0; transition: all 0.3s ease;
        }
        .alert-banner.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .alert-banner .material-icons { color: white; font-size: 18px; }
        .alert-banner span { color: white; font-size: 12px; font-weight: 500; }

        /* Upload Zone */
        .upload-zone {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .upload-zone.active { opacity: 1; pointer-events: all; }
        .upload-box {
            width: 350px; background: rgba(20, 20, 20, 0.95);
            border-radius: 14px; border: 2px dashed rgba(0, 212, 255, 0.5);
            padding: 32px; text-align: center;
        }
        .upload-box .material-icons { font-size: 40px; color: #00d4ff; margin-bottom: 10px; }
        .upload-box h3 { color: white; font-size: 14px; margin-bottom: 6px; }
        .upload-box p { color: rgba(255, 255, 255, 0.5); font-size: 11px; margin-bottom: 12px; }
        .upload-formats { display: flex; gap: 6px; justify-content: center; flex-wrap: wrap; }
        .format-tag { background: rgba(255, 255, 255, 0.1); padding: 3px 8px; border-radius: 4px; color: rgba(255, 255, 255, 0.7); font-size: 10px; }

        /* Hide Cesium default UI */
        .cesium-viewer-toolbar, .cesium-viewer-animationContainer,
        .cesium-viewer-timelineContainer, .cesium-viewer-fullscreenContainer,
        .cesium-viewer-bottom { display: none !important; }

        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 2px; }

        @media (max-width: 600px) {
            .logo-text { display: none; }
            .quick-toggle span:not(.material-icons) { display: none; }
            .quick-toggle { padding: 6px; }
            .my-location { min-width: auto; padding: 6px 8px; }
            .my-location-label { display: none; }
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="logo">
            <div class="logo-icon"><span class="material-icons">public</span></div>
            <span class="logo-text">GIS Platform</span>
        </div>

        <div class="top-controls">
            <div class="quick-toggle active" onclick="toggleQuickLayer(this, 'buildings')" title="3D建物">
                <span class="material-icons">location_city</span>
                <span>建物</span>
            </div>
            <div class="quick-toggle active" onclick="toggleQuickLayer(this, 'satellite')" title="衛星画像">
                <span class="material-icons">satellite_alt</span>
                <span>衛星</span>
            </div>
            <div class="quick-toggle" onclick="toggleQuickLayer(this, 'trail')" title="登山道・地図">
                <span class="material-icons">hiking</span>
                <span>登山道</span>
            </div>
            <div class="quick-toggle active" onclick="toggleQuickLayer(this, 'terrain')" title="3D地形">
                <span class="material-icons">terrain</span>
                <span>地形</span>
            </div>
        </div>

        <div class="user-section">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>接続中</span>
            </div>
            <div class="avatar">K</div>
        </div>
    </div>

    <!-- Right Panel - Team -->
    <div class="right-panel" id="teamPanel">
        <div class="panel-header">
            <span class="panel-title">チーム</span>
            <button class="panel-close" onclick="togglePanel()"><span class="material-icons">close</span></button>
        </div>
        <div class="panel-content" id="teamList"></div>
    </div>

    <!-- Unified Bottom Bar -->
    <div class="bottom-bar">
        <div class="my-location" onclick="flyToMyLocation()">
            <span class="material-icons">my_location</span>
            <div class="my-location-text">
                <span class="my-location-label">現在地</span>
                <span class="my-location-coords" id="myCoords">取得中...</span>
            </div>
        </div>

        <div class="tools-group">
            <button class="tool-btn" title="距離計測" onclick="setTool('distance')">
                <span class="material-icons">straighten</span>
            </button>
            <button class="tool-btn" title="高度計測" onclick="setTool('elevation')">
                <span class="material-icons">height</span>
            </button>
            <button class="tool-btn" title="ピン" onclick="setTool('pin')">
                <span class="material-icons">push_pin</span>
            </button>
            <div class="tool-divider"></div>
            <button class="tool-btn" title="チーム" onclick="togglePanel()">
                <span class="material-icons">groups</span>
            </button>
            <button class="tool-btn" title="アップロード" onclick="showUpload()">
                <span class="material-icons">add</span>
            </button>
            <button class="tool-btn" title="共有" onclick="shareView()">
                <span class="material-icons">share</span>
            </button>
        </div>

        <div class="view-toggle">
            <button class="view-btn" onclick="setViewMode('2d')">
                <span class="material-icons">map</span> 2D
            </button>
            <button class="view-btn active" onclick="setViewMode('3d')">
                <span class="material-icons">view_in_ar</span> 3D
            </button>
        </div>
    </div>

    <!-- Measurement Panel -->
    <div class="measure-panel" id="measurePanel">
        <div class="measure-header">
            <span class="measure-title" id="measureTitle">距離計測</span>
            <button class="measure-close" onclick="closeMeasure()">×</button>
        </div>
        <div class="measure-row">
            <span class="measure-label">水平距離</span>
            <span class="measure-value highlight" id="measureDistance">- m</span>
        </div>
        <div class="measure-row">
            <span class="measure-label">高度差</span>
            <span class="measure-value" id="measureElevation">- m</span>
        </div>
        <div class="measure-row">
            <span class="measure-label">始点標高</span>
            <span class="measure-value" id="measureStart">- m</span>
        </div>
        <div class="measure-row">
            <span class="measure-label">終点標高</span>
            <span class="measure-value" id="measureEnd">- m</span>
        </div>
        <div class="measure-hint" id="measureHint">地図上の2点をタップ</div>
        <div class="measure-actions">
            <button class="measure-btn secondary" onclick="resetMeasure()">リセット</button>
            <button class="measure-btn primary" onclick="closeMeasure()">完了</button>
        </div>
    </div>

    <!-- Alert Banner -->
    <div class="alert-banner" id="alertBanner">
        <span class="material-icons">warning</span>
        <span>田中さんがエリア外に移動</span>
    </div>

    <!-- Upload Zone -->
    <div class="upload-zone" id="uploadZone">
        <div class="upload-box">
            <span class="material-icons">cloud_upload</span>
            <h3>ファイルをドロップ</h3>
            <p>またはタップして選択</p>
            <div class="upload-formats">
                <span class="format-tag">GeoTIFF</span>
                <span class="format-tag">KML</span>
                <span class="format-tag">GeoJSON</span>
                <span class="format-tag">GPX</span>
            </div>
        </div>
    </div>

    <script>
        // Cesium Ion Token
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIwM2NhOTIxMi03NzRmLTQzMDgtYTMzZS1kOWEyMjBmNjhhMmEiLCJpZCI6Mzg1NDQ0LCJpYXQiOjE3Njk4Mzg4NTl9.ElD_8Qq0Mp1QuoaQvnODwTCVtEfaQtuDrsS9tnwlryA';

        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrain: Cesium.Terrain.fromWorldTerrain(),
            timeline: false, animation: false, baseLayerPicker: false,
            geocoder: false, homeButton: false, sceneModePicker: false,
            navigationHelpButton: false, fullscreenButton: false,
            infoBox: false, selectionIndicator: false
        });

        // Initial view - Hiroshima
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(132.4553, 34.3853, 15000),
            orientation: { heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0 },
            duration: 0
        });

        // ===== LAYERS =====
        let plateauTileset = null;
        let gsiLayer = null;

        // Load PLATEAU buildings
        async function loadPlateauBuildings() {
            try {
                plateauTileset = await Cesium.Cesium3DTileset.fromIonAssetId(2602291);
                viewer.scene.primitives.add(plateauTileset);
            } catch (e) { console.error('PLATEAU load error:', e); }
        }
        loadPlateauBuildings();

        // GSI (国土地理院) Trail Map Layer
        function addGsiLayer() {
            gsiLayer = viewer.imageryLayers.addImageryProvider(
                new Cesium.UrlTemplateImageryProvider({
                    url: 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
                    maximumLevel: 18,
                    credit: '国土地理院'
                })
            );
            gsiLayer.alpha = 0.7;
            gsiLayer.show = false;
        }
        addGsiLayer();

        function toggleQuickLayer(el, layer) {
            el.classList.toggle('active');
            const on = el.classList.contains('active');
            
            switch(layer) {
                case 'buildings':
                    if (plateauTileset) plateauTileset.show = on;
                    break;
                case 'satellite':
                    viewer.imageryLayers.get(0).show = on;
                    break;
                case 'trail':
                    if (gsiLayer) gsiLayer.show = on;
                    break;
                case 'terrain':
                    viewer.scene.terrainProvider = on 
                        ? Cesium.Terrain.fromWorldTerrain()
                        : new Cesium.EllipsoidTerrainProvider();
                    break;
            }
        }

        // ===== VIEW MODE =====
        function setViewMode(mode) {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            event.target.closest('.view-btn').classList.add('active');
            viewer.scene.mode = mode === '2d' ? Cesium.SceneMode.SCENE2D : Cesium.SceneMode.SCENE3D;
        }

        // ===== TEAM =====
        const teamMembers = [
            { id: 1, name: '梶（自分）', role: '隊長', lat: 34.3853, lon: 132.4553, color: '#ff6b6b', self: true },
            { id: 2, name: '田中', role: '機関員', lat: 34.3863, lon: 132.4543, color: '#4ecdc4' },
            { id: 3, name: '山本', role: '隊員', lat: 34.3843, lon: 132.4563, color: '#45b7d1' },
            { id: 4, name: '鈴木', role: '隊員', lat: 34.3873, lon: 132.4533, color: '#96ceb4' }
        ];

        function addTeamMarkers() {
            teamMembers.forEach(m => {
                viewer.entities.add({
                    id: `member-${m.id}`,
                    position: Cesium.Cartesian3.fromDegrees(m.lon, m.lat, 0),
                    point: {
                        pixelSize: m.self ? 12 : 8,
                        color: Cesium.Color.fromCssColorString(m.color),
                        outlineColor: Cesium.Color.WHITE, outlineWidth: 2,
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                    },
                    label: {
                        text: m.name, font: '10px sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK, outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -16),
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                    }
                });
            });
        }
        addTeamMarkers();

        function renderTeamList() {
            document.getElementById('teamList').innerHTML = teamMembers.map(m => `
                <div class="team-member" onclick="flyToMember(${m.id - 1})">
                    <div class="member-avatar" style="background:${m.color}">${m.name[0]}</div>
                    <div class="member-info">
                        <div class="member-name">${m.name}</div>
                        <div class="member-role">${m.role}</div>
                    </div>
                </div>
            `).join('');
        }
        renderTeamList();

        function flyToMember(i) {
            const m = teamMembers[i];
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(m.lon, m.lat, 500),
                orientation: { heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0 },
                duration: 1.5
            });
        }

        function togglePanel() {
            document.getElementById('teamPanel').classList.toggle('show');
        }

        // ===== MY LOCATION =====
        let myLat = null, myLon = null;

        function updateMyLocationDisplay() {
            const el = document.getElementById('myCoords');
            if (myLat && myLon) {
                el.textContent = `${myLat.toFixed(4)}°N ${myLon.toFixed(4)}°E`;
            }
        }

        function flyToMyLocation() {
            if (myLat && myLon) {
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(myLon, myLat, 1000),
                    orientation: { heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0 },
                    duration: 2
                });
            } else {
                document.getElementById('myCoords').textContent = '取得中...';
            }
        }

        // Watch position
        if ('geolocation' in navigator) {
            navigator.geolocation.watchPosition(
                pos => {
                    myLat = pos.coords.latitude;
                    myLon = pos.coords.longitude;
                    updateMyLocationDisplay();
                    
                    // Update self marker
                    teamMembers[0].lat = myLat;
                    teamMembers[0].lon = myLon;
                    const e = viewer.entities.getById('member-1');
                    if (e) e.position = Cesium.Cartesian3.fromDegrees(myLon, myLat, 0);
                },
                () => { document.getElementById('myCoords').textContent = '取得失敗'; },
                { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
            );
        }

        // ===== MEASUREMENT =====
        let currentTool = null;
        let measurePoints = [];
        let measureEntities = [];

        function setTool(tool) {
            resetMeasure();
            document.querySelectorAll('.tools-group .tool-btn').forEach(b => b.classList.remove('active'));
            event.target.closest('.tool-btn').classList.add('active');
            currentTool = tool;
            
            if (['distance', 'elevation'].includes(tool)) {
                document.getElementById('measurePanel').classList.add('active');
                document.getElementById('measureTitle').textContent = tool === 'distance' ? '距離計測' : '高度計測';
            }
        }

        function closeMeasure() {
            document.getElementById('measurePanel').classList.remove('active');
            document.querySelectorAll('.tools-group .tool-btn').forEach(b => b.classList.remove('active'));
            resetMeasure();
            currentTool = null;
        }

        function resetMeasure() {
            measurePoints = [];
            measureEntities.forEach(e => viewer.entities.remove(e));
            measureEntities = [];
            document.getElementById('measureDistance').textContent = '- m';
            document.getElementById('measureElevation').textContent = '- m';
            document.getElementById('measureStart').textContent = '- m';
            document.getElementById('measureEnd').textContent = '- m';
            document.getElementById('measureHint').style.display = 'block';
        }

        const clickHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        clickHandler.setInputAction(async function(click) {
            if (!currentTool) return;

            const ray = viewer.camera.getPickRay(click.position);
            const cartesian = viewer.scene.globe.pick(ray, viewer.scene);
            if (!cartesian) return;

            const carto = Cesium.Cartographic.fromCartesian(cartesian);
            const lon = Cesium.Math.toDegrees(carto.longitude);
            const lat = Cesium.Math.toDegrees(carto.latitude);
            
            let height = 0;
            try {
                const updated = await Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, [Cesium.Cartographic.fromDegrees(lon, lat)]);
                height = updated[0].height || 0;
            } catch (e) { height = carto.height || 0; }

            if (currentTool === 'pin') {
                viewer.entities.add({
                    position: cartesian,
                    billboard: {
                        image: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="36"><path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 24 12 24s12-15 12-24c0-6.6-5.4-12-12-12z" fill="#ff6b6b"/><circle cx="12" cy="12" r="5" fill="white"/></svg>'),
                        width: 24, height: 36,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                    }
                });
                return;
            }

            if (!['distance', 'elevation'].includes(currentTool)) return;

            measurePoints.push({ lon, lat, height, cartesian });

            const marker = viewer.entities.add({
                position: cartesian,
                point: { pixelSize: 8, color: Cesium.Color.YELLOW, outlineColor: Cesium.Color.BLACK, outlineWidth: 2, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND },
                label: { text: `P${measurePoints.length}`, font: '11px sans-serif', fillColor: Cesium.Color.WHITE, outlineColor: Cesium.Color.BLACK, outlineWidth: 2, style: Cesium.LabelStyle.FILL_AND_OUTLINE, verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0, -12) }
            });
            measureEntities.push(marker);

            if (measurePoints.length >= 2) {
                const p1 = measurePoints[measurePoints.length - 2];
                const p2 = measurePoints[measurePoints.length - 1];
                
                const line = viewer.entities.add({
                    polyline: { positions: [p1.cartesian, p2.cartesian], width: 3, material: new Cesium.PolylineGlowMaterialProperty({ glowPower: 0.2, color: Cesium.Color.CYAN }), clampToGround: true }
                });
                measureEntities.push(line);

                // Haversine
                const R = 6371000;
                const dLat = (p2.lat - p1.lat) * Math.PI / 180;
                const dLon = (p2.lon - p1.lon) * Math.PI / 180;
                const a = Math.sin(dLat/2)**2 + Math.cos(p1.lat*Math.PI/180) * Math.cos(p2.lat*Math.PI/180) * Math.sin(dLon/2)**2;
                const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                const elev = p2.height - p1.height;

                document.getElementById('measureDistance').textContent = dist >= 1000 ? (dist/1000).toFixed(2) + ' km' : dist.toFixed(1) + ' m';
                document.getElementById('measureElevation').textContent = (elev >= 0 ? '+' : '') + elev.toFixed(1) + ' m';
                document.getElementById('measureStart').textContent = p1.height.toFixed(1) + ' m';
                document.getElementById('measureEnd').textContent = p2.height.toFixed(1) + ' m';
                document.getElementById('measureHint').style.display = 'none';
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        // ===== UTILITIES =====
        function showUpload() { document.getElementById('uploadZone').classList.add('active'); }
        document.getElementById('uploadZone').addEventListener('click', e => {
            if (e.target.id === 'uploadZone') document.getElementById('uploadZone').classList.remove('active');
        });

        function shareView() {
            const p = viewer.camera.positionCartographic;
            const url = `${location.origin}${location.pathname}?lat=${Cesium.Math.toDegrees(p.latitude).toFixed(6)}&lon=${Cesium.Math.toDegrees(p.longitude).toFixed(6)}&h=${p.height.toFixed(0)}`;
            navigator.clipboard.writeText(url).then(() => alert('リンクをコピーしました'));
        }

        // Simulate team updates
        setInterval(() => {
            teamMembers.forEach((m, i) => {
                if (!m.self) {
                    m.lon += (Math.random() - 0.5) * 0.0001;
                    m.lat += (Math.random() - 0.5) * 0.0001;
                    const e = viewer.entities.getById(`member-${m.id}`);
                    if (e) e.position = Cesium.Cartesian3.fromDegrees(m.lon, m.lat, 0);
                }
            });
        }, 3000);

        // Demo alert
        setTimeout(() => {
            document.getElementById('alertBanner').classList.add('show');
            setTimeout(() => document.getElementById('alertBanner').classList.remove('show'), 4000);
        }, 8000);

        // URL params
        const params = new URLSearchParams(location.search);
        if (params.has('lat') && params.has('lon')) {
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(parseFloat(params.get('lon')), parseFloat(params.get('lat')), parseFloat(params.get('h')) || 3000),
                duration: 2
            });
        }
    </script>
</body>
</html>
