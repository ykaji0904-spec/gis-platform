<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GIS Platform - HardSkill OS</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans JP', sans-serif; overflow: hidden; background: #0a0a0a; }
        #cesiumContainer { width: 100vw; height: 100vh; }

        .top-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 48px;
            background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; z-index: 1000;
        }
        .logo { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .logo-icon {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
        }
        .logo-icon:active { transform: scale(0.95); }
        .logo-icon .material-icons { color: white; font-size: 18px; }

        .top-controls { display: flex; gap: 4px; }
        .quick-toggle {
            display: flex; align-items: center; gap: 3px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: 5px 8px; border-radius: 14px;
            cursor: pointer; color: rgba(255, 255, 255, 0.5); font-size: 10px;
        }
        .quick-toggle.active { background: rgba(0, 212, 255, 0.15); border-color: #00d4ff; color: #00d4ff; }
        .quick-toggle .material-icons { font-size: 13px; }

        .user-section { display: flex; align-items: center; gap: 8px; }
        .status-indicator { display: flex; align-items: center; gap: 3px; color: #4ade80; font-size: 9px; }
        .status-dot { width: 5px; height: 5px; background: #4ade80; border-radius: 50%; }
        .avatar {
            width: 28px; height: 28px;
            background: linear-gradient(135deg, #ff6b6b, #ffa06b);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 600; font-size: 11px;
        }

        /* Tool Menu */
        .tool-menu {
            position: fixed; top: 56px; left: 8px; width: 260px;
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px);
            border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 950; display: none; max-height: calc(100vh - 120px); overflow-y: auto;
        }
        .tool-menu.show { display: block; }
        .tool-menu-header {
            padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex; align-items: center; justify-content: space-between;
        }
        .tool-menu-title { color: white; font-size: 12px; font-weight: 600; }
        .tool-menu-close { background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; padding: 4px; }
        .tool-section { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .tool-section:last-child { border-bottom: none; }
        .tool-section-title { color: rgba(255,255,255,0.35); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        
        .tool-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px; border-radius: 6px; margin-bottom: 4px;
            cursor: pointer; background: rgba(255,255,255,0.02);
        }
        .tool-item:hover { background: rgba(255,255,255,0.05); }
        .tool-item.active { background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.2); }
        .tool-item-icon {
            width: 32px; height: 32px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .tool-item-icon.fire { background: rgba(244, 67, 54, 0.15); color: #f44336; }
        .tool-item-icon.water { background: rgba(33, 150, 243, 0.15); color: #2196f3; }
        .tool-item-icon.hose { background: rgba(255, 152, 0, 0.15); color: #ff9800; }
        .tool-item-icon.measure { background: rgba(0, 212, 255, 0.15); color: #00d4ff; }
        .tool-item-icon.layer { background: rgba(139, 195, 74, 0.15); color: #8bc34a; }
        .tool-item-icon.share { background: rgba(156, 39, 176, 0.15); color: #9c27b0; }
        .tool-item-icon .material-icons { font-size: 16px; }
        .tool-item-content { flex: 1; min-width: 0; }
        .tool-item-name { color: white; font-size: 11px; font-weight: 500; }
        .tool-item-desc { color: rgba(255,255,255,0.4); font-size: 9px; margin-top: 2px; }

        /* Layer Panel */
        .layer-panel {
            position: fixed; top: 56px; left: 8px; width: 220px;
            background: rgba(10, 10, 10, 0.92); backdrop-filter: blur(20px);
            border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 900; display: none;
        }
        .layer-panel.show { display: block; }
        .panel-section { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .panel-section:last-child { border-bottom: none; }
        .section-title { color: rgba(255,255,255,0.35); font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        
        .layer-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 6px; border-radius: 4px; margin-bottom: 2px; cursor: pointer;
        }
        .layer-item:hover { background: rgba(255,255,255,0.04); }
        .layer-info { display: flex; align-items: center; gap: 6px; }
        .layer-icon { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .layer-icon.terrain { background: rgba(76, 175, 80, 0.15); color: #4caf50; }
        .layer-icon.building { background: rgba(33, 150, 243, 0.15); color: #2196f3; }
        .layer-icon.map { background: rgba(255, 193, 7, 0.15); color: #ffc107; }
        .layer-icon.fire { background: rgba(244, 67, 54, 0.15); color: #f44336; }
        .layer-icon.water { background: rgba(33, 150, 243, 0.15); color: #2196f3; }
        .layer-icon.trail { background: rgba(139, 195, 74, 0.15); color: #8bc34a; }
        .layer-icon.hose { background: rgba(255, 152, 0, 0.15); color: #ff9800; }
        .layer-name { color: white; font-size: 10px; }
        .layer-toggle { width: 28px; height: 16px; border-radius: 8px; background: rgba(255,255,255,0.1); position: relative; cursor: pointer; }
        .layer-toggle.on { background: #00d4ff; }
        .layer-toggle::after { content: ''; position: absolute; width: 12px; height: 12px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: all 0.2s; }
        .layer-toggle.on::after { left: 14px; }

        .mode-indicator {
            position: fixed; top: 56px; left: 50%; transform: translateX(-50%);
            background: rgba(244, 67, 54, 0.9);
            padding: 6px 12px; border-radius: 16px;
            display: none; align-items: center; gap: 6px; z-index: 1000;
        }
        .mode-indicator.show { display: flex; }
        .mode-indicator.water-mode { background: rgba(33, 150, 243, 0.9); }
        .mode-indicator.hose-mode { background: rgba(255, 152, 0, 0.9); }
        .mode-indicator.measure-mode { background: rgba(0, 212, 255, 0.9); }
        .mode-indicator .material-icons { color: white; font-size: 14px; }
        .mode-indicator span { color: white; font-size: 11px; font-weight: 500; }

        /* Bottom Panels - All panels now at bottom */
        .bottom-panel {
            position: fixed; bottom: 56px; left: 8px; right: 8px;
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px);
            padding: 10px 12px; border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1); z-index: 900;
            display: none;
        }
        .bottom-panel.active { display: block; }
        .bottom-panel.fire { border-color: rgba(244, 67, 54, 0.25); }
        .bottom-panel.water { border-color: rgba(33, 150, 243, 0.25); }
        .bottom-panel.hose { border-color: rgba(255, 152, 0, 0.25); }
        .bottom-panel.measure { border-color: rgba(0, 212, 255, 0.25); }
        .bottom-panel.hose-info { border-color: rgba(255, 152, 0, 0.25); }

        .panel-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
        }
        .panel-title { font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 4px; }
        .panel-title.fire { color: #f44336; }
        .panel-title.water { color: #2196f3; }
        .panel-title.hose { color: #ff9800; }
        .panel-title.measure { color: #00d4ff; }
        .panel-title .material-icons { font-size: 14px; }
        .panel-close { background: none; border: none; color: rgba(255,255,255,0.4); cursor: pointer; }
        .panel-close .material-icons { font-size: 16px; }

        .panel-stats { display: flex; gap: 6px; flex-wrap: wrap; }
        .panel-stat { background: rgba(255,255,255,0.03); padding: 6px 8px; border-radius: 6px; min-width: 70px; }
        .panel-stat.wide { flex: 1; min-width: 140px; }
        .panel-stat-label { color: rgba(255,255,255,0.4); font-size: 8px; margin-bottom: 2px; }
        .panel-stat-value { color: white; font-size: 12px; font-weight: 600; font-family: monospace; }
        .panel-stat-value.highlight { color: #ff9800; }
        .panel-stat-value.fire-highlight { color: #f44336; }
        .panel-stat-value.water-highlight { color: #2196f3; }
        .panel-stat-value.measure-highlight { color: #00d4ff; }

        .panel-hint { color: rgba(255,255,255,0.35); font-size: 9px; text-align: center; margin: 8px 0; }
        .panel-actions { display: flex; gap: 6px; margin-top: 8px; }
        .panel-btn { flex: 1; padding: 8px; border: none; border-radius: 6px; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; font-weight: 500; }
        .panel-btn .material-icons { font-size: 14px; }
        .panel-btn.primary { background: #ff9800; color: #000; }
        .panel-btn.primary-blue { background: #2196f3; color: white; }
        .panel-btn.primary-cyan { background: #00d4ff; color: #000; }
        .panel-btn.secondary { background: rgba(255,255,255,0.08); color: white; }
        .panel-btn.danger { background: rgba(244,67,54,0.7); color: white; }

        .water-list { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
        .water-chip {
            display: flex; align-items: center; gap: 4px;
            padding: 4px 8px; border-radius: 12px;
            background: rgba(255,255,255,0.05); cursor: pointer; font-size: 9px;
        }
        .water-chip:hover { background: rgba(33, 150, 243, 0.15); }
        .water-chip.hydrant { border: 1px solid rgba(244, 67, 54, 0.3); }
        .water-chip.tank { border: 1px solid rgba(33, 150, 243, 0.3); }
        .water-chip.natural { border: 1px solid rgba(0, 188, 212, 0.3); }
        .water-chip-icon { font-size: 10px; font-weight: 600; }
        .water-chip-dist { color: rgba(255,255,255,0.6); }

        /* Bottom Bar */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(10, 10, 10, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            padding: 8px 10px; z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
        }
        .my-location {
            display: flex; align-items: center; gap: 6px;
            background: rgba(255, 255, 255, 0.05);
            padding: 6px 10px; border-radius: 6px; cursor: pointer;
        }
        .my-location .material-icons { color: #4ade80; font-size: 16px; }
        .my-location-coords { color: white; font-size: 10px; font-family: monospace; }

        .view-toggle { display: flex; background: rgba(255, 255, 255, 0.05); border-radius: 6px; }
        .view-btn {
            padding: 6px 12px; border: none; background: transparent; color: rgba(255,255,255,0.5);
            cursor: pointer; font-size: 10px; display: flex; align-items: center; gap: 3px;
        }
        .view-btn.active { background: rgba(0, 212, 255, 0.15); color: #00d4ff; border-radius: 6px; }
        .view-btn .material-icons { font-size: 12px; }

        .loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(10,10,10,0.9); padding: 12px 20px; border-radius: 8px;
            color: white; font-size: 11px; display: none; z-index: 2000;
        }
        .loading.show { display: block; }

        .trail-info {
            position: fixed; top: 56px; right: 8px;
            background: rgba(139, 195, 74, 0.9); padding: 6px 10px; border-radius: 12px;
            color: white; font-size: 10px; display: none; z-index: 900;
        }
        .trail-info.show { display: block; }

        .cesium-viewer-toolbar, .cesium-viewer-animationContainer, .cesium-viewer-timelineContainer, .cesium-viewer-fullscreenContainer, .cesium-viewer-bottom { display: none !important; }
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }

        @media (max-width: 400px) {
            .quick-toggle span:not(.material-icons) { display: none; }
            .tool-menu { width: 240px; }
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div class="loading" id="loading">読み込み中...</div>
    <div class="trail-info" id="trailInfo">登山道: 0本</div>

    <div class="top-bar">
        <div class="logo" onclick="toggleToolMenu()">
            <div class="logo-icon"><span class="material-icons">menu</span></div>
        </div>
        <div class="top-controls">
            <div class="quick-toggle active" onclick="toggleQuickLayer(this, 'terrain')"><span class="material-icons">terrain</span><span>地形</span></div>
            <div class="quick-toggle active" onclick="toggleQuickLayer(this, 'buildings')"><span class="material-icons">location_city</span><span>建物</span></div>
            <div class="quick-toggle" onclick="toggleQuickLayer(this, 'gsimap')"><span class="material-icons">map</span><span>地図</span></div>
            <div class="quick-toggle" onclick="toggleQuickLayer(this, 'trails')"><span class="material-icons">hiking</span><span>道</span></div>
        </div>
        <div class="user-section">
            <div class="status-indicator"><div class="status-dot"></div><span>接続中</span></div>
            <div class="avatar">K</div>
        </div>
    </div>

    <div class="mode-indicator" id="modeIndicator">
        <span class="material-icons" id="modeIcon">local_fire_department</span>
        <span id="modeText">火点追加</span>
    </div>

    <!-- Tool Menu -->
    <div class="tool-menu" id="toolMenu">
        <div class="tool-menu-header">
            <span class="tool-menu-title">ツール</span>
            <button class="tool-menu-close" onclick="toggleToolMenu()"><span class="material-icons">close</span></button>
        </div>
        <div class="tool-section">
            <div class="tool-section-title">オペレーション</div>
            <div class="tool-item" id="toolFire" onclick="setTool('fire')">
                <div class="tool-item-icon fire"><span class="material-icons">local_fire_department</span></div>
                <div class="tool-item-content">
                    <div class="tool-item-name">火点追加</div>
                    <div class="tool-item-desc">タップで追加、3点以上で範囲表示</div>
                </div>
            </div>
            <div class="tool-item" id="toolWater" onclick="setTool('water')">
                <div class="tool-item-icon water"><span class="material-icons">water_drop</span></div>
                <div class="tool-item-content">
                    <div class="tool-item-name">水利追加</div>
                    <div class="tool-item-desc">消火栓・防火水槽を追加</div>
                </div>
            </div>
        </div>
        <div class="tool-section">
            <div class="tool-section-title">計測</div>
            <div class="tool-item" id="toolHose" onclick="setTool('hose')">
                <div class="tool-item-icon hose"><span class="material-icons">route</span></div>
                <div class="tool-item-content">
                    <div class="tool-item-name">ホース延長</div>
                    <div class="tool-item-desc">連続タップで経路・本数計算</div>
                </div>
            </div>
            <div class="tool-item" id="toolMeasure" onclick="setTool('measure')">
                <div class="tool-item-icon measure"><span class="material-icons">straighten</span></div>
                <div class="tool-item-content">
                    <div class="tool-item-name">2点計測</div>
                    <div class="tool-item-desc">距離と高低差を計測</div>
                </div>
            </div>
        </div>
        <div class="tool-section">
            <div class="tool-section-title">表示</div>
            <div class="tool-item" onclick="showLayerPanel()">
                <div class="tool-item-icon layer"><span class="material-icons">layers</span></div>
                <div class="tool-item-content">
                    <div class="tool-item-name">レイヤー管理</div>
                    <div class="tool-item-desc">表示ON/OFF</div>
                </div>
            </div>
            <div class="tool-item" onclick="shareView()">
                <div class="tool-item-icon share"><span class="material-icons">share</span></div>
                <div class="tool-item-content">
                    <div class="tool-item-name">共有</div>
                    <div class="tool-item-desc">URLをコピー</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Layer Panel -->
    <div class="layer-panel" id="layerPanel">
        <div class="panel-section">
            <div class="section-title">Reference</div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'terrain')"><div class="layer-info"><div class="layer-icon terrain"><span class="material-icons">terrain</span></div><span class="layer-name">地形</span></div><div class="layer-toggle on" id="toggle-terrain"></div></div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'buildings')"><div class="layer-info"><div class="layer-icon building"><span class="material-icons">location_city</span></div><span class="layer-name">3D建物</span></div><div class="layer-toggle on" id="toggle-buildings"></div></div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'gsimap')"><div class="layer-info"><div class="layer-icon map"><span class="material-icons">map</span></div><span class="layer-name">国土地理院</span></div><div class="layer-toggle" id="toggle-gsimap"></div></div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'trails')"><div class="layer-info"><div class="layer-icon trail"><span class="material-icons">hiking</span></div><span class="layer-name">登山道(OSM)</span></div><div class="layer-toggle" id="toggle-trails"></div></div>
        </div>
        <div class="panel-section">
            <div class="section-title">Operation</div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'firepoints')"><div class="layer-info"><div class="layer-icon fire"><span class="material-icons">local_fire_department</span></div><span class="layer-name">火点</span></div><div class="layer-toggle on" id="toggle-firepoints"></div></div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'firearea')"><div class="layer-info"><div class="layer-icon fire"><span class="material-icons">pentagon</span></div><span class="layer-name">火点範囲</span></div><div class="layer-toggle on" id="toggle-firearea"></div></div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'water')"><div class="layer-info"><div class="layer-icon water"><span class="material-icons">water_drop</span></div><span class="layer-name">水利</span></div><div class="layer-toggle on" id="toggle-water"></div></div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'hose')"><div class="layer-info"><div class="layer-icon hose"><span class="material-icons">route</span></div><span class="layer-name">ホース経路</span></div><div class="layer-toggle on" id="toggle-hose"></div></div>
        </div>
    </div>

    <!-- Fire Panel (Bottom) -->
    <div class="bottom-panel fire" id="firePanel">
        <div class="panel-header">
            <span class="panel-title fire"><span class="material-icons">local_fire_department</span>火点</span>
            <button class="panel-close" onclick="closePanel('fire')"><span class="material-icons">close</span></button>
        </div>
        <div class="panel-stats">
            <div class="panel-stat"><div class="panel-stat-label">緯度</div><div class="panel-stat-value" id="fireLat">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">経度</div><div class="panel-stat-value" id="fireLon">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">標高</div><div class="panel-stat-value fire-highlight" id="fireElev">-</div></div>
        </div>
        <div class="section-title" style="margin-top:8px;">周辺水利</div>
        <div class="water-list" id="nearbyWaterList"></div>
        <div class="panel-actions">
            <button class="panel-btn secondary" onclick="flyToSelectedFire()"><span class="material-icons">flight</span>移動</button>
            <button class="panel-btn danger" onclick="deleteSelectedFire()"><span class="material-icons">delete</span>削除</button>
        </div>
    </div>

    <!-- Water Panel (Bottom) -->
    <div class="bottom-panel water" id="waterPanel">
        <div class="panel-header">
            <span class="panel-title water"><span class="material-icons">water_drop</span>水利</span>
            <button class="panel-close" onclick="closePanel('water')"><span class="material-icons">close</span></button>
        </div>
        <div class="panel-stats">
            <div class="panel-stat"><div class="panel-stat-label">種別</div><div class="panel-stat-value water-highlight" id="waterType">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">緯度</div><div class="panel-stat-value" id="waterLat">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">経度</div><div class="panel-stat-value" id="waterLon">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">火点距離</div><div class="panel-stat-value" id="waterDist">-</div></div>
        </div>
        <div class="panel-actions">
            <button class="panel-btn secondary" onclick="flyToSelectedWater()"><span class="material-icons">flight</span>移動</button>
            <button class="panel-btn danger" onclick="deleteSelectedWater()"><span class="material-icons">delete</span>削除</button>
        </div>
    </div>

    <!-- Hose Info Panel (確定済み) -->
    <div class="bottom-panel hose-info" id="hoseInfoPanel">
        <div class="panel-header">
            <span class="panel-title hose"><span class="material-icons">route</span>ホース経路</span>
            <button class="panel-close" onclick="closePanel('hoseInfo')"><span class="material-icons">close</span></button>
        </div>
        <div class="panel-stats">
            <div class="panel-stat"><div class="panel-stat-label">総延長</div><div class="panel-stat-value highlight" id="hoseInfoDist">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">本数</div><div class="panel-stat-value" id="hoseInfoCount">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">始点</div><div class="panel-stat-value" id="hoseInfoStart">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">終点</div><div class="panel-stat-value" id="hoseInfoEnd">-</div></div>
            <div class="panel-stat wide"><div class="panel-stat-label">高低差（直線/累計）</div><div class="panel-stat-value" id="hoseInfoElev">-</div></div>
        </div>
        <div class="panel-actions">
            <button class="panel-btn danger" onclick="deleteSelectedHose()"><span class="material-icons">delete</span>削除</button>
        </div>
    </div>

    <!-- Hose Drawing Panel -->
    <div class="bottom-panel hose" id="hosePanel">
        <div class="panel-header">
            <span class="panel-title hose"><span class="material-icons">route</span>ホース延長</span>
            <button class="panel-close" onclick="closeHosePanel()"><span class="material-icons">close</span></button>
        </div>
        <div class="panel-stats">
            <div class="panel-stat"><div class="panel-stat-label">総延長</div><div class="panel-stat-value highlight" id="hoseTotalDist">0m</div></div>
            <div class="panel-stat"><div class="panel-stat-label">本数</div><div class="panel-stat-value" id="hoseTotalCount">0本</div></div>
            <div class="panel-stat"><div class="panel-stat-label">始点</div><div class="panel-stat-value" id="hoseStartElev">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">終点</div><div class="panel-stat-value" id="hoseEndElev">-</div></div>
            <div class="panel-stat wide"><div class="panel-stat-label">高低差（直線/累計）</div><div class="panel-stat-value" id="hoseElevInfo">-/-</div></div>
        </div>
        <div class="panel-hint" id="hoseHint">連続タップでポイント追加</div>
        <div class="panel-actions">
            <button class="panel-btn secondary" onclick="undoHosePoint()"><span class="material-icons">undo</span>戻す</button>
            <button class="panel-btn danger" onclick="resetHoseLine()"><span class="material-icons">delete</span></button>
            <button class="panel-btn primary" onclick="confirmHoseLine()"><span class="material-icons">check</span>確定</button>
        </div>
    </div>

    <!-- Measure Panel -->
    <div class="bottom-panel measure" id="measurePanel">
        <div class="panel-header">
            <span class="panel-title measure">2点計測</span>
            <button class="panel-close" onclick="closeMeasurePanel()"><span class="material-icons">close</span></button>
        </div>
        <div class="panel-stats">
            <div class="panel-stat"><div class="panel-stat-label">距離</div><div class="panel-stat-value measure-highlight" id="measureDistance">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">高低差</div><div class="panel-stat-value" id="measureElevation">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">始点</div><div class="panel-stat-value" id="measureStart">-</div></div>
            <div class="panel-stat"><div class="panel-stat-label">終点</div><div class="panel-stat-value" id="measureEnd">-</div></div>
        </div>
        <div class="panel-hint" id="measureHint">2点タップで計測</div>
        <div class="panel-actions">
            <button class="panel-btn secondary" onclick="resetMeasure()">リセット</button>
            <button class="panel-btn primary-cyan" onclick="closeMeasurePanel()">完了</button>
        </div>
    </div>

    <!-- Bottom Bar -->
    <div class="bottom-bar">
        <div class="my-location" onclick="flyToMyLocation()">
            <span class="material-icons">my_location</span>
            <span class="my-location-coords" id="myCoords">取得中...</span>
        </div>
        <div class="view-toggle">
            <button class="view-btn" onclick="setViewMode('2d')"><span class="material-icons">map</span>2D</button>
            <button class="view-btn active" onclick="setViewMode('3d')"><span class="material-icons">view_in_ar</span>3D</button>
        </div>
    </div>

    <script>
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIwM2NhOTIxMi03NzRmLTQzMDgtYTMzZS1kOWEyMjBmNjhhMmEiLCJpZCI6Mzg1NDQ0LCJpYXQiOjE3Njk4Mzg4NTl9.ElD_8Qq0Mp1QuoaQvnODwTCVtEfaQtuDrsS9tnwlryA';

        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrain: Cesium.Terrain.fromWorldTerrain(),
            timeline: false, animation: false, baseLayerPicker: false,
            geocoder: false, homeButton: false, sceneModePicker: false,
            navigationHelpButton: false, fullscreenButton: false,
            infoBox: false, selectionIndicator: false
        });
        viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(132.4553, 34.3853, 5000), orientation: { heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0 }, duration: 0 });

        const layers = { terrain: true, buildings: true, gsimap: false, satellite: true, trails: false, firepoints: true, firearea: true, water: true, hose: true };
        let plateauTileset = null, gsiLayer = null, trailEntities = [], fireAreaEntity = null;
        let loadedTrailAreas = new Set(); // 既に読み込んだエリアを記録

        async function loadPlateauBuildings() { try { plateauTileset = await Cesium.Cesium3DTileset.fromIonAssetId(2602291); viewer.scene.primitives.add(plateauTileset); } catch (e) {} }
        loadPlateauBuildings();

        function initGsiLayer() { gsiLayer = viewer.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({ url: 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', maximumLevel: 18 })); gsiLayer.alpha = 0.7; gsiLayer.show = false; }
        initGsiLayer();

        function toggleToolMenu() { document.getElementById('toolMenu').classList.toggle('show'); document.getElementById('layerPanel').classList.remove('show'); }
        function showLayerPanel() { document.getElementById('layerPanel').classList.toggle('show'); document.getElementById('toolMenu').classList.remove('show'); }
        function toggleQuickLayer(el, layer) { el.classList.toggle('active'); layers[layer] = el.classList.contains('active'); applyLayerState(layer); syncLayerToggle(layer); }
        function toggleLayerItem(el, layer) { const t = el.querySelector('.layer-toggle'); t.classList.toggle('on'); layers[layer] = t.classList.contains('on'); applyLayerState(layer); }
        function syncLayerToggle(layer) { const t = document.getElementById(`toggle-${layer}`); if (t) t.classList.toggle('on', layers[layer]); }
        function applyLayerState(layer) {
            switch(layer) {
                case 'terrain': viewer.scene.terrainProvider = layers.terrain ? Cesium.Terrain.fromWorldTerrain() : new Cesium.EllipsoidTerrainProvider(); break;
                case 'buildings': if (plateauTileset) plateauTileset.show = layers.buildings; break;
                case 'gsimap': if (gsiLayer) gsiLayer.show = layers.gsimap; break;
                case 'trails': 
                    trailEntities.forEach(e => e.show = layers.trails); 
                    if (layers.trails) loadTrailsNearView();
                    document.getElementById('trailInfo').classList.toggle('show', layers.trails && trailEntities.length > 0);
                    break;
                case 'firepoints': firePointEntities.forEach(e => e.show = layers.firepoints); break;
                case 'firearea': if (fireAreaEntity) fireAreaEntity.show = layers.firearea; break;
                case 'water': waterEntities.forEach(e => e.show = layers.water); break;
                case 'hose': hoseLineEntities.forEach(e => e.entity.show = layers.hose); break;
            }
        }

        // 登山道を10km範囲で読み込み（既存データ保持）
        async function loadTrailsNearView() { 
            const c = viewer.camera.positionCartographic; 
            const lat = Cesium.Math.toDegrees(c.latitude);
            const lon = Cesium.Math.toDegrees(c.longitude);
            const areaKey = `${Math.round(lat * 10)}_${Math.round(lon * 10)}`; // 約11km単位でキャッシュ
            
            if (loadedTrailAreas.has(areaKey)) return; // 既に読み込み済み
            loadedTrailAreas.add(areaKey);
            
            await loadTrails(lat, lon, 10000); // 10km範囲
        }
        
        async function loadTrails(lat, lon, r) {
            showLoading(true);
            document.getElementById('loading').textContent = `登山道読み込み中... (${(r/1000).toFixed(0)}km範囲)`;
            
            try {
                // OSM: path, footway, track, steps を取得
                const query = `[out:json][timeout:60];
                    (
                        way["highway"="path"](around:${r},${lat},${lon});
                        way["highway"="footway"](around:${r},${lat},${lon});
                        way["highway"="track"](around:${r},${lat},${lon});
                        way["highway"="steps"](around:${r},${lat},${lon});
                    );
                    out body; >; out skel qt;`;
                
                const res = await fetch('https://overpass-api.de/api/interpreter', { 
                    method: 'POST', 
                    body: 'data=' + encodeURIComponent(query) 
                });
                const data = await res.json();
                
                const nodes = {}; 
                data.elements.filter(e => e.type === 'node').forEach(n => nodes[n.id] = [n.lon, n.lat]);
                
                let newCount = 0;
                data.elements.filter(e => e.type === 'way').forEach(way => {
                    // 既に同じwayが追加されていないかチェック
                    if (trailEntities.some(e => e.osmId === way.id)) return;
                    
                    const pos = way.nodes.filter(nid => nodes[nid]).map(nid => Cesium.Cartesian3.fromDegrees(nodes[nid][0], nodes[nid][1]));
                    if (pos.length >= 2) { 
                        const e = viewer.entities.add({ 
                            polyline: { 
                                positions: pos, 
                                width: 3, 
                                material: Cesium.Color.LIGHTGREEN.withAlpha(0.8), 
                                clampToGround: true 
                            } 
                        }); 
                        e.show = layers.trails; 
                        e.osmId = way.id;
                        trailEntities.push(e);
                        newCount++;
                    }
                });
                
                console.log(`登山道: 新規${newCount}本追加, 合計${trailEntities.length}本`);
                updateTrailInfo();
                
            } catch (e) { 
                console.error('Trail load error:', e);
                // エラー時はキャッシュから除外して再読み込み可能に
                const areaKey = `${Math.round(lat * 10)}_${Math.round(lon * 10)}`;
                loadedTrailAreas.delete(areaKey);
            }
            showLoading(false);
        }
        
        function updateTrailInfo() {
            const info = document.getElementById('trailInfo');
            info.textContent = `登山道: ${trailEntities.length}本 (OSM)`;
            info.classList.toggle('show', layers.trails && trailEntities.length > 0);
        }

        // Fire Points
        let firePoints = [], firePointEntities = [], selectedFirePoint = null, firePointIdCounter = 0;
        function addFirePoint(lon, lat, height) {
            const id = `fire-${++firePointIdCounter}`;
            firePoints.push({ id, lon, lat, height, timestamp: new Date().toLocaleString('ja-JP') });
            const e = viewer.entities.add({ id, position: Cesium.Cartesian3.fromDegrees(lon, lat, height), billboard: { image: createFireIcon(), width: 28, height: 28, verticalOrigin: Cesium.VerticalOrigin.BOTTOM, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND } });
            firePointEntities.push(e); updateFireArea(); return id;
        }
        function createFireIcon() { const c = document.createElement('canvas'); c.width = 28; c.height = 28; const ctx = c.getContext('2d'); ctx.beginPath(); ctx.arc(14, 14, 12, 0, Math.PI * 2); ctx.fillStyle = 'rgba(244,67,54,0.3)'; ctx.fill(); ctx.beginPath(); ctx.arc(14, 14, 8, 0, Math.PI * 2); ctx.fillStyle = '#f44336'; ctx.fill(); ctx.beginPath(); ctx.arc(14, 14, 4, 0, Math.PI * 2); ctx.fillStyle = '#ffeb3b'; ctx.fill(); return c.toDataURL(); }
        
        function selectFirePoint(id) {
            const f = firePoints.find(p => p.id === id); if (!f) return; 
            selectedFirePoint = f;
            closeAllPanels();
            document.getElementById('fireLat').textContent = f.lat.toFixed(5) + '°';
            document.getElementById('fireLon').textContent = f.lon.toFixed(5) + '°';
            document.getElementById('fireElev').textContent = f.height.toFixed(1) + 'm';
            document.getElementById('firePanel').classList.add('active');
            updateNearbyWaterList(f.lon, f.lat);
        }
        
        function updateNearbyWaterList(lon, lat) {
            const list = document.getElementById('nearbyWaterList');
            if (waterSources.length === 0) { list.innerHTML = '<span style="color:rgba(255,255,255,0.3);font-size:8px;">水利なし</span>'; return; }
            const sorted = waterSources.map(w => ({ ...w, d: haversineDistance(lat, lon, w.lat, w.lon) })).sort((a, b) => a.d - b.d).slice(0, 5);
            list.innerHTML = sorted.map(w => `<div class="water-chip ${w.type}" onclick="selectWater('${w.id}')"><span class="water-chip-icon">${w.type[0].toUpperCase()}</span><span class="water-chip-dist">${formatDistance(w.d)}</span></div>`).join('');
        }
        
        function updateFireArea() {
            if (fireAreaEntity) { viewer.entities.remove(fireAreaEntity); fireAreaEntity = null; }
            if (firePoints.length < 3) return;
            const hull = convexHull(firePoints.map(f => [f.lon, f.lat])); if (hull.length < 3) return;
            fireAreaEntity = viewer.entities.add({ polygon: { hierarchy: hull.map(c => Cesium.Cartesian3.fromDegrees(c[0], c[1])), material: Cesium.Color.RED.withAlpha(0.15), outline: true, outlineColor: Cesium.Color.RED, outlineWidth: 2, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND } });
            fireAreaEntity.show = layers.firearea;
        }
        function convexHull(pts) { if (pts.length < 3) return pts; const s = [...pts].sort((a, b) => a[0] - b[0] || a[1] - b[1]); const cr = (o, a, b) => (a[0] - o[0]) * (b[1] - o[1]) - (a[1] - o[1]) * (b[0] - o[0]); const l = []; for (const p of s) { while (l.length >= 2 && cr(l[l.length - 2], l[l.length - 1], p) <= 0) l.pop(); l.push(p); } const u = []; for (let i = s.length - 1; i >= 0; i--) { const p = s[i]; while (u.length >= 2 && cr(u[u.length - 2], u[u.length - 1], p) <= 0) u.pop(); u.push(p); } u.pop(); l.pop(); return l.concat(u); }
        
        function closeAllPanels() {
            ['firePanel', 'waterPanel', 'hoseInfoPanel'].forEach(id => document.getElementById(id).classList.remove('active'));
            selectedFirePoint = null; selectedWater = null; selectedHoseLine = null;
        }
        function closePanel(type) { document.getElementById(type + 'Panel').classList.remove('active'); if (type === 'fire') selectedFirePoint = null; if (type === 'water') selectedWater = null; if (type === 'hoseInfo') selectedHoseLine = null; }
        function flyToSelectedFire() { if (selectedFirePoint) viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(selectedFirePoint.lon, selectedFirePoint.lat, 400), duration: 1 }); }
        function deleteSelectedFire() { if (!selectedFirePoint) return; const id = selectedFirePoint.id; firePoints = firePoints.filter(f => f.id !== id); const e = firePointEntities.find(e => e.id === id); if (e) { viewer.entities.remove(e); firePointEntities = firePointEntities.filter(x => x.id !== id); } closePanel('fire'); updateFireArea(); }

        // Water Sources
        let waterSources = [], waterEntities = [], selectedWater = null, waterIdCounter = 0;
        function initDemoWater() { [{ type: 'hydrant', name: '消火栓#1', lat: 34.3858, lon: 132.4548 }, { type: 'hydrant', name: '消火栓#2', lat: 34.3848, lon: 132.4558 }, { type: 'tank', name: '防火水槽40t', lat: 34.3863, lon: 132.4563 }, { type: 'tank', name: '防火水槽100t', lat: 34.3843, lon: 132.4538 }, { type: 'natural', name: '河川取水点', lat: 34.3838, lon: 132.4573 }].forEach(w => addWaterSource(w.type, w.name, w.lon, w.lat)); }
        function addWaterSource(type, name, lon, lat) { const id = `water-${++waterIdCounter}`; waterSources.push({ id, type, name, lon, lat }); const e = viewer.entities.add({ id, position: Cesium.Cartesian3.fromDegrees(lon, lat, 0), billboard: { image: createWaterIcon(type), width: 20, height: 20, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND } }); e.show = layers.water; waterEntities.push(e); return id; }
        function createWaterIcon(type) { const c = document.createElement('canvas'); c.width = 20; c.height = 20; const ctx = c.getContext('2d'); ctx.beginPath(); ctx.arc(10, 10, 8, 0, Math.PI * 2); ctx.fillStyle = { hydrant: '#f44336', tank: '#2196f3', natural: '#00bcd4' }[type]; ctx.fill(); ctx.fillStyle = 'white'; ctx.font = 'bold 10px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(type[0].toUpperCase(), 10, 10); return c.toDataURL(); }
        
        function selectWater(id) { 
            const w = waterSources.find(x => x.id === id); if (!w) return; 
            selectedWater = w; 
            closeAllPanels();
            document.getElementById('waterType').textContent = { hydrant: '消火栓', tank: '防火水槽', natural: '自然水利' }[w.type]; 
            document.getElementById('waterLat').textContent = w.lat.toFixed(5) + '°';
            document.getElementById('waterLon').textContent = w.lon.toFixed(5) + '°';
            document.getElementById('waterDist').textContent = selectedFirePoint ? formatDistance(haversineDistance(selectedFirePoint.lat, selectedFirePoint.lon, w.lat, w.lon)) : '-'; 
            document.getElementById('waterPanel').classList.add('active');
        }
        function flyToSelectedWater() { if (selectedWater) viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(selectedWater.lon, selectedWater.lat, 300), duration: 1 }); }
        function deleteSelectedWater() { if (!selectedWater) return; const id = selectedWater.id; waterSources = waterSources.filter(w => w.id !== id); const e = waterEntities.find(x => x.id === id); if (e) { viewer.entities.remove(e); waterEntities = waterEntities.filter(x => x.id !== id); } closePanel('water'); }
        initDemoWater();

        // Hose Lines
        let hoseLinePoints = [], hoseLineSegments = [], hoseLineMarkers = [], hoseLineEntities = [], hoseLineIdCounter = 0, selectedHoseLine = null;
        function updateHoseDisplay() {
            let totalDist = 0, cumElev = 0;
            for (let i = 1; i < hoseLinePoints.length; i++) { const p1 = hoseLinePoints[i - 1], p2 = hoseLinePoints[i]; totalDist += haversineDistance(p1.lat, p1.lon, p2.lat, p2.lon); cumElev += Math.abs(p2.height - p1.height); }
            const startH = hoseLinePoints.length > 0 ? hoseLinePoints[0].height : 0;
            const endH = hoseLinePoints.length > 0 ? hoseLinePoints[hoseLinePoints.length - 1].height : 0;
            const directElev = endH - startH;
            document.getElementById('hoseTotalDist').textContent = formatDistance(totalDist);
            document.getElementById('hoseTotalCount').textContent = Math.ceil(totalDist / 20) + '本';
            document.getElementById('hoseStartElev').textContent = hoseLinePoints.length > 0 ? startH.toFixed(1) + 'm' : '-';
            document.getElementById('hoseEndElev').textContent = hoseLinePoints.length > 0 ? endH.toFixed(1) + 'm' : '-';
            document.getElementById('hoseElevInfo').textContent = hoseLinePoints.length > 1 ? `${directElev >= 0 ? '+' : ''}${directElev.toFixed(1)}m/${cumElev.toFixed(1)}m` : '-/-';
            if (hoseLinePoints.length > 0) document.getElementById('hoseHint').textContent = `${hoseLinePoints.length}点`;
        }
        function addHosePoint(lon, lat, height, cartesian) {
            hoseLinePoints.push({ lon, lat, height, cartesian });
            const m = viewer.entities.add({ position: cartesian, point: { pixelSize: 8, color: Cesium.Color.ORANGE, outlineColor: Cesium.Color.WHITE, outlineWidth: 1, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND }, label: { text: String(hoseLinePoints.length), font: '9px sans-serif', fillColor: Cesium.Color.WHITE, outlineColor: Cesium.Color.BLACK, outlineWidth: 1, style: Cesium.LabelStyle.FILL_AND_OUTLINE, verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0, -10) } });
            hoseLineMarkers.push(m);
            if (hoseLinePoints.length >= 2) { const prev = hoseLinePoints[hoseLinePoints.length - 2]; const seg = viewer.entities.add({ polyline: { positions: [prev.cartesian, cartesian], width: 5, material: new Cesium.PolylineDashMaterialProperty({ color: Cesium.Color.ORANGE, dashLength: 12 }), clampToGround: true } }); hoseLineSegments.push(seg); }
            updateHoseDisplay();
        }
        function undoHosePoint() { if (hoseLinePoints.length === 0) return; hoseLinePoints.pop(); if (hoseLineMarkers.length > 0) viewer.entities.remove(hoseLineMarkers.pop()); if (hoseLineSegments.length > 0) viewer.entities.remove(hoseLineSegments.pop()); updateHoseDisplay(); }
        function resetHoseLine() { hoseLinePoints = []; hoseLineMarkers.forEach(e => viewer.entities.remove(e)); hoseLineMarkers = []; hoseLineSegments.forEach(e => viewer.entities.remove(e)); hoseLineSegments = []; updateHoseDisplay(); document.getElementById('hoseHint').textContent = '連続タップでポイント追加'; }
        function confirmHoseLine() {
            if (hoseLinePoints.length < 2) { alert('2点以上必要'); return; }
            const id = `hose-${++hoseLineIdCounter}`;
            let totalDist = 0, cumElev = 0;
            for (let i = 1; i < hoseLinePoints.length; i++) { const p1 = hoseLinePoints[i - 1], p2 = hoseLinePoints[i]; totalDist += haversineDistance(p1.lat, p1.lon, p2.lat, p2.lon); cumElev += Math.abs(p2.height - p1.height); }
            const startH = hoseLinePoints[0].height, endH = hoseLinePoints[hoseLinePoints.length - 1].height;
            const lineEntity = viewer.entities.add({ id, polyline: { positions: hoseLinePoints.map(p => p.cartesian), width: 4, material: new Cesium.PolylineDashMaterialProperty({ color: Cesium.Color.DARKORANGE, dashLength: 10 }), clampToGround: true } });
            hoseLineEntities.push({ id, entity: lineEntity, totalDist, count: Math.ceil(totalDist / 20), startH, endH, directElev: endH - startH, cumElev });
            hoseLineMarkers.forEach(e => viewer.entities.remove(e)); hoseLineSegments.forEach(e => viewer.entities.remove(e));
            hoseLinePoints = []; hoseLineMarkers = []; hoseLineSegments = [];
            updateHoseDisplay(); document.getElementById('hoseHint').textContent = '確定！続けて描画可';
        }
        function selectHoseLine(id) {
            const h = hoseLineEntities.find(x => x.id === id); if (!h) return; 
            selectedHoseLine = h;
            closeAllPanels();
            document.getElementById('hoseInfoDist').textContent = formatDistance(h.totalDist);
            document.getElementById('hoseInfoCount').textContent = h.count + '本';
            document.getElementById('hoseInfoStart').textContent = h.startH.toFixed(1) + 'm';
            document.getElementById('hoseInfoEnd').textContent = h.endH.toFixed(1) + 'm';
            document.getElementById('hoseInfoElev').textContent = `${h.directElev >= 0 ? '+' : ''}${h.directElev.toFixed(1)}m/${h.cumElev.toFixed(1)}m`;
            document.getElementById('hoseInfoPanel').classList.add('active');
        }
        function deleteSelectedHose() { if (!selectedHoseLine) return; viewer.entities.remove(selectedHoseLine.entity); hoseLineEntities = hoseLineEntities.filter(h => h.id !== selectedHoseLine.id); closePanel('hoseInfo'); }
        function closeHosePanel() { document.getElementById('hosePanel').classList.remove('active'); resetHoseLine(); document.querySelectorAll('.tool-item').forEach(t => t.classList.remove('active')); document.getElementById('modeIndicator').classList.remove('show'); currentTool = null; }

        // Measure
        let measurePoints = [], measureEntities = [];
        function addMeasurePoint(lon, lat, height, cartesian) {
            measurePoints.push({ lon, lat, height, cartesian });
            const m = viewer.entities.add({ position: cartesian, point: { pixelSize: 7, color: Cesium.Color.CYAN, outlineColor: Cesium.Color.WHITE, outlineWidth: 1, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND } });
            measureEntities.push(m);
            if (measurePoints.length === 2) {
                const p1 = measurePoints[0], p2 = measurePoints[1];
                measureEntities.push(viewer.entities.add({ polyline: { positions: [p1.cartesian, p2.cartesian], width: 2, material: Cesium.Color.CYAN.withAlpha(0.8), clampToGround: true } }));
                const dist = haversineDistance(p1.lat, p1.lon, p2.lat, p2.lon), elev = p2.height - p1.height;
                document.getElementById('measureDistance').textContent = formatDistance(dist);
                document.getElementById('measureElevation').textContent = (elev >= 0 ? '+' : '') + elev.toFixed(1) + 'm';
                document.getElementById('measureStart').textContent = p1.height.toFixed(1) + 'm';
                document.getElementById('measureEnd').textContent = p2.height.toFixed(1) + 'm';
                document.getElementById('measureHint').style.display = 'none';
            }
        }
        function resetMeasure() { measurePoints = []; measureEntities.forEach(e => viewer.entities.remove(e)); measureEntities = []; document.getElementById('measureDistance').textContent = '-'; document.getElementById('measureElevation').textContent = '-'; document.getElementById('measureStart').textContent = '-'; document.getElementById('measureEnd').textContent = '-'; document.getElementById('measureHint').style.display = 'block'; }
        function closeMeasurePanel() { document.getElementById('measurePanel').classList.remove('active'); resetMeasure(); document.querySelectorAll('.tool-item').forEach(t => t.classList.remove('active')); document.getElementById('modeIndicator').classList.remove('show'); currentTool = null; }

        // Tool
        let currentTool = null;
        function setTool(tool) {
            document.querySelectorAll('.tool-item').forEach(t => t.classList.remove('active'));
            document.getElementById('modeIndicator').classList.remove('show', 'water-mode', 'hose-mode', 'measure-mode');
            document.getElementById('hosePanel').classList.remove('active');
            document.getElementById('measurePanel').classList.remove('active');
            document.getElementById('toolMenu').classList.remove('show');
            closeAllPanels();
            
            if (currentTool === tool) { currentTool = null; return; }
            currentTool = tool;
            const ind = document.getElementById('modeIndicator'), icon = document.getElementById('modeIcon'), text = document.getElementById('modeText');
            if (tool === 'fire') { document.getElementById('toolFire').classList.add('active'); icon.textContent = 'local_fire_department'; text.textContent = '火点追加'; ind.classList.add('show'); }
            else if (tool === 'water') { document.getElementById('toolWater').classList.add('active'); icon.textContent = 'water_drop'; text.textContent = '水利追加'; ind.classList.add('show', 'water-mode'); }
            else if (tool === 'hose') { document.getElementById('toolHose').classList.add('active'); icon.textContent = 'route'; text.textContent = 'ホース延長'; ind.classList.add('show', 'hose-mode'); document.getElementById('hosePanel').classList.add('active'); resetHoseLine(); }
            else if (tool === 'measure') { document.getElementById('toolMeasure').classList.add('active'); icon.textContent = 'straighten'; text.textContent = '2点計測'; ind.classList.add('show', 'measure-mode'); document.getElementById('measurePanel').classList.add('active'); resetMeasure(); }
        }

        // Click
        const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        handler.setInputAction(async function(click) {
            const picked = viewer.scene.pick(click.position);
            if (picked?.id?.id?.startsWith('fire-')) { selectFirePoint(picked.id.id); return; }
            if (picked?.id?.id?.startsWith('water-')) { selectWater(picked.id.id); return; }
            if (picked?.id?.id?.startsWith('hose-')) { selectHoseLine(picked.id.id); return; }
            const ray = viewer.camera.getPickRay(click.position);
            const cartesian = viewer.scene.globe.pick(ray, viewer.scene);
            if (!cartesian) return;
            const carto = Cesium.Cartographic.fromCartesian(cartesian);
            const lon = Cesium.Math.toDegrees(carto.longitude), lat = Cesium.Math.toDegrees(carto.latitude);
            let height = 0; try { const u = await Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, [Cesium.Cartographic.fromDegrees(lon, lat)]); height = u[0].height || 0; } catch (e) { height = carto.height || 0; }
            if (currentTool === 'fire') { const id = addFirePoint(lon, lat, height); selectFirePoint(id); }
            else if (currentTool === 'water') { const id = addWaterSource('hydrant', `消火栓#${waterIdCounter + 1}`, lon, lat); selectWater(id); }
            else if (currentTool === 'hose') { addHosePoint(lon, lat, height, cartesian); }
            else if (currentTool === 'measure') { if (measurePoints.length >= 2) resetMeasure(); addMeasurePoint(lon, lat, height, cartesian); }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        function haversineDistance(lat1, lon1, lat2, lon2) { const R = 6371000, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2; return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
        function formatDistance(m) { return m >= 1000 ? (m/1000).toFixed(2) + 'km' : m.toFixed(0) + 'm'; }
        function showLoading(show) { document.getElementById('loading').classList.toggle('show', show); if (!show) document.getElementById('loading').textContent = '読み込み中...'; }
        function setViewMode(mode) { document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active')); event.target.closest('.view-btn').classList.add('active'); viewer.scene.mode = mode === '2d' ? Cesium.SceneMode.SCENE2D : Cesium.SceneMode.SCENE3D; }
        let myLat = null, myLon = null;
        function flyToMyLocation() { if (myLat && myLon) viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(myLon, myLat, 800), duration: 1.5 }); }
        if ('geolocation' in navigator) { navigator.geolocation.watchPosition(pos => { myLat = pos.coords.latitude; myLon = pos.coords.longitude; document.getElementById('myCoords').textContent = `${myLat.toFixed(4)}°, ${myLon.toFixed(4)}°`; }, () => { document.getElementById('myCoords').textContent = '取得失敗'; }, { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }); }
        function shareView() { const p = viewer.camera.positionCartographic; navigator.clipboard.writeText(`${location.origin}${location.pathname}?lat=${Cesium.Math.toDegrees(p.latitude).toFixed(6)}&lon=${Cesium.Math.toDegrees(p.longitude).toFixed(6)}&h=${p.height.toFixed(0)}`).then(() => alert('URLコピー')); }
        const params = new URLSearchParams(location.search);
        if (params.has('lat') && params.has('lon')) { viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(parseFloat(params.get('lon')), parseFloat(params.get('lat')), parseFloat(params.get('h')) || 3000), duration: 2 }); }
    </script>
</body>
</html>
