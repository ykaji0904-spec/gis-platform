target.closest('.search-results')) document.getElementById('searchResults').classList.remove('show'); });

        // ========== GEOLOCATION & COMPASS (P7) ==========
        let myLat = null, myLon = null, myHeading = 0, followMode = false, myLocationEntity = null;
        function flyToMyLocation() { if (myLat && myLon) viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(myLon, myLat, 800), duration: 1.5 }); }
        function toggleFollow() { followMode = !followMode; document.getElementById('followBtn').classList.toggle('active', followMode); if (followMode) showToast('位置追従ON'); }
        function updateMyLocationMarker() { if (!myLat || !myLon) return; if (myLocationEntity) viewer.entities.remove(myLocationEntity); myLocationEntity = viewer.entities.add({ position: Cesium.Cartesian3.fromDegrees(myLon, myLat), billboard: { image: createCompassIcon(myHeading), width: 32, height: 32, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND } }); if (followMode) viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(myLon, myLat, viewer.camera.positionCartographic.height), orientation: { heading: Cesium.Math.toRadians(myHeading), pitch: viewer.camera.pitch, roll: 0 }, duration: 0.5 }); }
        function createCompassIcon(heading) { const c = document.createElement('canvas'); c.width = 32; c.height = 32; const ctx = c.getContext('2d'); ctx.translate(16, 16); ctx.rotate(heading * Math.PI / 180); ctx.beginPath(); ctx.moveTo(0, -12); ctx.lineTo(6, 10); ctx.lineTo(0, 6); ctx.lineTo(-6, 10); ctx.closePath(); ctx.fillStyle = '#4ade80'; ctx.fill(); ctx.strokeStyle = 'white'; ctx.lineWidth = 1; ctx.stroke(); return c.toDataURL(); }
        if ('geolocation' in navigator) { navigator.geolocation.watchPosition(pos => { myLat = pos.coords.latitude; myLon = pos.coords.longitude; document.getElementById('myCoords').textContent = `${myLat.toFixed(4)}°, ${myLon.toFixed(4)}°`; updateMyLocationMarker(); }, () => { document.getElementById('myCoords').textContent = '取得失敗'; }, { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }); }
        if (window.DeviceOrientationEvent) { window.addEventListener('deviceorientationabsolute', e => { if (e.absolute && e.alpha !== null) { myHeading = 360 - e.alpha; updateMyLocationMarker(); } }, true); window.addEventListener('deviceorientation', e => { if (e.webkitCompassHeading !== undefined) { myHeading = e.webkitCompassHeading; updateMyLocationMarker(); } }, true); }
        viewer.camera.moveStart.addEventListener(() => { if (followMode) { followMode = false; document.getElementById('followBtn').classList.remove('active'); } });

        // ========== COORD DISPLAY (P6) ==========
        const coordHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        coordHandler.setInputAction(movement => { const ray = viewer.camera.getPickRay(movement.endPosition); const cartesian = viewer.scene.globe.pick(ray, viewer.scene); if (cartesian) { const carto = Cesium.Cartographic.fromCartesian(cartesian); document.getElementById('coordDisplay').textContent = `${Cesium.Math.toDegrees(carto.latitude).toFixed(5)}°, ${Cesium.Math.toDegrees(carto.longitude).toFixed(5)}°`; } }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

        // ========== TOOL SYSTEM ==========
        let currentTool = null;
        function setTool(tool) { document.querySelectorAll('.tool-item').forEach(t => t.classList.remove('active')); document.getElementById('modeIndicator').classList.remove('show', 'water-mode', 'hose-mode', 'measure-mode', 'annot-mode'); document.getElementById('hosePanel').classList.remove('active'); document.getElementById('measurePanel').classList.remove('active'); document.getElementById('annotPanel').classList.remove('active'); document.getElementById('toolMenu').classList.remove('show'); closeAllPanels(); if (currentTool === tool) { currentTool = null; return; } currentTool = tool; const ind = document.getElementById('modeIndicator'), icon = document.getElementById('modeIcon'), text = document.getElementById('modeText'); if (tool === 'fire') { document.getElementById('toolFire').classList.add('active'); icon.textContent = 'local_fire_department'; text.textContent = '火点追加'; ind.classList.add('show'); } else if (tool === 'water') { document.getElementById('toolWater').classList.add('active'); icon.textContent = 'water_drop'; text.textContent = '水利追加'; ind.classList.add('show', 'water-mode'); } else if (tool === 'hose') { document.getElementById('toolHose').classList.add('active'); icon.textContent = 'route'; text.textContent = 'ホース延長'; ind.classList.add('show', 'hose-mode'); document.getElementById('hosePanel').classList.add('active'); resetHoseLine(); } else if (tool === 'measure') { document.getElementById('toolMeasure').classList.add('active'); icon.textContent = 'straighten'; text.textContent = '2点計測'; ind.classList.add('show', 'measure-mode'); document.getElementById('measurePanel').classList.add('active'); resetMeasure(); } else if (tool === 'annot') { document.getElementById('toolAnnot').classList.add('active'); icon.textContent = 'edit_location_alt'; text.textContent = '注記追加'; ind.classList.add('show', 'annot-mode'); document.getElementById('annotPanel').classList.add('active'); resetAnnot(); } }

        // ========== CLICK HANDLER ==========
        const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        handler.setInputAction(async function(click) { const picked = viewer.scene.pick(click.position); let pickedId = picked?.id?.id || (typeof picked?.id === 'string' ? picked.id : null); if (pickedId) { if (pickedId.startsWith('fire-')) { selectFirePoint(pickedId); return; } if (pickedId.startsWith('water-')) { selectWater(pickedId); return; } if (pickedId.startsWith('hose-')) { selectHoseLine(pickedId); return; } } const ray = viewer.camera.getPickRay(click.position); const cartesian = viewer.scene.globe.pick(ray, viewer.scene); if (!cartesian) return; const carto = Cesium.Cartographic.fromCartesian(cartesian), lon = Cesium.Math.toDegrees(carto.longitude), lat = Cesium.Math.toDegrees(carto.latitude); let height = 0; try { const u = await Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, [Cesium.Cartographic.fromDegrees(lon, lat)]); height = u[0].height || 0; } catch (e) { height = carto.height || 0; } if (currentTool === 'fire') { const id = addFirePoint(lon, lat, height); selectFirePoint(id); } else if (currentTool === 'water') { const id = addWaterSource('hydrant', `消火栓#${waterIdCounter + 1}`, lon, lat); selectWater(id); } else if (currentTool === 'hose') { addHosePoint(lon, lat, height, cartesian); } else if (currentTool === 'measure') { if (measurePoints.length >= 2) resetMeasure(); addMeasurePoint(lon, lat, height, cartesian); } else if (currentTool === 'annot') { addAnnotPoint(lon, lat, height, cartesian); } }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        // ========== UTILITIES ==========
        function geodesicDistance(lon1, lat1, lon2, lat2) { const geodesic = new Cesium.EllipsoidGeodesic(Cesium.Cartographic.fromDegrees(lon1, lat1), Cesium.Cartographic.fromDegrees(lon2, lat2)); return geodesic.surfaceDistance; }
        function formatDistance(m) { return m >= 1000 ? (m/1000).toFixed(2) + 'km' : m.toFixed(0) + 'm'; }
        function showLoading(show, title, detail) { document.getElementById('loading').classList.toggle('show', show); if (show) { document.querySelector('.loading-title').textContent = title || '読み込み中...'; document.getElementById('loadingDetail').textContent = detail || ''; } }
        function showToast(msg) { if (!msg) return; const t = document.getElementById('toast'); t.textContent = msg; t.classList.remove('show'); void t.offsetWidth; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }
        function setViewMode(mode) { document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active')); event.target.closest('.view-btn').classList.add('active'); viewer.scene.mode = mode === '2d' ? Cesium.SceneMode.SCENE2D : Cesium.SceneMode.SCENE3D; }
        function shareView() { const p = viewer.camera.positionCartographic; navigator.clipboard.writeText(`${location.origin}${location.pathname}?lat=${Cesium.Math.toDegrees(p.latitude).toFixed(6)}&lon=${Cesium.Math.toDegrees(p.longitude).toFixed(6)}&h=${p.height.toFixed(0)}`).then(() => showToast('URLをコピー')); }
        const params = new URLSearchParams(location.search); if (params.has('lat') && params.has('lon')) { viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(parseFloat(params.get('lon')), parseFloat(params.get('lat')), parseFloat(params.get('h')) || 3000), duration: 2 }); }
    </script>
</body>
</html>
