<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GIS Platform</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans JP', sans-serif; overflow: hidden; background: #000; }
        #cesiumContainer { width: 100vw; height: 100vh; }
        
        .top-bar { position: fixed; top: 0; left: 0; right: 0; height: 52px; background: rgba(15,15,15,0.95); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 1000; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, #ff6b35, #f7931e); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .logo-icon .material-icons { color: white; font-size: 22px; }
        .logo-text { color: white; font-size: 16px; font-weight: 700; }
        
        .map-type-switch { display: flex; background: rgba(255,255,255,0.1); border-radius: 8px; padding: 3px; }
        .map-type-btn { padding: 8px 16px; border: none; background: transparent; color: rgba(255,255,255,0.6); font-size: 13px; cursor: pointer; border-radius: 6px; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .map-type-btn.active { background: rgba(0,212,255,0.25); color: #00d4ff; }
        .map-type-btn .material-icons { font-size: 18px; }
        
        .menu-btn { width: 44px; height: 44px; background: rgba(255,255,255,0.08); border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .menu-btn:hover { background: rgba(255,255,255,0.15); }
        .menu-btn .material-icons { color: white; font-size: 26px; }
        
        .side-panel-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .side-panel-overlay.show { opacity: 1; visibility: visible; }
        .side-panel { position: fixed; top: 0; right: 0; bottom: 0; width: 320px; max-width: 85vw; background: rgba(20,20,20,0.98); z-index: 2001; transform: translateX(100%); transition: transform 0.3s ease; overflow-y: auto; }
        .side-panel.show { transform: translateX(0); }
        .side-panel-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .side-panel-title { color: white; font-size: 16px; font-weight: 600; }
        .side-panel-close { background: none; border: none; color: rgba(255,255,255,0.6); cursor: pointer; padding: 8px; }
        .panel-section { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .panel-section-title { color: rgba(255,255,255,0.5); font-size: 11px; text-transform: uppercase; margin-bottom: 12px; font-weight: 600; }
        .layer-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .layer-card { display: flex; flex-direction: column; align-items: center; padding: 12px 8px; border-radius: 12px; cursor: pointer; background: rgba(255,255,255,0.04); border: 2px solid transparent; transition: all 0.2s; }
        .layer-card:hover { background: rgba(255,255,255,0.08); }
        .layer-card.active { background: rgba(0,212,255,0.12); border-color: #00d4ff; }
        .layer-card-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
        .layer-card-icon .material-icons { font-size: 22px; }
        .layer-card-icon.fire { background: rgba(244,67,54,0.2); color: #f44336; }
        .layer-card-icon.water { background: rgba(33,150,243,0.2); color: #2196f3; }
        .layer-card-icon.hose { background: rgba(255,152,0,0.2); color: #ff9800; }
        .layer-card-icon.measure { background: rgba(0,212,255,0.2); color: #00d4ff; }
        .layer-card-icon.building { background: rgba(139,195,74,0.2); color: #8bc34a; }
        .layer-card-icon.flood { background: rgba(33,150,243,0.2); color: #2196f3; }
        .layer-card-icon.tsunami { background: rgba(0,188,212,0.2); color: #00bcd4; }
        .layer-card-icon.landslide { background: rgba(255,87,34,0.2); color: #ff5722; }
        .layer-card-name { color: white; font-size: 11px; text-align: center; font-weight: 500; }
        
        .mode-indicator { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: rgba(244,67,54,0.95); padding: 8px 16px; border-radius: 20px; display: none; align-items: center; gap: 8px; z-index: 1000; }
        .mode-indicator.show { display: flex; }
        .mode-indicator.water-mode { background: rgba(33,150,243,0.95); }
        .mode-indicator.hose-mode { background: rgba(255,152,0,0.95); }
        .mode-indicator.measure-mode { background: rgba(0,212,255,0.95); }
        .mode-indicator .material-icons { color: white; font-size: 18px; }
        .mode-indicator span { color: white; font-size: 13px; font-weight: 600; }
        
        .bottom-panel { position: fixed; bottom: 60px; left: 10px; right: 10px; background: rgba(15,15,15,0.95); padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); z-index: 900; display: none; }
        .bottom-panel.active { display: block; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .panel-title { font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; color: #ff9800; }
        .panel-title .material-icons { font-size: 16px; }
        .panel-close { background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; padding: 4px; }
        .panel-stats { display: flex; gap: 14px; flex-wrap: wrap; }
        .panel-stat { flex: 1; min-width: 65px; }
        .panel-stat-label { color: rgba(255,255,255,0.5); font-size: 9px; text-transform: uppercase; margin-bottom: 2px; }
        .panel-stat-value { color: white; font-size: 14px; font-weight: 600; }
        .panel-stat-value.highlight { color: #00d4ff; }
        .panel-hint { color: rgba(255,255,255,0.4); font-size: 10px; margin-top: 8px; }
        .panel-actions { display: flex; gap: 8px; margin-top: 10px; }
        .panel-btn { flex: 1; padding: 8px; border: none; border-radius: 6px; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-weight: 500; }
        .panel-btn .material-icons { font-size: 14px; }
        .panel-btn.primary { background: linear-gradient(135deg, #00d4ff, #0099cc); color: white; }
        .panel-btn.secondary { background: rgba(255,255,255,0.1); color: white; }
        .panel-btn.danger { background: rgba(244,67,54,0.2); color: #f44336; }
        
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 52px; background: rgba(15,15,15,0.95); border-top: 1px solid rgba(255,255,255,0.1); padding: 0 12px; z-index: 1000; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .my-location { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.06); padding: 6px 10px; border-radius: 8px; cursor: pointer; }
        .my-location .material-icons { font-size: 16px; color: #4ade80; }
        .my-location-coords { color: white; font-size: 10px; font-family: monospace; }
        .view-toggle { display: flex; background: rgba(255,255,255,0.06); border-radius: 8px; }
        .view-btn { padding: 7px 12px; border: none; background: transparent; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 4px; }
        .view-btn.active { background: rgba(0,212,255,0.2); color: #00d4ff; border-radius: 8px; }
        .view-btn .material-icons { font-size: 14px; }
        
        .map-info { position: fixed; bottom: 60px; right: 12px; z-index: 800; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .credit-bar { background: rgba(0,0,0,0.7); padding: 3px 8px; border-radius: 4px; font-size: 9px; color: rgba(255,255,255,0.8); }
        .coord-display { position: fixed; bottom: 60px; left: 12px; background: rgba(0,0,0,0.7); padding: 4px 8px; border-radius: 4px; font-size: 9px; color: rgba(255,255,255,0.9); font-family: monospace; z-index: 800; }
        
        .toast { position: fixed; top: 110px; left: 50%; transform: translateX(-50%); background: rgba(50,50,50,0.95); padding: 12px 20px; border-radius: 10px; color: white; font-size: 13px; z-index: 3000; display: none; }
        .toast.show { display: block; }
        
        .cesium-viewer-toolbar, .cesium-viewer-animationContainer, .cesium-viewer-timelineContainer, .cesium-viewer-fullscreenContainer, .cesium-viewer-bottom { display: none !important; }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div class="toast" id="toast"></div>
    
    <div class="top-bar">
        <div class="logo">
            <div class="logo-icon"><span class="material-icons">local_fire_department</span></div>
            <span class="logo-text">GIS Platform</span>
        </div>
        <div class="map-type-switch">
            <button class="map-type-btn active" id="mapBtnSatellite"><span class="material-icons">satellite_alt</span><span>衛星</span></button>
            <button class="map-type-btn" id="mapBtnStd"><span class="material-icons">map</span><span>地図</span></button>
        </div>
        <button class="menu-btn" id="menuBtn"><span class="material-icons">menu</span></button>
    </div>
    
    <div class="mode-indicator" id="modeIndicator">
        <span class="material-icons" id="modeIcon">local_fire_department</span>
        <span id="modeText">火点追加</span>
    </div>
    
    <div class="side-panel-overlay" id="sidePanelOverlay"></div>
    <div class="side-panel" id="sidePanel">
        <div class="side-panel-header">
            <span class="side-panel-title">メニュー</span>
            <button class="side-panel-close" id="sidePanelClose"><span class="material-icons">close</span></button>
        </div>
        <div class="panel-section">
            <div class="panel-section-title">地図レイヤ</div>
            <div class="layer-grid">
                <div class="layer-card active" id="layerBuildings">
                    <div class="layer-card-icon building"><span class="material-icons">location_city</span></div>
                    <span class="layer-card-name">3D建物</span>
                </div>
            </div>
        </div>
        <div class="panel-section">
            <div class="panel-section-title">オペレーション</div>
            <div class="layer-grid">
                <div class="layer-card" id="opFire">
                    <div class="layer-card-icon fire"><span class="material-icons">local_fire_department</span></div>
                    <span class="layer-card-name">火点</span>
                </div>
                <div class="layer-card" id="opWater">
                    <div class="layer-card-icon water"><span class="material-icons">water_drop</span></div>
                    <span class="layer-card-name">水利</span>
                </div>
                <div class="layer-card" id="opHose">
                    <div class="layer-card-icon hose"><span class="material-icons">route</span></div>
                    <span class="layer-card-name">ホース延長</span>
                </div>
                <div class="layer-card" id="opMeasure">
                    <div class="layer-card-icon measure"><span class="material-icons">straighten</span></div>
                    <span class="layer-card-name">2点計測</span>
                </div>
            </div>
        </div>
        <div class="panel-section">
            <div class="panel-section-title">ハザードマップ</div>
            <div class="layer-grid">
                <div class="layer-card" id="layerFlood">
                    <div class="layer-card-icon flood"><span class="material-icons">water</span></div>
                    <span class="layer-card-name">洪水</span>
                </div>
                <div class="layer-card" id="layerTsunami">
                    <div class="layer-card-icon tsunami"><span class="material-icons">waves</span></div>
                    <span class="layer-card-name">津波</span>
                </div>
                <div class="layer-card" id="layerLandslide">
                    <div class="layer-card-icon landslide"><span class="material-icons">landslide</span></div>
                    <span class="layer-card-name">土砂</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bottom-panel" id="hosePanel">
        <div class="panel-header">
            <span class="panel-title"><span class="material-icons">route</span>ホース延長</span>
            <button class="panel-close" id="hosePanelClose"><span class="material-icons">close</span></button>
        </div>
        <div class="panel-stats">
            <div class="panel-stat">
                <div class="panel-stat-label">総延長</div>
                <div class="panel-stat-value highlight" id="hoseTotalDist">0m</div>
            </div>
            <div class="panel-stat">
                <div class="panel-stat-label">本数(20m)</div>
                <div class="panel-stat-value" id="hoseTotalCount">0本</div>
            </div>
        </div>
        <div class="panel-hint" id="hoseHint">連続タップでポイント追加</div>
        <div class="panel-actions">
            <button class="panel-btn secondary" id="undoHoseBtn"><span class="material-icons">undo</span>戻す</button>
            <button class="panel-btn danger" id="resetHoseBtn"><span class="material-icons">delete</span></button>
            <button class="panel-btn primary" id="confirmHoseBtn"><span class="material-icons">check</span>確定</button>
        </div>
    </div>
    
    <div class="bottom-panel" id="measurePanel">
        <div class="panel-header">
            <span class="panel-title" style="color:#00d4ff"><span class="material-icons">straighten</span>2点計測</span>
            <button class="panel-close" id="measurePanelClose"><span class="material-icons">close</span></button>
        </div>
        <div class="panel-stats">
            <div class="panel-stat">
                <div class="panel-stat-label">距離</div>
                <div class="panel-stat-value highlight" id="measureDistance">-</div>
            </div>
            <div class="panel-stat">
                <div class="panel-stat-label">高低差</div>
                <div class="panel-stat-value" id="measureElev">-</div>
            </div>
        </div>
        <div class="panel-hint" id="measureHint">2点をタップして計測</div>
        <div class="panel-actions">
            <button class="panel-btn secondary" id="resetMeasureBtn"><span class="material-icons">refresh</span>リセット</button>
        </div>
    </div>
    
    <div class="map-info">
        <div class="credit-bar" id="creditBar">© 国土地理院</div>
    </div>
    <div class="coord-display" id="coordDisplay">--</div>
    
    <div class="bottom-bar">
        <div class="my-location" id="myLocationBtn">
            <span class="material-icons">my_location</span>
            <span class="my-location-coords" id="myLocationText">取得中...</span>
        </div>
        <div class="view-toggle">
            <button class="view-btn" id="view2dBtn"><span class="material-icons">map</span>2D</button>
            <button class="view-btn active" id="view3dBtn"><span class="material-icons">view_in_ar</span>3D</button>
        </div>
    </div>

    <script>
    (function() {
        'use strict';
        
        console.log('Starting GIS Platform...');
        
        // Cesium Ion Token
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0YjkwN2E2MC1jYjM5LTRmNzUtOTEyZS1hYTBlNmYzNWRhMjUiLCJpZCI6MjU5MjkyLCJpYXQiOjE3MzI2MTg4MDB9.vvcLKVhx_sUMFYMYwZzArW2DfXRxXdJdgfxDqpE7ba8';
        
        // Viewer作成（国土地理院航空写真）
        var viewer = new Cesium.Viewer('cesiumContainer', {
            imageryProvider: new Cesium.UrlTemplateImageryProvider({
                url: 'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg',
                maximumLevel: 18,
                credit: '国土地理院'
            }),
            baseLayerPicker: false,
            geocoder: false,
            homeButton: false,
            sceneModePicker: false,
            navigationHelpButton: false,
            animation: false,
            timeline: false,
            fullscreenButton: false,
            infoBox: false,
            selectionIndicator: false
        });
        
        console.log('Viewer created');
        
        // 広島市へ移動
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(132.4553, 34.3853, 5000),
            orientation: { heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0 },
            duration: 2
        });
        
        // 状態
        var currentBasemap = 'satellite';
        var currentTool = null;
        var layers = { buildings: true };
        var osmBuildingsTileset = null;
        var hazardLayers = {};
        var satelliteLayer = viewer.imageryLayers.get(0);
        var stdLayer = null;
        
        // 標準地図レイヤー追加
        stdLayer = viewer.imageryLayers.addImageryProvider(
            new Cesium.UrlTemplateImageryProvider({
                url: 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
                maximumLevel: 18
            })
        );
        stdLayer.show = false;
        
        // 3D建物
        Cesium.createOsmBuildingsAsync().then(function(tileset) {
            osmBuildingsTileset = tileset;
            viewer.scene.primitives.add(osmBuildingsTileset);
            console.log('3D Buildings loaded');
        }).catch(function(e) {
            console.warn('3D Buildings failed:', e);
        });
        
        // ベースマップ切り替え
        function setBasemap(type) {
            currentBasemap = type;
            if (type === 'satellite') {
                satelliteLayer.show = true;
                stdLayer.show = false;
                document.getElementById('mapBtnSatellite').classList.add('active');
                document.getElementById('mapBtnStd').classList.remove('active');
            } else {
                satelliteLayer.show = false;
                stdLayer.show = true;
                document.getElementById('mapBtnSatellite').classList.remove('active');
                document.getElementById('mapBtnStd').classList.add('active');
            }
            document.getElementById('creditBar').textContent = '© 国土地理院';
        }
        
        // サイドパネル
        function openSidePanel() {
            console.log('Opening side panel');
            document.getElementById('sidePanelOverlay').classList.add('show');
            document.getElementById('sidePanel').classList.add('show');
        }
        
        function closeSidePanel() {
            console.log('Closing side panel');
            document.getElementById('sidePanelOverlay').classList.remove('show');
            document.getElementById('sidePanel').classList.remove('show');
        }
        
        // ハザードレイヤー
        function toggleHazardLayer(name) {
            var urls = {
                flood: 'https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png',
                tsunami: 'https://disaportaldata.gsi.go.jp/raster/04_tsunami_newlegend_data/{z}/{x}/{y}.png',
                landslide: 'https://disaportaldata.gsi.go.jp/raster/05_dosekiryukeikaikuiki/{z}/{x}/{y}.png'
            };
            
            // 全てオフ
            ['flood', 'tsunami', 'landslide'].forEach(function(n) {
                if (hazardLayers[n]) {
                    viewer.imageryLayers.remove(hazardLayers[n]);
                    hazardLayers[n] = null;
                }
                document.getElementById('layer' + n.charAt(0).toUpperCase() + n.slice(1)).classList.remove('active');
            });
            
            // 選択したものをオン
            if (!hazardLayers[name]) {
                hazardLayers[name] = viewer.imageryLayers.addImageryProvider(
                    new Cesium.UrlTemplateImageryProvider({ url: urls[name], maximumLevel: 17 })
                );
                hazardLayers[name].alpha = 0.6;
                document.getElementById('layer' + name.charAt(0).toUpperCase() + name.slice(1)).classList.add('active');
                document.getElementById('creditBar').textContent = '© 国土交通省';
            } else {
                document.getElementById('creditBar').textContent = '© 国土地理院';
            }
        }
        
        // オペレーション
        function setOperation(op) {
            console.log('Setting operation:', op);
            if (currentTool === op) {
                clearTool();
                return;
            }
            clearTool();
            currentTool = op;
            
            var ind = document.getElementById('modeIndicator');
            var icon = document.getElementById('modeIcon');
            var text = document.getElementById('modeText');
            
            ind.className = 'mode-indicator show';
            
            if (op === 'fire') {
                icon.textContent = 'local_fire_department';
                text.textContent = '火点追加';
            } else if (op === 'water') {
                icon.textContent = 'water_drop';
                text.textContent = '水利追加';
                ind.classList.add('water-mode');
            } else if (op === 'hose') {
                icon.textContent = 'route';
                text.textContent = 'ホース延長';
                ind.classList.add('hose-mode');
                document.getElementById('hosePanel').classList.add('active');
            } else if (op === 'measure') {
                icon.textContent = 'straighten';
                text.textContent = '2点計測';
                ind.classList.add('measure-mode');
                document.getElementById('measurePanel').classList.add('active');
            }
            
            closeSidePanel();
        }
        
        function clearTool() {
            currentTool = null;
            document.getElementById('modeIndicator').className = 'mode-indicator';
            document.getElementById('hosePanel').classList.remove('active');
            document.getElementById('measurePanel').classList.remove('active');
        }
        
        // ホース
        var hosePoints = [];
        var hoseMarkers = [];
        var hoseSegments = [];
        
        function addHosePoint(lon, lat, cartesian) {
            hosePoints.push({ lon: lon, lat: lat, cartesian: cartesian });
            var m = viewer.entities.add({
                position: cartesian,
                point: { pixelSize: 10, color: Cesium.Color.ORANGE, outlineColor: Cesium.Color.WHITE, outlineWidth: 2 }
            });
            hoseMarkers.push(m);
            
            if (hosePoints.length >= 2) {
                var s = viewer.entities.add({
                    polyline: {
                        positions: [hosePoints[hosePoints.length - 2].cartesian, cartesian],
                        width: 5,
                        material: Cesium.Color.ORANGE,
                        clampToGround: true
                    }
                });
                hoseSegments.push(s);
            }
            updateHoseDisplay();
        }
        
        function updateHoseDisplay() {
            var total = 0;
            for (var i = 1; i < hosePoints.length; i++) {
                var p1 = hosePoints[i - 1], p2 = hosePoints[i];
                total += new Cesium.EllipsoidGeodesic(
                    Cesium.Cartographic.fromDegrees(p1.lon, p1.lat),
                    Cesium.Cartographic.fromDegrees(p2.lon, p2.lat)
                ).surfaceDistance;
            }
            document.getElementById('hoseTotalDist').textContent = total >= 1000 ? (total / 1000).toFixed(2) + 'km' : total.toFixed(0) + 'm';
            document.getElementById('hoseTotalCount').textContent = Math.ceil(total / 20) + '本';
        }
        
        function resetHose() {
            hosePoints = [];
            hoseMarkers.forEach(function(m) { viewer.entities.remove(m); });
            hoseMarkers = [];
            hoseSegments.forEach(function(s) { viewer.entities.remove(s); });
            hoseSegments = [];
            updateHoseDisplay();
        }
        
        // 計測
        var measurePts = [];
        var measureMks = [];
        var measureLn = null;
        
        function addMeasurePt(lon, lat, h, cartesian) {
            if (measurePts.length >= 2) resetMeasure();
            measurePts.push({ lon: lon, lat: lat, h: h, cartesian: cartesian });
            var m = viewer.entities.add({
                position: cartesian,
                point: { pixelSize: 12, color: Cesium.Color.CYAN, outlineColor: Cesium.Color.WHITE, outlineWidth: 2 }
            });
            measureMks.push(m);
            
            if (measurePts.length === 2) {
                measureLn = viewer.entities.add({
                    polyline: {
                        positions: [measurePts[0].cartesian, measurePts[1].cartesian],
                        width: 4,
                        material: Cesium.Color.CYAN,
                        clampToGround: true
                    }
                });
                var p1 = measurePts[0], p2 = measurePts[1];
                var dist = new Cesium.EllipsoidGeodesic(
                    Cesium.Cartographic.fromDegrees(p1.lon, p1.lat),
                    Cesium.Cartographic.fromDegrees(p2.lon, p2.lat)
                ).surfaceDistance;
                var diff = p2.h - p1.h;
                document.getElementById('measureDistance').textContent = dist >= 1000 ? (dist / 1000).toFixed(2) + 'km' : dist.toFixed(0) + 'm';
                document.getElementById('measureElev').textContent = (diff >= 0 ? '+' : '') + diff.toFixed(1) + 'm';
                document.getElementById('measureHint').textContent = '計測完了';
            }
        }
        
        function resetMeasure() {
            measurePts = [];
            measureMks.forEach(function(m) { viewer.entities.remove(m); });
            measureMks = [];
            if (measureLn) { viewer.entities.remove(measureLn); measureLn = null; }
            document.getElementById('measureDistance').textContent = '-';
            document.getElementById('measureElev').textContent = '-';
            document.getElementById('measureHint').textContent = '2点をタップして計測';
        }
        
        // 現在地
        function goToMyLocation() {
            if (!navigator.geolocation) {
                document.getElementById('myLocationText').textContent = '非対応';
                return;
            }
            navigator.geolocation.getCurrentPosition(function(pos) {
                var lat = pos.coords.latitude, lon = pos.coords.longitude;
                document.getElementById('myLocationText').textContent = lat.toFixed(5) + ', ' + lon.toFixed(5);
                viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(lon, lat, 1000), duration: 1.5 });
            }, function() {
                document.getElementById('myLocationText').textContent = '取得失敗';
            });
        }
        goToMyLocation();
        
        // Toast
        function showToast(msg) {
            var t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(function() { t.classList.remove('show'); }, 2000);
        }
        
        // 2D/3D
        function setViewMode(mode) {
            if (mode === '2d') {
                viewer.scene.mode = Cesium.SceneMode.SCENE2D;
                document.getElementById('view2dBtn').classList.add('active');
                document.getElementById('view3dBtn').classList.remove('active');
            } else {
                viewer.scene.mode = Cesium.SceneMode.SCENE3D;
                document.getElementById('view2dBtn').classList.remove('active');
                document.getElementById('view3dBtn').classList.add('active');
            }
        }
        
        // 座標表示
        viewer.camera.moveEnd.addEventListener(function() {
            var c = viewer.camera.positionCartographic;
            document.getElementById('coordDisplay').textContent = 
                Cesium.Math.toDegrees(c.latitude).toFixed(5) + ', ' + Cesium.Math.toDegrees(c.longitude).toFixed(5);
        });
        
        // クリック
        var handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        handler.setInputAction(function(click) {
            var ray = viewer.camera.getPickRay(click.position);
            var cartesian = viewer.scene.globe.pick(ray, viewer.scene);
            if (!cartesian) return;
            
            var carto = Cesium.Cartographic.fromCartesian(cartesian);
            var lon = Cesium.Math.toDegrees(carto.longitude);
            var lat = Cesium.Math.toDegrees(carto.latitude);
            var h = carto.height || 0;
            
            if (currentTool === 'fire') {
                viewer.entities.add({ position: cartesian, point: { pixelSize: 16, color: Cesium.Color.RED, outlineColor: Cesium.Color.WHITE, outlineWidth: 2 } });
                showToast('火点を追加');
            } else if (currentTool === 'water') {
                viewer.entities.add({ position: cartesian, point: { pixelSize: 14, color: Cesium.Color.BLUE, outlineColor: Cesium.Color.WHITE, outlineWidth: 2 } });
                showToast('水利を追加');
            } else if (currentTool === 'hose') {
                addHosePoint(lon, lat, cartesian);
            } else if (currentTool === 'measure') {
                addMeasurePt(lon, lat, h, cartesian);
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        
        // イベントリスナー
        document.getElementById('menuBtn').addEventListener('click', function() {
            console.log('Menu button clicked');
            openSidePanel();
        });
        document.getElementById('sidePanelOverlay').addEventListener('click', closeSidePanel);
        document.getElementById('sidePanelClose').addEventListener('click', closeSidePanel);
        document.getElementById('mapBtnSatellite').addEventListener('click', function() { setBasemap('satellite'); });
        document.getElementById('mapBtnStd').addEventListener('click', function() { setBasemap('std'); });
        document.getElementById('layerBuildings').addEventListener('click', function() {
            layers.buildings = !layers.buildings;
            if (osmBuildingsTileset) osmBuildingsTileset.show = layers.buildings;
            document.getElementById('layerBuildings').classList.toggle('active', layers.buildings);
        });
        document.getElementById('layerFlood').addEventListener('click', function() { toggleHazardLayer('flood'); });
        document.getElementById('layerTsunami').addEventListener('click', function() { toggleHazardLayer('tsunami'); });
        document.getElementById('layerLandslide').addEventListener('click', function() { toggleHazardLayer('landslide'); });
        document.getElementById('opFire').addEventListener('click', function() { setOperation('fire'); });
        document.getElementById('opWater').addEventListener('click', function() { setOperation('water'); });
        document.getElementById('opHose').addEventListener('click', function() { setOperation('hose'); });
        document.getElementById('opMeasure').addEventListener('click', function() { setOperation('measure'); });
        document.getElementById('hosePanelClose').addEventListener('click', function() { clearTool(); resetHose(); });
        document.getElementById('measurePanelClose').addEventListener('click', function() { clearTool(); resetMeasure(); });
        document.getElementById('undoHoseBtn').addEventListener('click', function() {
            if (hosePoints.length > 0) {
                hosePoints.pop();
                if (hoseMarkers.length > 0) viewer.entities.remove(hoseMarkers.pop());
                if (hoseSegments.length > 0) viewer.entities.remove(hoseSegments.pop());
                updateHoseDisplay();
            }
        });
        document.getElementById('resetHoseBtn').addEventListener('click', resetHose);
        document.getElementById('confirmHoseBtn').addEventListener('click', function() {
            if (hosePoints.length >= 2) {
                showToast('ホース経路を確定');
                clearTool();
            } else {
                showToast('2点以上必要');
            }
        });
        document.getElementById('resetMeasureBtn').addEventListener('click', resetMeasure);
        document.getElementById('myLocationBtn').addEventListener('click', goToMyLocation);
        document.getElementById('view2dBtn').addEventListener('click', function() { setViewMode('2d'); });
        document.getElementById('view3dBtn').addEventListener('click', function() { setViewMode('3d'); });
        
        console.log('GIS Platform initialized successfully');
    })();
    </script>
</body>
</html>
