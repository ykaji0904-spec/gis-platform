<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIS Platform - HardSkill OS</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans JP', sans-serif; overflow: hidden; background: #0a0a0a; }
        #cesiumContainer { width: 100vw; height: 100vh; }

        .top-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 52px;
            background: rgba(10, 10, 10, 0.92); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 12px; z-index: 1000;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon {
            width: 28px; height: 28px;
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
        }
        .logo-icon .material-icons { color: white; font-size: 18px; }
        .logo-text { color: white; font-weight: 700; font-size: 16px; }

        .top-controls { display: flex; gap: 6px; align-items: center; }
        
        .quick-toggle {
            display: flex; align-items: center; gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 6px 10px; border-radius: 16px;
            cursor: pointer; transition: all 0.2s;
            color: rgba(255, 255, 255, 0.5); font-size: 11px;
        }
        .quick-toggle:hover { background: rgba(255, 255, 255, 0.1); }
        .quick-toggle.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff; color: #00d4ff;
        }
        .quick-toggle .material-icons { font-size: 14px; }

        .user-section { display: flex; align-items: center; gap: 10px; }
        .status-indicator { display: flex; align-items: center; gap: 4px; color: #4ade80; font-size: 10px; }
        .status-dot { width: 6px; height: 6px; background: #4ade80; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .avatar {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, #ff6b6b, #ffa06b);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 600; font-size: 12px; cursor: pointer;
        }

        .left-panel {
            position: fixed; top: 64px; left: 12px; width: 240px;
            background: rgba(10, 10, 10, 0.92); backdrop-filter: blur(20px);
            border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 900; display: none; max-height: calc(100vh - 140px); overflow-y: auto;
        }
        .left-panel.show { display: block; }
        .panel-section { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .panel-section:last-child { border-bottom: none; }
        .section-title { color: rgba(255,255,255,0.4); font-size: 9px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        
        .layer-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px; border-radius: 6px; margin-bottom: 4px;
            cursor: pointer; transition: all 0.2s;
        }
        .layer-item:hover { background: rgba(255,255,255,0.05); }
        .layer-info { display: flex; align-items: center; gap: 8px; }
        .layer-icon { 
            width: 24px; height: 24px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center; font-size: 12px;
        }
        .layer-icon.terrain { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
        .layer-icon.building { background: rgba(33, 150, 243, 0.2); color: #2196f3; }
        .layer-icon.map { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .layer-icon.fire { background: rgba(244, 67, 54, 0.2); color: #f44336; }
        .layer-icon.water { background: rgba(33, 150, 243, 0.2); color: #2196f3; }
        .layer-icon.trail { background: rgba(139, 195, 74, 0.2); color: #8bc34a; }
        .layer-icon.hose { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
        .layer-name { color: white; font-size: 11px; }
        .layer-toggle {
            width: 32px; height: 18px; border-radius: 9px;
            background: rgba(255,255,255,0.1); position: relative; cursor: pointer; transition: all 0.2s;
        }
        .layer-toggle.on { background: #00d4ff; }
        .layer-toggle::after {
            content: ''; position: absolute; width: 14px; height: 14px;
            background: white; border-radius: 50%; top: 2px; left: 2px; transition: all 0.2s;
        }
        .layer-toggle.on::after { left: 16px; }

        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 12px; z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
        }

        .my-location {
            display: flex; align-items: center; gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px; border-radius: 8px; min-width: 160px; cursor: pointer;
        }
        .my-location .material-icons { color: #4ade80; font-size: 18px; }
        .my-location-text { display: flex; flex-direction: column; }
        .my-location-label { color: rgba(255,255,255,0.5); font-size: 9px; }
        .my-location-coords { color: white; font-size: 11px; font-family: monospace; }

        .tools-group { display: flex; gap: 4px; align-items: center; }
        .tool-btn {
            width: 40px; height: 40px;
            background: rgba(255, 255, 255, 0.05); border: none; border-radius: 8px;
            color: rgba(255, 255, 255, 0.6); cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .tool-btn:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .tool-btn.active { background: rgba(0, 212, 255, 0.2); color: #00d4ff; }
        .tool-btn.fire-mode { background: rgba(244, 67, 54, 0.2); color: #f44336; }
        .tool-btn.water-mode { background: rgba(33, 150, 243, 0.2); color: #2196f3; }
        .tool-btn.hose-mode { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
        .tool-btn.measure-mode { background: rgba(0, 212, 255, 0.2); color: #00d4ff; }
        .tool-btn .material-icons { font-size: 18px; }
        .tool-divider { width: 1px; height: 24px; background: rgba(255, 255, 255, 0.1); margin: 0 4px; }

        .view-toggle {
            display: flex; background: rgba(255, 255, 255, 0.05); border-radius: 6px; overflow: hidden;
        }
        .view-btn {
            padding: 8px 12px; border: none; background: transparent; color: rgba(255,255,255,0.5);
            cursor: pointer; transition: all 0.2s; font-size: 11px;
            display: flex; align-items: center; gap: 4px;
        }
        .view-btn:hover { background: rgba(255,255,255,0.05); }
        .view-btn.active { background: rgba(0, 212, 255, 0.2); color: #00d4ff; }
        .view-btn .material-icons { font-size: 14px; }

        .info-panel {
            position: fixed; top: 64px; right: 12px; width: 260px;
            background: rgba(10, 10, 10, 0.92); backdrop-filter: blur(20px);
            border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 900; display: none;
        }
        .info-panel.show { display: block; }
        .info-panel.fire { border-color: rgba(244, 67, 54, 0.3); }
        .info-panel.water { border-color: rgba(33, 150, 243, 0.3); }
        .panel-header {
            padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: space-between;
        }
        .panel-title { font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .panel-title.fire { color: #f44336; }
        .panel-title.water { color: #2196f3; }
        .panel-close { background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; }
        .panel-content { padding: 12px; }
        .info-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: rgba(255,255,255,0.5); font-size: 10px; }
        .info-value { color: white; font-size: 11px; font-family: monospace; }
        .panel-actions { display: flex; gap: 6px; margin-top: 12px; flex-wrap: wrap; }
        .action-btn {
            flex: 1; min-width: 70px; padding: 8px; border: none; border-radius: 6px;
            font-size: 10px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 4px;
        }
        .action-btn.primary { background: #2196f3; color: white; }
        .action-btn.danger { background: #f44336; color: white; }
        .action-btn.secondary { background: rgba(255,255,255,0.1); color: white; }
        .action-btn.warning { background: #ff9800; color: white; }

        .water-list { max-height: 150px; overflow-y: auto; margin-top: 8px; }
        .water-item {
            display: flex; align-items: center; gap: 8px;
            padding: 8px; border-radius: 6px; margin-bottom: 4px;
            background: rgba(255,255,255,0.03); cursor: pointer; transition: all 0.2s;
        }
        .water-item:hover { background: rgba(33, 150, 243, 0.1); }
        .water-item-icon {
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 12px;
        }
        .water-item-icon.hydrant { background: rgba(244, 67, 54, 0.2); color: #f44336; }
        .water-item-icon.tank { background: rgba(33, 150, 243, 0.2); color: #2196f3; }
        .water-item-icon.natural { background: rgba(0, 188, 212, 0.2); color: #00bcd4; }
        .water-item-info { flex: 1; }
        .water-item-name { color: white; font-size: 11px; }
        .water-item-dist { color: rgba(255,255,255,0.5); font-size: 10px; }

        .mode-indicator {
            position: fixed; top: 64px; left: 50%; transform: translateX(-50%);
            background: rgba(244, 67, 54, 0.9); backdrop-filter: blur(10px);
            padding: 8px 16px; border-radius: 20px;
            display: none; align-items: center; gap: 8px; z-index: 1000;
        }
        .mode-indicator.show { display: flex; }
        .mode-indicator.water-mode { background: rgba(33, 150, 243, 0.9); }
        .mode-indicator.hose-mode { background: rgba(255, 152, 0, 0.9); }
        .mode-indicator.measure-mode { background: rgba(0, 212, 255, 0.9); }
        .mode-indicator .material-icons { color: white; font-size: 16px; }
        .mode-indicator span { color: white; font-size: 12px; font-weight: 500; }

        /* Hose Line Panel */
        .hose-panel {
            position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%);
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px);
            padding: 14px 20px; border-radius: 12px;
            border: 1px solid rgba(255, 152, 0, 0.3); z-index: 900;
            min-width: 300px; display: none;
        }
        .hose-panel.active { display: block; }
        .hose-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .hose-title { color: #ff9800; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .hose-close { background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 16px; }
        .hose-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .hose-stat { background: rgba(255,255,255,0.03); padding: 8px; border-radius: 6px; }
        .hose-stat-label { color: rgba(255,255,255,0.5); font-size: 9px; margin-bottom: 2px; }
        .hose-stat-value { color: white; font-size: 14px; font-weight: 600; font-family: monospace; }
        .hose-stat-value.highlight { color: #ff9800; }
        .hose-hint { color: rgba(255,255,255,0.4); font-size: 10px; text-align: center; margin-top: 10px; }
        .hose-actions { display: flex; gap: 6px; margin-top: 10px; }
        .hose-btn { flex: 1; padding: 8px; border: none; border-radius: 6px; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .hose-btn.primary { background: #ff9800; color: #000; }
        .hose-btn.secondary { background: rgba(255,255,255,0.1); color: white; }
        .hose-btn.danger { background: rgba(244,67,54,0.8); color: white; }

        /* Measure Panel */
        .measure-panel {
            position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%);
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px);
            padding: 14px 20px; border-radius: 12px;
            border: 1px solid rgba(0, 212, 255, 0.3); z-index: 900;
            min-width: 260px; display: none;
        }
        .measure-panel.active { display: block; }
        .measure-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .measure-title { color: #00d4ff; font-size: 11px; font-weight: 600; }
        .measure-close { background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 16px; }
        .measure-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
        .measure-label { color: rgba(255,255,255,0.5); font-size: 11px; }
        .measure-value { color: white; font-size: 13px; font-weight: 600; font-family: monospace; }
        .measure-value.highlight { color: #00d4ff; font-size: 16px; }
        .measure-hint { color: rgba(255,255,255,0.4); font-size: 10px; text-align: center; margin-top: 10px; }
        .measure-actions { display: flex; gap: 6px; margin-top: 10px; }
        .measure-btn { flex: 1; padding: 6px; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; }
        .measure-btn.primary { background: #00d4ff; color: #000; }
        .measure-btn.secondary { background: rgba(255,255,255,0.1); color: white; }

        .loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(10,10,10,0.9); padding: 16px 24px; border-radius: 8px;
            color: white; font-size: 12px; display: none; z-index: 2000;
        }
        .loading.show { display: block; }

        .cesium-viewer-toolbar, .cesium-viewer-animationContainer,
        .cesium-viewer-timelineContainer, .cesium-viewer-fullscreenContainer,
        .cesium-viewer-bottom { display: none !important; }

        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

        @media (max-width: 600px) {
            .logo-text { display: none; }
            .quick-toggle span:not(.material-icons) { display: none; }
            .quick-toggle { padding: 6px; }
            .my-location { min-width: auto; padding: 6px 8px; }
            .my-location-label { display: none; }
            .left-panel, .info-panel { width: 220px; }
            .hose-panel, .measure-panel { min-width: 280px; }
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div class="loading" id="loading">読み込み中...</div>

    <div class="top-bar">
        <div class="logo">
            <div class="logo-icon"><span class="material-icons">public</span></div>
            <span class="logo-text">GIS Platform</span>
        </div>
        <div class="top-controls">
            <div class="quick-toggle active" onclick="toggleQuickLayer(this, 'terrain')">
                <span class="material-icons">terrain</span><span>地形</span>
            </div>
            <div class="quick-toggle active" onclick="toggleQuickLayer(this, 'buildings')">
                <span class="material-icons">location_city</span><span>建物</span>
            </div>
            <div class="quick-toggle" onclick="toggleQuickLayer(this, 'gsimap')">
                <span class="material-icons">map</span><span>地図</span>
            </div>
            <div class="quick-toggle" onclick="toggleQuickLayer(this, 'trails')">
                <span class="material-icons">hiking</span><span>道</span>
            </div>
        </div>
        <div class="user-section">
            <div class="status-indicator"><div class="status-dot"></div><span>接続中</span></div>
            <div class="avatar">K</div>
        </div>
    </div>

    <div class="mode-indicator" id="modeIndicator">
        <span class="material-icons" id="modeIcon">local_fire_department</span>
        <span id="modeText">火点追加モード</span>
    </div>

    <div class="left-panel" id="layerPanel">
        <div class="panel-section">
            <div class="section-title">Truth Layer</div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'terrain')">
                <div class="layer-info">
                    <div class="layer-icon terrain"><span class="material-icons">terrain</span></div>
                    <span class="layer-name">Cesium World Terrain</span>
                </div>
                <div class="layer-toggle on" id="toggle-terrain"></div>
            </div>
        </div>
        <div class="panel-section">
            <div class="section-title">Reference Layer</div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'buildings')">
                <div class="layer-info">
                    <div class="layer-icon building"><span class="material-icons">location_city</span></div>
                    <span class="layer-name">PLATEAU 3D建物</span>
                </div>
                <div class="layer-toggle on" id="toggle-buildings"></div>
            </div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'gsimap')">
                <div class="layer-info">
                    <div class="layer-icon map"><span class="material-icons">map</span></div>
                    <span class="layer-name">国土地理院地図</span>
                </div>
                <div class="layer-toggle" id="toggle-gsimap"></div>
            </div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'trails')">
                <div class="layer-info">
                    <div class="layer-icon trail"><span class="material-icons">hiking</span></div>
                    <span class="layer-name">登山道・歩道</span>
                </div>
                <div class="layer-toggle" id="toggle-trails"></div>
            </div>
        </div>
        <div class="panel-section">
            <div class="section-title">Operation Layer</div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'firepoints')">
                <div class="layer-info">
                    <div class="layer-icon fire"><span class="material-icons">local_fire_department</span></div>
                    <span class="layer-name">火点</span>
                </div>
                <div class="layer-toggle on" id="toggle-firepoints"></div>
            </div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'firearea')">
                <div class="layer-info">
                    <div class="layer-icon fire"><span class="material-icons">pentagon</span></div>
                    <span class="layer-name">火点範囲</span>
                </div>
                <div class="layer-toggle on" id="toggle-firearea"></div>
            </div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'water')">
                <div class="layer-info">
                    <div class="layer-icon water"><span class="material-icons">water_drop</span></div>
                    <span class="layer-name">水利</span>
                </div>
                <div class="layer-toggle on" id="toggle-water"></div>
            </div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'hose')">
                <div class="layer-info">
                    <div class="layer-icon hose"><span class="material-icons">route</span></div>
                    <span class="layer-name">ホース経路</span>
                </div>
                <div class="layer-toggle on" id="toggle-hose"></div>
            </div>
        </div>
    </div>

    <!-- Fire Panel -->
    <div class="info-panel fire" id="firePanel">
        <div class="panel-header">
            <span class="panel-title fire"><span class="material-icons">local_fire_department</span>火点情報</span>
            <button class="panel-close" onclick="closePanel('fire')"><span class="material-icons">close</span></button>
        </div>
        <div class="panel-content">
            <div class="info-row"><span class="info-label">緯度</span><span class="info-value" id="fireLat">-</span></div>
            <div class="info-row"><span class="info-label">経度</span><span class="info-value" id="fireLon">-</span></div>
            <div class="info-row"><span class="info-label">標高</span><span class="info-value" id="fireElev">-</span></div>
            <div class="section-title" style="margin-top:12px;">周辺水利</div>
            <div class="water-list" id="nearbyWaterList"></div>
            <div class="panel-actions">
                <button class="action-btn secondary" onclick="flyToSelectedFire()"><span class="material-icons">flight</span>移動</button>
                <button class="action-btn warning" onclick="updateFireArea()"><span class="material-icons">pentagon</span>範囲</button>
                <button class="action-btn danger" onclick="deleteSelectedFire()"><span class="material-icons">delete</span>削除</button>
            </div>
        </div>
    </div>

    <!-- Water Panel -->
    <div class="info-panel water" id="waterPanel">
        <div class="panel-header">
            <span class="panel-title water"><span class="material-icons">water_drop</span>水利情報</span>
            <button class="panel-close" onclick="closePanel('water')"><span class="material-icons">close</span></button>
        </div>
        <div class="panel-content">
            <div class="info-row"><span class="info-label">種別</span><span class="info-value" id="waterType">-</span></div>
            <div class="info-row"><span class="info-label">緯度</span><span class="info-value" id="waterLat">-</span></div>
            <div class="info-row"><span class="info-label">経度</span><span class="info-value" id="waterLon">-</span></div>
            <div class="info-row"><span class="info-label">火点距離</span><span class="info-value" id="waterDist">-</span></div>
            <div class="panel-actions">
                <button class="action-btn secondary" onclick="flyToSelectedWater()"><span class="material-icons">flight</span>移動</button>
                <button class="action-btn danger" onclick="deleteSelectedWater()"><span class="material-icons">delete</span>削除</button>
            </div>
        </div>
    </div>

    <!-- Hose Line Panel (連続描画) -->
    <div class="hose-panel" id="hosePanel">
        <div class="hose-header">
            <span class="hose-title"><span class="material-icons">route</span>ホース延長ライン</span>
            <button class="hose-close" onclick="closeHosePanel()">×</button>
        </div>
        <div class="hose-stats">
            <div class="hose-stat">
                <div class="hose-stat-label">総延長</div>
                <div class="hose-stat-value highlight" id="hoseTotalDist">0 m</div>
            </div>
            <div class="hose-stat">
                <div class="hose-stat-label">ホース本数(20m)</div>
                <div class="hose-stat-value" id="hoseTotalCount">0 本</div>
            </div>
            <div class="hose-stat">
                <div class="hose-stat-label">累積高低差</div>
                <div class="hose-stat-value" id="hoseTotalElev">0 m</div>
            </div>
            <div class="hose-stat">
                <div class="hose-stat-label">ポイント数</div>
                <div class="hose-stat-value" id="hosePointCount">0</div>
            </div>
        </div>
        <div class="hose-hint" id="hoseHint">地図をタップしてポイントを追加<br>連続でタップするとラインが繋がります</div>
        <div class="hose-actions">
            <button class="hose-btn secondary" onclick="undoHosePoint()"><span class="material-icons">undo</span>戻す</button>
            <button class="hose-btn danger" onclick="resetHoseLine()"><span class="material-icons">delete</span>クリア</button>
            <button class="hose-btn primary" onclick="confirmHoseLine()"><span class="material-icons">check</span>確定</button>
        </div>
    </div>

    <!-- Measure Panel (2点間計測) -->
    <div class="measure-panel" id="measurePanel">
        <div class="measure-header">
            <span class="measure-title">2点間計測</span>
            <button class="measure-close" onclick="closeMeasurePanel()">×</button>
        </div>
        <div class="measure-row"><span class="measure-label">水平距離</span><span class="measure-value highlight" id="measureDistance">- m</span></div>
        <div class="measure-row"><span class="measure-label">高低差</span><span class="measure-value" id="measureElevation">- m</span></div>
        <div class="measure-row"><span class="measure-label">始点標高</span><span class="measure-value" id="measureStart">- m</span></div>
        <div class="measure-row"><span class="measure-label">終点標高</span><span class="measure-value" id="measureEnd">- m</span></div>
        <div class="measure-hint" id="measureHint">2点をタップして計測</div>
        <div class="measure-actions">
            <button class="measure-btn secondary" onclick="resetMeasure()">リセット</button>
            <button class="measure-btn primary" onclick="closeMeasurePanel()">完了</button>
        </div>
    </div>

    <div class="bottom-bar">
        <div class="my-location" onclick="flyToMyLocation()">
            <span class="material-icons">my_location</span>
            <div class="my-location-text">
                <span class="my-location-label">現在地</span>
                <span class="my-location-coords" id="myCoords">取得中...</span>
            </div>
        </div>
        <div class="tools-group">
            <button class="tool-btn" title="レイヤー" onclick="toggleLayerPanel()"><span class="material-icons">layers</span></button>
            <div class="tool-divider"></div>
            <button class="tool-btn" title="火点追加" onclick="setTool('fire')" id="fireToolBtn"><span class="material-icons">local_fire_department</span></button>
            <button class="tool-btn" title="水利追加" onclick="setTool('water')" id="waterToolBtn"><span class="material-icons">water_drop</span></button>
            <div class="tool-divider"></div>
            <button class="tool-btn" title="ホース延長" onclick="setTool('hose')" id="hoseToolBtn"><span class="material-icons">route</span></button>
            <button class="tool-btn" title="2点計測" onclick="setTool('measure')" id="measureToolBtn"><span class="material-icons">straighten</span></button>
            <div class="tool-divider"></div>
            <button class="tool-btn" title="共有" onclick="shareView()"><span class="material-icons">share</span></button>
        </div>
        <div class="view-toggle">
            <button class="view-btn" onclick="setViewMode('2d')"><span class="material-icons">map</span> 2D</button>
            <button class="view-btn active" onclick="setViewMode('3d')"><span class="material-icons">view_in_ar</span> 3D</button>
        </div>
    </div>

    <script>
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIwM2NhOTIxMi03NzRmLTQzMDgtYTMzZS1kOWEyMjBmNjhhMmEiLCJpZCI6Mzg1NDQ0LCJpYXQiOjE3Njk4Mzg4NTl9.ElD_8Qq0Mp1QuoaQvnODwTCVtEfaQtuDrsS9tnwlryA';

        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrain: Cesium.Terrain.fromWorldTerrain(),
            timeline: false, animation: false, baseLayerPicker: false,
            geocoder: false, homeButton: false, sceneModePicker: false,
            navigationHelpButton: false, fullscreenButton: false,
            infoBox: false, selectionIndicator: false
        });

        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(132.4553, 34.3853, 5000),
            orientation: { heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0 },
            duration: 0
        });

        // ========== LAYER STATE ==========
        const layers = {
            terrain: true, buildings: true, gsimap: false, satellite: true,
            trails: false, firepoints: true, firearea: true, water: true, hose: true
        };

        let plateauTileset = null;
        let gsiLayer = null;
        let trailEntities = [];
        let fireAreaEntity = null;

        // ========== PLATEAU ==========
        async function loadPlateauBuildings() {
            try {
                plateauTileset = await Cesium.Cesium3DTileset.fromIonAssetId(2602291);
                viewer.scene.primitives.add(plateauTileset);
            } catch (e) { console.error('PLATEAU error:', e); }
        }
        loadPlateauBuildings();

        // ========== GSI MAP ==========
        function initGsiLayer() {
            gsiLayer = viewer.imageryLayers.addImageryProvider(
                new Cesium.UrlTemplateImageryProvider({
                    url: 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
                    maximumLevel: 18, credit: '国土地理院'
                })
            );
            gsiLayer.alpha = 0.7;
            gsiLayer.show = false;
        }
        initGsiLayer();

        // ========== LAYER TOGGLE ==========
        function toggleQuickLayer(el, layer) {
            el.classList.toggle('active');
            layers[layer] = el.classList.contains('active');
            applyLayerState(layer);
            syncLayerToggle(layer);
        }

        function toggleLayerItem(el, layer) {
            const toggle = el.querySelector('.layer-toggle');
            toggle.classList.toggle('on');
            layers[layer] = toggle.classList.contains('on');
            applyLayerState(layer);
        }

        function syncLayerToggle(layer) {
            const toggle = document.getElementById(`toggle-${layer}`);
            if (toggle) toggle.classList.toggle('on', layers[layer]);
        }

        function applyLayerState(layer) {
            switch(layer) {
                case 'terrain':
                    viewer.scene.terrainProvider = layers.terrain 
                        ? Cesium.Terrain.fromWorldTerrain()
                        : new Cesium.EllipsoidTerrainProvider();
                    break;
                case 'buildings': if (plateauTileset) plateauTileset.show = layers.buildings; break;
                case 'gsimap': if (gsiLayer) gsiLayer.show = layers.gsimap; break;
                case 'trails':
                    trailEntities.forEach(e => e.show = layers.trails);
                    if (layers.trails && trailEntities.length === 0) loadTrailsNearView();
                    break;
                case 'firepoints': firePointEntities.forEach(e => e.show = layers.firepoints); break;
                case 'firearea': if (fireAreaEntity) fireAreaEntity.show = layers.firearea; break;
                case 'water': waterEntities.forEach(e => e.show = layers.water); break;
                case 'hose': hoseLineEntities.forEach(e => e.show = layers.hose); break;
            }
        }

        function toggleLayerPanel() { document.getElementById('layerPanel').classList.toggle('show'); }

        // ========== OSM TRAILS ==========
        async function loadTrailsNearView() {
            const cam = viewer.camera.positionCartographic;
            await loadTrails(Cesium.Math.toDegrees(cam.latitude), Cesium.Math.toDegrees(cam.longitude), 2000);
        }

        async function loadTrails(lat, lon, radius) {
            showLoading(true);
            const query = `[out:json][timeout:25];(way["highway"~"path|footway|track"](around:${radius},${lat},${lon}););out body;>;out skel qt;`;
            try {
                const res = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: 'data=' + encodeURIComponent(query) });
                const data = await res.json();
                trailEntities.forEach(e => viewer.entities.remove(e));
                trailEntities = [];
                const nodes = {};
                data.elements.filter(e => e.type === 'node').forEach(n => nodes[n.id] = [n.lon, n.lat]);
                data.elements.filter(e => e.type === 'way').forEach(way => {
                    const positions = way.nodes.filter(nid => nodes[nid]).map(nid => Cesium.Cartesian3.fromDegrees(nodes[nid][0], nodes[nid][1]));
                    if (positions.length >= 2) {
                        const entity = viewer.entities.add({ polyline: { positions, width: 3, material: Cesium.Color.LIGHTGREEN.withAlpha(0.8), clampToGround: true } });
                        entity.show = layers.trails;
                        trailEntities.push(entity);
                    }
                });
            } catch (e) { console.error('Trail error:', e); }
            showLoading(false);
        }

        // ========== FIRE POINTS ==========
        let firePoints = [];
        let firePointEntities = [];
        let selectedFirePoint = null;
        let firePointIdCounter = 0;

        function addFirePoint(lon, lat, height) {
            const id = `fire-${++firePointIdCounter}`;
            const feature = { type: 'Feature', id, geometry: { type: 'Point', coordinates: [lon, lat, height] }, properties: { timestamp: new Date().toLocaleString('ja-JP') } };
            firePoints.push(feature);
            const entity = viewer.entities.add({
                id, position: Cesium.Cartesian3.fromDegrees(lon, lat, height),
                billboard: { image: createFireIcon(), width: 32, height: 32, verticalOrigin: Cesium.VerticalOrigin.BOTTOM, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND }
            });
            firePointEntities.push(entity);
            updateFireArea();
            return feature;
        }

        function createFireIcon() {
            const c = document.createElement('canvas'); c.width = 32; c.height = 32;
            const ctx = c.getContext('2d');
            ctx.beginPath(); ctx.arc(16, 16, 14, 0, Math.PI * 2); ctx.fillStyle = 'rgba(244,67,54,0.3)'; ctx.fill();
            ctx.beginPath(); ctx.arc(16, 16, 10, 0, Math.PI * 2); ctx.fillStyle = '#f44336'; ctx.fill();
            ctx.beginPath(); ctx.arc(16, 16, 5, 0, Math.PI * 2); ctx.fillStyle = '#ffeb3b'; ctx.fill();
            return c.toDataURL();
        }

        function selectFirePoint(id) {
            const feature = firePoints.find(f => f.id === id);
            if (!feature) return;
            selectedFirePoint = feature;
            const c = feature.geometry.coordinates;
            document.getElementById('fireLat').textContent = c[1].toFixed(6) + '°';
            document.getElementById('fireLon').textContent = c[0].toFixed(6) + '°';
            document.getElementById('fireElev').textContent = (c[2] || 0).toFixed(1) + ' m';
            document.getElementById('firePanel').classList.add('show');
            document.getElementById('waterPanel').classList.remove('show');
            updateNearbyWaterList(c[0], c[1]);
        }

        function updateNearbyWaterList(fireLon, fireLat) {
            const list = document.getElementById('nearbyWaterList');
            if (waterSources.length === 0) { list.innerHTML = '<div style="color:rgba(255,255,255,0.4);font-size:10px;text-align:center;padding:8px;">水利なし</div>'; return; }
            const withDist = waterSources.map(w => ({ ...w, distance: haversineDistance(fireLat, fireLon, w.lat, w.lon) })).sort((a, b) => a.distance - b.distance).slice(0, 5);
            list.innerHTML = withDist.map(w => `<div class="water-item" onclick="selectWater('${w.id}')"><div class="water-item-icon ${w.type}">${w.type === 'hydrant' ? 'H' : w.type === 'tank' ? 'T' : 'N'}</div><div class="water-item-info"><div class="water-item-name">${w.name}</div><div class="water-item-dist">${formatDistance(w.distance)}</div></div></div>`).join('');
        }

        function updateFireArea() {
            if (fireAreaEntity) { viewer.entities.remove(fireAreaEntity); fireAreaEntity = null; }
            if (firePoints.length < 3) return;
            const coords = firePoints.map(f => f.geometry.coordinates);
            const hull = convexHull(coords);
            if (hull.length < 3) return;
            const positions = hull.map(c => Cesium.Cartesian3.fromDegrees(c[0], c[1]));
            fireAreaEntity = viewer.entities.add({
                polygon: { hierarchy: positions, material: Cesium.Color.RED.withAlpha(0.2), outline: true, outlineColor: Cesium.Color.RED, outlineWidth: 2, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND }
            });
            fireAreaEntity.show = layers.firearea;
        }

        function convexHull(points) {
            if (points.length < 3) return points;
            const sorted = [...points].sort((a, b) => a[0] - b[0] || a[1] - b[1]);
            const cross = (o, a, b) => (a[0] - o[0]) * (b[1] - o[1]) - (a[1] - o[1]) * (b[0] - o[0]);
            const lower = []; for (const p of sorted) { while (lower.length >= 2 && cross(lower[lower.length - 2], lower[lower.length - 1], p) <= 0) lower.pop(); lower.push(p); }
            const upper = []; for (let i = sorted.length - 1; i >= 0; i--) { const p = sorted[i]; while (upper.length >= 2 && cross(upper[upper.length - 2], upper[upper.length - 1], p) <= 0) upper.pop(); upper.push(p); }
            upper.pop(); lower.pop();
            return lower.concat(upper);
        }

        function closePanel(type) {
            document.getElementById(type + 'Panel').classList.remove('show');
            if (type === 'fire') selectedFirePoint = null;
            if (type === 'water') selectedWater = null;
        }

        function flyToSelectedFire() {
            if (!selectedFirePoint) return;
            const c = selectedFirePoint.geometry.coordinates;
            viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(c[0], c[1], 500), duration: 1.5 });
        }

        function deleteSelectedFire() {
            if (!selectedFirePoint) return;
            const id = selectedFirePoint.id;
            firePoints = firePoints.filter(f => f.id !== id);
            const entity = firePointEntities.find(e => e.id === id);
            if (entity) { viewer.entities.remove(entity); firePointEntities = firePointEntities.filter(e => e.id !== id); }
            closePanel('fire');
            updateFireArea();
        }

        // ========== WATER SOURCES ==========
        let waterSources = [];
        let waterEntities = [];
        let selectedWater = null;
        let waterIdCounter = 0;

        function initDemoWaterSources() {
            [{ type: 'hydrant', name: '消火栓 #1', lat: 34.3858, lon: 132.4548 },
             { type: 'hydrant', name: '消火栓 #2', lat: 34.3848, lon: 132.4558 },
             { type: 'tank', name: '防火水槽 40t', lat: 34.3863, lon: 132.4563 },
             { type: 'tank', name: '防火水槽 100t', lat: 34.3843, lon: 132.4538 },
             { type: 'natural', name: '河川取水点', lat: 34.3838, lon: 132.4573 }
            ].forEach(w => addWaterSource(w.type, w.name, w.lon, w.lat));
        }

        function addWaterSource(type, name, lon, lat) {
            const id = `water-${++waterIdCounter}`;
            const source = { id, type, name, lon, lat };
            waterSources.push(source);
            const entity = viewer.entities.add({
                id, position: Cesium.Cartesian3.fromDegrees(lon, lat, 0),
                billboard: { image: createWaterIcon(type), width: 24, height: 24, verticalOrigin: Cesium.VerticalOrigin.CENTER, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND }
            });
            entity.show = layers.water;
            waterEntities.push(entity);
            return source;
        }

        function createWaterIcon(type) {
            const c = document.createElement('canvas'); c.width = 24; c.height = 24;
            const ctx = c.getContext('2d');
            const colors = { hydrant: '#f44336', tank: '#2196f3', natural: '#00bcd4' };
            ctx.beginPath(); ctx.arc(12, 12, 10, 0, Math.PI * 2); ctx.fillStyle = colors[type]; ctx.fill();
            ctx.fillStyle = 'white'; ctx.font = 'bold 12px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(type === 'hydrant' ? 'H' : type === 'tank' ? 'T' : 'N', 12, 12);
            return c.toDataURL();
        }

        function selectWater(id) {
            const source = waterSources.find(w => w.id === id);
            if (!source) return;
            selectedWater = source;
            document.getElementById('waterType').textContent = source.type === 'hydrant' ? '消火栓' : source.type === 'tank' ? '防火水槽' : '自然水利';
            document.getElementById('waterLat').textContent = source.lat.toFixed(6) + '°';
            document.getElementById('waterLon').textContent = source.lon.toFixed(6) + '°';
            if (selectedFirePoint) {
                const fc = selectedFirePoint.geometry.coordinates;
                document.getElementById('waterDist').textContent = formatDistance(haversineDistance(fc[1], fc[0], source.lat, source.lon));
            } else { document.getElementById('waterDist').textContent = '-'; }
            document.getElementById('waterPanel').classList.add('show');
        }

        function flyToSelectedWater() {
            if (!selectedWater) return;
            viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(selectedWater.lon, selectedWater.lat, 300), duration: 1.5 });
        }

        function deleteSelectedWater() {
            if (!selectedWater) return;
            const id = selectedWater.id;
            waterSources = waterSources.filter(w => w.id !== id);
            const entity = waterEntities.find(e => e.id === id);
            if (entity) { viewer.entities.remove(entity); waterEntities = waterEntities.filter(e => e.id !== id); }
            closePanel('water');
        }

        initDemoWaterSources();

        // ========== HOSE LINE (連続描画) ==========
        let hoseLinePoints = [];      // [{lon, lat, height, cartesian}]
        let hoseLineSegments = [];    // 各セグメントのEntity
        let hoseLineMarkers = [];     // ポイントマーカー
        let hoseLineEntities = [];    // 確定済みのライン
        let hoseLineIdCounter = 0;

        function updateHoseLineDisplay() {
            let totalDist = 0;
            let totalElev = 0;
            
            for (let i = 1; i < hoseLinePoints.length; i++) {
                const p1 = hoseLinePoints[i - 1];
                const p2 = hoseLinePoints[i];
                totalDist += haversineDistance(p1.lat, p1.lon, p2.lat, p2.lon);
                totalElev += Math.abs(p2.height - p1.height);
            }
            
            document.getElementById('hoseTotalDist').textContent = formatDistance(totalDist);
            document.getElementById('hoseTotalCount').textContent = Math.ceil(totalDist / 20) + ' 本';
            document.getElementById('hoseTotalElev').textContent = totalElev.toFixed(1) + ' m';
            document.getElementById('hosePointCount').textContent = hoseLinePoints.length;
            
            if (hoseLinePoints.length > 0) {
                document.getElementById('hoseHint').innerHTML = 'タップでポイント追加 / 「戻す」で1つ戻る';
            }
        }

        function addHoseLinePoint(lon, lat, height, cartesian) {
            const pointIndex = hoseLinePoints.length;
            hoseLinePoints.push({ lon, lat, height, cartesian });
            
            // マーカー追加
            const marker = viewer.entities.add({
                position: cartesian,
                point: { pixelSize: 10, color: Cesium.Color.ORANGE, outlineColor: Cesium.Color.WHITE, outlineWidth: 2, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND },
                label: { text: String(pointIndex + 1), font: '10px sans-serif', fillColor: Cesium.Color.WHITE, outlineColor: Cesium.Color.BLACK, outlineWidth: 2, style: Cesium.LabelStyle.FILL_AND_OUTLINE, verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0, -14) }
            });
            hoseLineMarkers.push(marker);
            
            // 前のポイントとの線を描画
            if (hoseLinePoints.length >= 2) {
                const prev = hoseLinePoints[hoseLinePoints.length - 2];
                const segment = viewer.entities.add({
                    polyline: {
                        positions: [prev.cartesian, cartesian],
                        width: 6,
                        material: new Cesium.PolylineDashMaterialProperty({ color: Cesium.Color.ORANGE, dashLength: 16 }),
                        clampToGround: true
                    }
                });
                hoseLineSegments.push(segment);
            }
            
            updateHoseLineDisplay();
        }

        function undoHosePoint() {
            if (hoseLinePoints.length === 0) return;
            
            hoseLinePoints.pop();
            
            // マーカー削除
            if (hoseLineMarkers.length > 0) {
                const marker = hoseLineMarkers.pop();
                viewer.entities.remove(marker);
            }
            
            // セグメント削除
            if (hoseLineSegments.length > 0) {
                const segment = hoseLineSegments.pop();
                viewer.entities.remove(segment);
            }
            
            updateHoseLineDisplay();
        }

        function resetHoseLine() {
            hoseLinePoints = [];
            hoseLineMarkers.forEach(e => viewer.entities.remove(e));
            hoseLineMarkers = [];
            hoseLineSegments.forEach(e => viewer.entities.remove(e));
            hoseLineSegments = [];
            updateHoseLineDisplay();
            document.getElementById('hoseHint').innerHTML = '地図をタップしてポイントを追加<br>連続でタップするとラインが繋がります';
        }

        function confirmHoseLine() {
            if (hoseLinePoints.length < 2) {
                alert('2点以上のポイントが必要です');
                return;
            }
            
            // 確定済みラインとして保存
            const id = `hoseline-${++hoseLineIdCounter}`;
            const positions = hoseLinePoints.map(p => p.cartesian);
            
            const lineEntity = viewer.entities.add({
                id: id,
                polyline: {
                    positions: positions,
                    width: 5,
                    material: new Cesium.PolylineDashMaterialProperty({ color: Cesium.Color.DARKORANGE, dashLength: 12 }),
                    clampToGround: true
                }
            });
            hoseLineEntities.push(lineEntity);
            
            // 作業用を削除
            hoseLineMarkers.forEach(e => viewer.entities.remove(e));
            hoseLineSegments.forEach(e => viewer.entities.remove(e));
            hoseLinePoints = [];
            hoseLineMarkers = [];
            hoseLineSegments = [];
            
            updateHoseLineDisplay();
            document.getElementById('hoseHint').innerHTML = 'ライン確定！続けて描画できます';
        }

        function closeHosePanel() {
            document.getElementById('hosePanel').classList.remove('active');
            resetHoseLine();
            document.querySelectorAll('.tools-group .tool-btn').forEach(b => b.classList.remove('active', 'hose-mode'));
            document.getElementById('modeIndicator').classList.remove('show');
            currentTool = null;
        }

        // ========== MEASURE (2点間計測) ==========
        let measurePoints = [];
        let measureEntities = [];

        function addMeasurePoint(lon, lat, height, cartesian) {
            measurePoints.push({ lon, lat, height, cartesian });
            
            const marker = viewer.entities.add({
                position: cartesian,
                point: { pixelSize: 8, color: Cesium.Color.CYAN, outlineColor: Cesium.Color.WHITE, outlineWidth: 2, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND },
                label: { text: `P${measurePoints.length}`, font: '10px sans-serif', fillColor: Cesium.Color.WHITE, outlineColor: Cesium.Color.BLACK, outlineWidth: 2, style: Cesium.LabelStyle.FILL_AND_OUTLINE, verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0, -12) }
            });
            measureEntities.push(marker);
            
            if (measurePoints.length === 2) {
                const p1 = measurePoints[0];
                const p2 = measurePoints[1];
                
                const line = viewer.entities.add({
                    polyline: { positions: [p1.cartesian, p2.cartesian], width: 3, material: new Cesium.PolylineGlowMaterialProperty({ glowPower: 0.2, color: Cesium.Color.CYAN }), clampToGround: true }
                });
                measureEntities.push(line);
                
                const dist = haversineDistance(p1.lat, p1.lon, p2.lat, p2.lon);
                const elev = p2.height - p1.height;
                
                document.getElementById('measureDistance').textContent = formatDistance(dist);
                document.getElementById('measureElevation').textContent = (elev >= 0 ? '+' : '') + elev.toFixed(1) + ' m';
                document.getElementById('measureStart').textContent = p1.height.toFixed(1) + ' m';
                document.getElementById('measureEnd').textContent = p2.height.toFixed(1) + ' m';
                document.getElementById('measureHint').style.display = 'none';
            }
        }

        function resetMeasure() {
            measurePoints = [];
            measureEntities.forEach(e => viewer.entities.remove(e));
            measureEntities = [];
            document.getElementById('measureDistance').textContent = '- m';
            document.getElementById('measureElevation').textContent = '- m';
            document.getElementById('measureStart').textContent = '- m';
            document.getElementById('measureEnd').textContent = '- m';
            document.getElementById('measureHint').style.display = 'block';
        }

        function closeMeasurePanel() {
            document.getElementById('measurePanel').classList.remove('active');
            resetMeasure();
            document.querySelectorAll('.tools-group .tool-btn').forEach(b => b.classList.remove('active', 'measure-mode'));
            document.getElementById('modeIndicator').classList.remove('show');
            currentTool = null;
        }

        // ========== TOOL SYSTEM ==========
        let currentTool = null;

        function setTool(tool) {
            // Reset all
            document.querySelectorAll('.tools-group .tool-btn').forEach(b => b.classList.remove('active', 'fire-mode', 'water-mode', 'hose-mode', 'measure-mode'));
            document.getElementById('modeIndicator').classList.remove('show', 'water-mode', 'hose-mode', 'measure-mode');
            document.getElementById('hosePanel').classList.remove('active');
            document.getElementById('measurePanel').classList.remove('active');
            
            if (currentTool === tool) { currentTool = null; return; }
            currentTool = tool;
            
            const indicator = document.getElementById('modeIndicator');
            const icon = document.getElementById('modeIcon');
            const text = document.getElementById('modeText');
            
            if (tool === 'fire') {
                document.getElementById('fireToolBtn').classList.add('active', 'fire-mode');
                icon.textContent = 'local_fire_department'; text.textContent = '火点追加モード';
                indicator.classList.add('show');
            } else if (tool === 'water') {
                document.getElementById('waterToolBtn').classList.add('active', 'water-mode');
                icon.textContent = 'water_drop'; text.textContent = '水利追加モード';
                indicator.classList.add('show', 'water-mode');
            } else if (tool === 'hose') {
                document.getElementById('hoseToolBtn').classList.add('active', 'hose-mode');
                icon.textContent = 'route'; text.textContent = 'ホース延長モード';
                indicator.classList.add('show', 'hose-mode');
                document.getElementById('hosePanel').classList.add('active');
                resetHoseLine();
            } else if (tool === 'measure') {
                document.getElementById('measureToolBtn').classList.add('active', 'measure-mode');
                icon.textContent = 'straighten'; text.textContent = '2点間計測モード';
                indicator.classList.add('show', 'measure-mode');
                document.getElementById('measurePanel').classList.add('active');
                resetMeasure();
            }
        }

        // ========== CLICK HANDLER ==========
        const clickHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        
        clickHandler.setInputAction(async function(click) {
            const picked = viewer.scene.pick(click.position);
            
            if (picked?.id?.id?.startsWith('fire-')) { selectFirePoint(picked.id.id); return; }
            if (picked?.id?.id?.startsWith('water-')) { selectWater(picked.id.id); return; }

            const ray = viewer.camera.getPickRay(click.position);
            const cartesian = viewer.scene.globe.pick(ray, viewer.scene);
            if (!cartesian) return;

            const carto = Cesium.Cartographic.fromCartesian(cartesian);
            const lon = Cesium.Math.toDegrees(carto.longitude);
            const lat = Cesium.Math.toDegrees(carto.latitude);
            
            let height = 0;
            try {
                const updated = await Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, [Cesium.Cartographic.fromDegrees(lon, lat)]);
                height = updated[0].height || 0;
            } catch (e) { height = carto.height || 0; }

            if (currentTool === 'fire') {
                const feature = addFirePoint(lon, lat, height);
                selectFirePoint(feature.id);
            } else if (currentTool === 'water') {
                const source = addWaterSource('hydrant', `消火栓 #${waterIdCounter + 1}`, lon, lat);
                selectWater(source.id);
            } else if (currentTool === 'hose') {
                addHoseLinePoint(lon, lat, height, cartesian);
            } else if (currentTool === 'measure') {
                if (measurePoints.length >= 2) resetMeasure();
                addMeasurePoint(lon, lat, height, cartesian);
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        // ========== UTILITIES ==========
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function formatDistance(m) { return m >= 1000 ? (m/1000).toFixed(2) + ' km' : m.toFixed(0) + ' m'; }
        function showLoading(show) { document.getElementById('loading').classList.toggle('show', show); }

        function setViewMode(mode) {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            event.target.closest('.view-btn').classList.add('active');
            viewer.scene.mode = mode === '2d' ? Cesium.SceneMode.SCENE2D : Cesium.SceneMode.SCENE3D;
        }

        let myLat = null, myLon = null;
        function flyToMyLocation() {
            if (myLat && myLon) viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(myLon, myLat, 1000), duration: 2 });
        }

        if ('geolocation' in navigator) {
            navigator.geolocation.watchPosition(
                pos => { myLat = pos.coords.latitude; myLon = pos.coords.longitude; document.getElementById('myCoords').textContent = `${myLat.toFixed(4)}°N ${myLon.toFixed(4)}°E`; },
                () => { document.getElementById('myCoords').textContent = '取得失敗'; },
                { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
            );
        }

        function shareView() {
            const p = viewer.camera.positionCartographic;
            const url = `${location.origin}${location.pathname}?lat=${Cesium.Math.toDegrees(p.latitude).toFixed(6)}&lon=${Cesium.Math.toDegrees(p.longitude).toFixed(6)}&h=${p.height.toFixed(0)}`;
            navigator.clipboard.writeText(url).then(() => alert('リンクをコピーしました'));
        }

        const params = new URLSearchParams(location.search);
        if (params.has('lat') && params.has('lon')) {
            viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(parseFloat(params.get('lon')), parseFloat(params.get('lat')), parseFloat(params.get('h')) || 3000), duration: 2 });
        }

        window.exportData = () => ({ firePoints, waterSources, hoseLines: hoseLineEntities.length });
    </script>
</body>
</html>
