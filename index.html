<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIS Platform - HardSkill OS</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans JP', sans-serif; overflow: hidden; background: #0a0a0a; }
        #cesiumContainer { width: 100vw; height: 100vh; }

        /* Top Bar */
        .top-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 52px;
            background: rgba(10, 10, 10, 0.92); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 12px; z-index: 1000;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon {
            width: 28px; height: 28px;
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
        }
        .logo-icon .material-icons { color: white; font-size: 18px; }
        .logo-text { color: white; font-weight: 700; font-size: 16px; }

        .top-controls { display: flex; gap: 6px; align-items: center; }
        
        .quick-toggle {
            display: flex; align-items: center; gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 6px 10px; border-radius: 16px;
            cursor: pointer; transition: all 0.2s;
            color: rgba(255, 255, 255, 0.5); font-size: 11px;
        }
        .quick-toggle:hover { background: rgba(255, 255, 255, 0.1); }
        .quick-toggle.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff; color: #00d4ff;
        }
        .quick-toggle .material-icons { font-size: 14px; }

        .user-section { display: flex; align-items: center; gap: 10px; }
        .status-indicator { display: flex; align-items: center; gap: 4px; color: #4ade80; font-size: 10px; }
        .status-dot { width: 6px; height: 6px; background: #4ade80; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .avatar {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, #ff6b6b, #ffa06b);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 600; font-size: 12px; cursor: pointer;
        }

        /* Left Panel - Layers */
        .left-panel {
            position: fixed; top: 64px; left: 12px; width: 220px;
            background: rgba(10, 10, 10, 0.92); backdrop-filter: blur(20px);
            border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 900; display: none; max-height: calc(100vh - 140px); overflow-y: auto;
        }
        .left-panel.show { display: block; }
        .panel-section { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .panel-section:last-child { border-bottom: none; }
        .section-title { color: rgba(255,255,255,0.4); font-size: 9px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        
        .layer-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px; border-radius: 6px; margin-bottom: 4px;
            cursor: pointer; transition: all 0.2s;
        }
        .layer-item:hover { background: rgba(255,255,255,0.05); }
        .layer-item.active { background: rgba(0, 212, 255, 0.1); }
        .layer-info { display: flex; align-items: center; gap: 8px; }
        .layer-icon { 
            width: 24px; height: 24px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
        }
        .layer-icon.terrain { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
        .layer-icon.building { background: rgba(33, 150, 243, 0.2); color: #2196f3; }
        .layer-icon.map { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .layer-icon.ocean { background: rgba(0, 188, 212, 0.2); color: #00bcd4; }
        .layer-icon.fire { background: rgba(244, 67, 54, 0.2); color: #f44336; }
        .layer-icon.water { background: rgba(33, 150, 243, 0.2); color: #2196f3; }
        .layer-name { color: white; font-size: 11px; }
        .layer-toggle {
            width: 32px; height: 18px; border-radius: 9px;
            background: rgba(255,255,255,0.1); position: relative;
            cursor: pointer; transition: all 0.2s;
        }
        .layer-toggle.on { background: #00d4ff; }
        .layer-toggle::after {
            content: ''; position: absolute; width: 14px; height: 14px;
            background: white; border-radius: 50%; top: 2px; left: 2px;
            transition: all 0.2s;
        }
        .layer-toggle.on::after { left: 16px; }

        /* Bottom Bar */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 12px; z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
        }

        .my-location {
            display: flex; align-items: center; gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px; border-radius: 8px;
            min-width: 160px; cursor: pointer;
        }
        .my-location .material-icons { color: #4ade80; font-size: 18px; }
        .my-location-text { display: flex; flex-direction: column; }
        .my-location-label { color: rgba(255,255,255,0.5); font-size: 9px; }
        .my-location-coords { color: white; font-size: 11px; font-family: monospace; }

        .tools-group { display: flex; gap: 4px; align-items: center; }
        .tool-btn {
            width: 40px; height: 40px;
            background: rgba(255, 255, 255, 0.05); border: none; border-radius: 8px;
            color: rgba(255, 255, 255, 0.6); cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .tool-btn:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .tool-btn.active { background: rgba(0, 212, 255, 0.2); color: #00d4ff; }
        .tool-btn.fire-mode { background: rgba(244, 67, 54, 0.2); color: #f44336; }
        .tool-btn .material-icons { font-size: 18px; }
        .tool-divider { width: 1px; height: 24px; background: rgba(255, 255, 255, 0.1); margin: 0 4px; }

        .view-toggle {
            display: flex; background: rgba(255, 255, 255, 0.05); border-radius: 6px; overflow: hidden;
        }
        .view-btn {
            padding: 8px 12px; border: none;
            background: transparent; color: rgba(255,255,255,0.5);
            cursor: pointer; transition: all 0.2s; font-size: 11px;
            display: flex; align-items: center; gap: 4px;
        }
        .view-btn:hover { background: rgba(255,255,255,0.05); }
        .view-btn.active { background: rgba(0, 212, 255, 0.2); color: #00d4ff; }
        .view-btn .material-icons { font-size: 14px; }

        /* Fire Point Info Panel */
        .fire-panel {
            position: fixed; top: 64px; right: 12px; width: 240px;
            background: rgba(10, 10, 10, 0.92); backdrop-filter: blur(20px);
            border-radius: 10px; border: 1px solid rgba(244, 67, 54, 0.3);
            z-index: 900; display: none;
        }
        .fire-panel.show { display: block; }
        .fire-panel-header {
            padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: space-between;
        }
        .fire-panel-title { color: #f44336; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .fire-panel-close { background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; }
        .fire-panel-content { padding: 12px; }
        .fire-info-row { display: flex; justify-content: space-between; padding: 6px 0; }
        .fire-info-label { color: rgba(255,255,255,0.5); font-size: 10px; }
        .fire-info-value { color: white; font-size: 11px; font-family: monospace; }
        .fire-actions { display: flex; gap: 6px; margin-top: 12px; }
        .fire-btn {
            flex: 1; padding: 8px; border: none; border-radius: 6px;
            font-size: 10px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 4px;
        }
        .fire-btn.primary { background: #f44336; color: white; }
        .fire-btn.secondary { background: rgba(255,255,255,0.1); color: white; }

        /* Measurement Panel */
        .measure-panel {
            position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%);
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px);
            padding: 14px 20px; border-radius: 12px;
            border: 1px solid rgba(0, 212, 255, 0.3); z-index: 900;
            min-width: 260px; display: none;
        }
        .measure-panel.active { display: block; }
        .measure-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .measure-title { color: #00d4ff; font-size: 11px; font-weight: 600; }
        .measure-close { background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 16px; }
        .measure-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
        .measure-label { color: rgba(255, 255, 255, 0.5); font-size: 11px; }
        .measure-value { color: white; font-size: 13px; font-weight: 600; font-family: monospace; }
        .measure-value.highlight { color: #00d4ff; font-size: 16px; }
        .measure-hint { color: rgba(255,255,255,0.4); font-size: 10px; text-align: center; margin-top: 10px; }
        .measure-actions { display: flex; gap: 6px; margin-top: 10px; }
        .measure-btn { flex: 1; padding: 6px; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; }
        .measure-btn.primary { background: #00d4ff; color: #000; }
        .measure-btn.secondary { background: rgba(255,255,255,0.1); color: white; }

        /* Mode Indicator */
        .mode-indicator {
            position: fixed; top: 64px; left: 50%; transform: translateX(-50%);
            background: rgba(244, 67, 54, 0.9); backdrop-filter: blur(10px);
            padding: 8px 16px; border-radius: 20px;
            display: none; align-items: center; gap: 8px; z-index: 1000;
        }
        .mode-indicator.show { display: flex; }
        .mode-indicator .material-icons { color: white; font-size: 16px; }
        .mode-indicator span { color: white; font-size: 12px; font-weight: 500; }

        /* Hide Cesium UI */
        .cesium-viewer-toolbar, .cesium-viewer-animationContainer,
        .cesium-viewer-timelineContainer, .cesium-viewer-fullscreenContainer,
        .cesium-viewer-bottom { display: none !important; }

        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

        @media (max-width: 600px) {
            .logo-text { display: none; }
            .quick-toggle span:not(.material-icons) { display: none; }
            .quick-toggle { padding: 6px; }
            .my-location { min-width: auto; padding: 6px 8px; }
            .my-location-label { display: none; }
            .left-panel { width: 200px; }
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="logo">
            <div class="logo-icon"><span class="material-icons">public</span></div>
            <span class="logo-text">GIS Platform</span>
        </div>

        <div class="top-controls">
            <div class="quick-toggle active" onclick="toggleQuickLayer(this, 'terrain')" title="3DÂú∞ÂΩ¢">
                <span class="material-icons">terrain</span>
                <span>Âú∞ÂΩ¢</span>
            </div>
            <div class="quick-toggle active" onclick="toggleQuickLayer(this, 'buildings')" title="3DÂª∫Áâ©">
                <span class="material-icons">location_city</span>
                <span>Âª∫Áâ©</span>
            </div>
            <div class="quick-toggle" onclick="toggleQuickLayer(this, 'gsimap')" title="ÂõΩÂúüÂú∞ÁêÜÈô¢">
                <span class="material-icons">map</span>
                <span>Âú∞Âõ≥</span>
            </div>
            <div class="quick-toggle" onclick="toggleQuickLayer(this, 'bathymetry')" title="Êµ∑Â∫ïÂú∞ÂΩ¢">
                <span class="material-icons">waves</span>
                <span>Êµ∑Â∫ï</span>
            </div>
        </div>

        <div class="user-section">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>Êé•Á∂ö‰∏≠</span>
            </div>
            <div class="avatar">K</div>
        </div>
    </div>

    <!-- Mode Indicator -->
    <div class="mode-indicator" id="modeIndicator">
        <span class="material-icons">local_fire_department</span>
        <span>ÁÅ´ÁÇπËøΩÂä†„É¢„Éº„Éâ - Âú∞Âõ≥„Çí„Çø„ÉÉ„Éó</span>
    </div>

    <!-- Left Panel - Layers -->
    <div class="left-panel" id="layerPanel">
        <div class="panel-section">
            <div class="section-title">Truth LayerÔºàÁâ©ÁêÜÁöÑÊ≠£Ëß£Ôºâ</div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'terrain')">
                <div class="layer-info">
                    <div class="layer-icon terrain"><span class="material-icons">terrain</span></div>
                    <span class="layer-name">Cesium World Terrain</span>
                </div>
                <div class="layer-toggle on" id="toggle-terrain"></div>
            </div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'bathymetry')">
                <div class="layer-info">
                    <div class="layer-icon ocean"><span class="material-icons">waves</span></div>
                    <span class="layer-name">Êµ∑Â∫ï„Éê„ÉÅ„É°„Éà„É™</span>
                </div>
                <div class="layer-toggle" id="toggle-bathymetry"></div>
            </div>
        </div>
        
        <div class="panel-section">
            <div class="section-title">Reference LayerÔºàÂèÇÁÖßÔºâ</div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'buildings')">
                <div class="layer-info">
                    <div class="layer-icon building"><span class="material-icons">location_city</span></div>
                    <span class="layer-name">PLATEAU 3DÂª∫Áâ©</span>
                </div>
                <div class="layer-toggle on" id="toggle-buildings"></div>
            </div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'gsimap')">
                <div class="layer-info">
                    <div class="layer-icon map"><span class="material-icons">map</span></div>
                    <span class="layer-name">ÂõΩÂúüÂú∞ÁêÜÈô¢Âú∞Âõ≥</span>
                </div>
                <div class="layer-toggle" id="toggle-gsimap"></div>
            </div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'satellite')">
                <div class="layer-info">
                    <div class="layer-icon terrain"><span class="material-icons">satellite_alt</span></div>
                    <span class="layer-name">Ë°õÊòüÁîªÂÉè</span>
                </div>
                <div class="layer-toggle on" id="toggle-satellite"></div>
            </div>
        </div>

        <div class="panel-section">
            <div class="section-title">Operation LayerÔºàÊìç‰ΩúÔºâ</div>
            <div class="layer-item" onclick="toggleLayerItem(this, 'firepoints')">
                <div class="layer-info">
                    <div class="layer-icon fire"><span class="material-icons">local_fire_department</span></div>
                    <span class="layer-name">ÁÅ´ÁÇπ</span>
                </div>
                <div class="layer-toggle on" id="toggle-firepoints"></div>
            </div>
        </div>
    </div>

    <!-- Fire Point Info Panel -->
    <div class="fire-panel" id="firePanel">
        <div class="fire-panel-header">
            <span class="fire-panel-title">
                <span class="material-icons">local_fire_department</span>
                ÁÅ´ÁÇπÊÉÖÂ†±
            </span>
            <button class="fire-panel-close" onclick="closeFirePanel()">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="fire-panel-content">
            <div class="fire-info-row">
                <span class="fire-info-label">Á∑ØÂ∫¶</span>
                <span class="fire-info-value" id="fireLat">-</span>
            </div>
            <div class="fire-info-row">
                <span class="fire-info-label">ÁµåÂ∫¶</span>
                <span class="fire-info-value" id="fireLon">-</span>
            </div>
            <div class="fire-info-row">
                <span class="fire-info-label">Ê®ôÈ´ò</span>
                <span class="fire-info-value" id="fireElev">-</span>
            </div>
            <div class="fire-info-row">
                <span class="fire-info-label">ËøΩÂä†ÊôÇÂàª</span>
                <span class="fire-info-value" id="fireTime">-</span>
            </div>
            <div class="fire-actions">
                <button class="fire-btn secondary" onclick="flyToSelectedFire()">
                    <span class="material-icons">flight</span> ÁßªÂãï
                </button>
                <button class="fire-btn primary" onclick="deleteSelectedFire()">
                    <span class="material-icons">delete</span> ÂâäÈô§
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Bar -->
    <div class="bottom-bar">
        <div class="my-location" onclick="flyToMyLocation()">
            <span class="material-icons">my_location</span>
            <div class="my-location-text">
                <span class="my-location-label">ÁèæÂú®Âú∞</span>
                <span class="my-location-coords" id="myCoords">ÂèñÂæó‰∏≠...</span>
            </div>
        </div>

        <div class="tools-group">
            <button class="tool-btn" title="„É¨„Ç§„É§„Éº" onclick="toggleLayerPanel()">
                <span class="material-icons">layers</span>
            </button>
            <div class="tool-divider"></div>
            <button class="tool-btn" title="ÁÅ´ÁÇπËøΩÂä†" onclick="setTool('fire')" id="fireToolBtn">
                <span class="material-icons">local_fire_department</span>
            </button>
            <button class="tool-btn" title="Ë∑ùÈõ¢Ë®àÊ∏¨" onclick="setTool('distance')">
                <span class="material-icons">straighten</span>
            </button>
            <button class="tool-btn" title="È´òÂ∫¶Ë®àÊ∏¨" onclick="setTool('elevation')">
                <span class="material-icons">height</span>
            </button>
            <div class="tool-divider"></div>
            <button class="tool-btn" title="ÂÖ±Êúâ" onclick="shareView()">
                <span class="material-icons">share</span>
            </button>
        </div>

        <div class="view-toggle">
            <button class="view-btn" onclick="setViewMode('2d')">
                <span class="material-icons">map</span> 2D
            </button>
            <button class="view-btn active" onclick="setViewMode('3d')">
                <span class="material-icons">view_in_ar</span> 3D
            </button>
        </div>
    </div>

    <!-- Measurement Panel -->
    <div class="measure-panel" id="measurePanel">
        <div class="measure-header">
            <span class="measure-title" id="measureTitle">Ë∑ùÈõ¢Ë®àÊ∏¨</span>
            <button class="measure-close" onclick="closeMeasure()">√ó</button>
        </div>
        <div class="measure-row">
            <span class="measure-label">Ê∞¥Âπ≥Ë∑ùÈõ¢</span>
            <span class="measure-value highlight" id="measureDistance">- m</span>
        </div>
        <div class="measure-row">
            <span class="measure-label">È´òÂ∫¶Â∑Æ</span>
            <span class="measure-value" id="measureElevation">- m</span>
        </div>
        <div class="measure-row">
            <span class="measure-label">ÂßãÁÇπÊ®ôÈ´ò</span>
            <span class="measure-value" id="measureStart">- m</span>
        </div>
        <div class="measure-row">
            <span class="measure-label">ÁµÇÁÇπÊ®ôÈ´ò</span>
            <span class="measure-value" id="measureEnd">- m</span>
        </div>
        <div class="measure-hint" id="measureHint">Âú∞Âõ≥‰∏ä„ÅÆ2ÁÇπ„Çí„Çø„ÉÉ„Éó</div>
        <div class="measure-actions">
            <button class="measure-btn secondary" onclick="resetMeasure()">„É™„Çª„ÉÉ„Éà</button>
            <button class="measure-btn primary" onclick="closeMeasure()">ÂÆå‰∫Ü</button>
        </div>
    </div>

    <script>
        // ========================================
        // CESIUM INITIALIZATION
        // ========================================
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIwM2NhOTIxMi03NzRmLTQzMDgtYTMzZS1kOWEyMjBmNjhhMmEiLCJpZCI6Mzg1NDQ0LCJpYXQiOjE3Njk4Mzg4NTl9.ElD_8Qq0Mp1QuoaQvnODwTCVtEfaQtuDrsS9tnwlryA';

        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrain: Cesium.Terrain.fromWorldTerrain(),
            timeline: false, animation: false, baseLayerPicker: false,
            geocoder: false, homeButton: false, sceneModePicker: false,
            navigationHelpButton: false, fullscreenButton: false,
            infoBox: false, selectionIndicator: false
        });

        // Initial view - Hiroshima
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(132.4553, 34.3853, 8000),
            orientation: { heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0 },
            duration: 0
        });

        // ========================================
        // LAYER MANAGEMENT
        // ========================================
        let plateauTileset = null;
        let gsiLayer = null;
        let bathymetryEnabled = false;

        // Truth Layer: PLATEAU 3D Buildings
        async function loadPlateauBuildings() {
            try {
                plateauTileset = await Cesium.Cesium3DTileset.fromIonAssetId(2602291);
                viewer.scene.primitives.add(plateauTileset);
                console.log('PLATEAU buildings loaded');
            } catch (e) { console.error('PLATEAU error:', e); }
        }
        loadPlateauBuildings();

        // Reference Layer: GSI Map
        function initGsiLayer() {
            gsiLayer = viewer.imageryLayers.addImageryProvider(
                new Cesium.UrlTemplateImageryProvider({
                    url: 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
                    maximumLevel: 18,
                    credit: 'ÂõΩÂúüÂú∞ÁêÜÈô¢'
                })
            );
            gsiLayer.alpha = 0.7;
            gsiLayer.show = false;
        }
        initGsiLayer();

        // Layer toggle functions
        const layers = {
            terrain: true,
            buildings: true,
            gsimap: false,
            satellite: true,
            bathymetry: false,
            firepoints: true
        };

        function toggleQuickLayer(el, layer) {
            el.classList.toggle('active');
            layers[layer] = el.classList.contains('active');
            applyLayerState(layer);
            syncLayerToggle(layer);
        }

        function toggleLayerItem(el, layer) {
            const toggle = el.querySelector('.layer-toggle');
            toggle.classList.toggle('on');
            layers[layer] = toggle.classList.contains('on');
            applyLayerState(layer);
        }

        function syncLayerToggle(layer) {
            const toggle = document.getElementById(`toggle-${layer}`);
            if (toggle) {
                if (layers[layer]) toggle.classList.add('on');
                else toggle.classList.remove('on');
            }
        }

        function applyLayerState(layer) {
            switch(layer) {
                case 'terrain':
                    viewer.scene.terrainProvider = layers.terrain 
                        ? Cesium.Terrain.fromWorldTerrain()
                        : new Cesium.EllipsoidTerrainProvider();
                    break;
                case 'buildings':
                    if (plateauTileset) plateauTileset.show = layers.buildings;
                    break;
                case 'gsimap':
                    if (gsiLayer) gsiLayer.show = layers.gsimap;
                    break;
                case 'satellite':
                    viewer.imageryLayers.get(0).show = layers.satellite;
                    break;
                case 'bathymetry':
                    // Êµ∑Â∫ï„Éê„ÉÅ„É°„Éà„É™ - Â∞ÜÊù•ÁöÑ„Å´GEBCO„Éá„Éº„Çø„Å™„Å©„ÇíËøΩÂä†
                    bathymetryEnabled = layers.bathymetry;
                    console.log('Bathymetry:', bathymetryEnabled ? 'ON' : 'OFF');
                    break;
                case 'firepoints':
                    firePointEntities.forEach(e => e.show = layers.firepoints);
                    break;
            }
        }

        function toggleLayerPanel() {
            document.getElementById('layerPanel').classList.toggle('show');
        }

        // ========================================
        // FIRE POINT SYSTEM (Operation Layer)
        // ========================================
        let firePoints = []; // GeoJSON FeatureCollection
        let firePointEntities = [];
        let selectedFirePoint = null;
        let firePointIdCounter = 0;

        function addFirePoint(lon, lat, height) {
            const id = `fire-${++firePointIdCounter}`;
            const timestamp = new Date().toLocaleString('ja-JP');
            
            // GeoJSON Feature
            const feature = {
                type: 'Feature',
                id: id,
                geometry: {
                    type: 'Point',
                    coordinates: [lon, lat, height]
                },
                properties: {
                    timestamp: timestamp,
                    elevation: height
                }
            };
            firePoints.push(feature);

            // Cesium Entity
            const entity = viewer.entities.add({
                id: id,
                position: Cesium.Cartesian3.fromDegrees(lon, lat, height),
                billboard: {
                    image: createFireIcon(),
                    width: 32, height: 32,
                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                },
                label: {
                    text: 'üî•',
                    font: '16px sans-serif',
                    verticalOrigin: Cesium.VerticalOrigin.TOP,
                    pixelOffset: new Cesium.Cartesian2(0, 8),
                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                }
            });
            firePointEntities.push(entity);

            console.log('Fire point added:', feature);
            return feature;
        }

        function createFireIcon() {
            const canvas = document.createElement('canvas');
            canvas.width = 32; canvas.height = 32;
            const ctx = canvas.getContext('2d');
            
            // Outer glow
            ctx.beginPath();
            ctx.arc(16, 16, 14, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(244, 67, 54, 0.3)';
            ctx.fill();
            
            // Inner circle
            ctx.beginPath();
            ctx.arc(16, 16, 10, 0, Math.PI * 2);
            ctx.fillStyle = '#f44336';
            ctx.fill();
            
            // Center
            ctx.beginPath();
            ctx.arc(16, 16, 5, 0, Math.PI * 2);
            ctx.fillStyle = '#ffeb3b';
            ctx.fill();
            
            return canvas.toDataURL();
        }

        function selectFirePoint(id) {
            const feature = firePoints.find(f => f.id === id);
            if (!feature) return;
            
            selectedFirePoint = feature;
            const coords = feature.geometry.coordinates;
            
            document.getElementById('fireLat').textContent = coords[1].toFixed(6) + '¬∞';
            document.getElementById('fireLon').textContent = coords[0].toFixed(6) + '¬∞';
            document.getElementById('fireElev').textContent = (coords[2] || 0).toFixed(1) + ' m';
            document.getElementById('fireTime').textContent = feature.properties.timestamp;
            
            document.getElementById('firePanel').classList.add('show');
        }

        function closeFirePanel() {
            document.getElementById('firePanel').classList.remove('show');
            selectedFirePoint = null;
        }

        function flyToSelectedFire() {
            if (!selectedFirePoint) return;
            const coords = selectedFirePoint.geometry.coordinates;
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(coords[0], coords[1], 500),
                orientation: { heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0 },
                duration: 1.5
            });
        }

        function deleteSelectedFire() {
            if (!selectedFirePoint) return;
            
            const id = selectedFirePoint.id;
            firePoints = firePoints.filter(f => f.id !== id);
            
            const entity = firePointEntities.find(e => e.id === id);
            if (entity) {
                viewer.entities.remove(entity);
                firePointEntities = firePointEntities.filter(e => e.id !== id);
            }
            
            closeFirePanel();
            console.log('Fire point deleted:', id);
        }

        // ========================================
        // TOOL SYSTEM
        // ========================================
        let currentTool = null;
        let measurePoints = [];
        let measureEntities = [];

        function setTool(tool) {
            // Reset previous
            resetMeasure();
            document.querySelectorAll('.tools-group .tool-btn').forEach(b => {
                b.classList.remove('active', 'fire-mode');
            });
            document.getElementById('modeIndicator').classList.remove('show');
            
            if (currentTool === tool) {
                currentTool = null;
                return;
            }
            
            currentTool = tool;
            
            if (tool === 'fire') {
                document.getElementById('fireToolBtn').classList.add('active', 'fire-mode');
                document.getElementById('modeIndicator').classList.add('show');
            } else if (['distance', 'elevation'].includes(tool)) {
                event.target.closest('.tool-btn').classList.add('active');
                document.getElementById('measurePanel').classList.add('active');
                document.getElementById('measureTitle').textContent = 
                    tool === 'distance' ? 'Ë∑ùÈõ¢Ë®àÊ∏¨' : 'È´òÂ∫¶Ë®àÊ∏¨';
            }
        }

        function closeMeasure() {
            document.getElementById('measurePanel').classList.remove('active');
            document.querySelectorAll('.tools-group .tool-btn').forEach(b => b.classList.remove('active'));
            resetMeasure();
            currentTool = null;
        }

        function resetMeasure() {
            measurePoints = [];
            measureEntities.forEach(e => viewer.entities.remove(e));
            measureEntities = [];
            document.getElementById('measureDistance').textContent = '- m';
            document.getElementById('measureElevation').textContent = '- m';
            document.getElementById('measureStart').textContent = '- m';
            document.getElementById('measureEnd').textContent = '- m';
            document.getElementById('measureHint').style.display = 'block';
        }

        // ========================================
        // CLICK HANDLER
        // ========================================
        const clickHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        
        clickHandler.setInputAction(async function(click) {
            // Check if clicked on existing fire point
            const picked = viewer.scene.pick(click.position);
            if (picked && picked.id && picked.id.id && picked.id.id.startsWith('fire-')) {
                selectFirePoint(picked.id.id);
                return;
            }

            // Get ground position
            const ray = viewer.camera.getPickRay(click.position);
            const cartesian = viewer.scene.globe.pick(ray, viewer.scene);
            if (!cartesian) return;

            const carto = Cesium.Cartographic.fromCartesian(cartesian);
            const lon = Cesium.Math.toDegrees(carto.longitude);
            const lat = Cesium.Math.toDegrees(carto.latitude);
            
            let height = 0;
            try {
                const updated = await Cesium.sampleTerrainMostDetailed(
                    viewer.terrainProvider, 
                    [Cesium.Cartographic.fromDegrees(lon, lat)]
                );
                height = updated[0].height || 0;
            } catch (e) { height = carto.height || 0; }

            // Fire point mode
            if (currentTool === 'fire') {
                const feature = addFirePoint(lon, lat, height);
                selectFirePoint(feature.id);
                return;
            }

            // Measurement mode
            if (['distance', 'elevation'].includes(currentTool)) {
                measurePoints.push({ lon, lat, height, cartesian });

                const marker = viewer.entities.add({
                    position: cartesian,
                    point: { 
                        pixelSize: 8, color: Cesium.Color.YELLOW, 
                        outlineColor: Cesium.Color.BLACK, outlineWidth: 2,
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND 
                    },
                    label: { 
                        text: `P${measurePoints.length}`, font: '11px sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK, outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -12)
                    }
                });
                measureEntities.push(marker);

                if (measurePoints.length >= 2) {
                    const p1 = measurePoints[measurePoints.length - 2];
                    const p2 = measurePoints[measurePoints.length - 1];
                    
                    const line = viewer.entities.add({
                        polyline: {
                            positions: [p1.cartesian, p2.cartesian],
                            width: 3,
                            material: new Cesium.PolylineGlowMaterialProperty({
                                glowPower: 0.2, color: Cesium.Color.CYAN
                            }),
                            clampToGround: true
                        }
                    });
                    measureEntities.push(line);

                    // Haversine distance
                    const R = 6371000;
                    const dLat = (p2.lat - p1.lat) * Math.PI / 180;
                    const dLon = (p2.lon - p1.lon) * Math.PI / 180;
                    const a = Math.sin(dLat/2)**2 + 
                              Math.cos(p1.lat*Math.PI/180) * Math.cos(p2.lat*Math.PI/180) * 
                              Math.sin(dLon/2)**2;
                    const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    const elev = p2.height - p1.height;

                    document.getElementById('measureDistance').textContent = 
                        dist >= 1000 ? (dist/1000).toFixed(2) + ' km' : dist.toFixed(1) + ' m';
                    document.getElementById('measureElevation').textContent = 
                        (elev >= 0 ? '+' : '') + elev.toFixed(1) + ' m';
                    document.getElementById('measureStart').textContent = p1.height.toFixed(1) + ' m';
                    document.getElementById('measureEnd').textContent = p2.height.toFixed(1) + ' m';
                    document.getElementById('measureHint').style.display = 'none';
                }
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        // ========================================
        // VIEW MODE
        // ========================================
        function setViewMode(mode) {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            event.target.closest('.view-btn').classList.add('active');
            viewer.scene.mode = mode === '2d' ? Cesium.SceneMode.SCENE2D : Cesium.SceneMode.SCENE3D;
        }

        // ========================================
        // LOCATION TRACKING
        // ========================================
        let myLat = null, myLon = null;

        function updateMyLocationDisplay() {
            const el = document.getElementById('myCoords');
            if (myLat && myLon) {
                el.textContent = `${myLat.toFixed(4)}¬∞N ${myLon.toFixed(4)}¬∞E`;
            }
        }

        function flyToMyLocation() {
            if (myLat && myLon) {
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(myLon, myLat, 1000),
                    orientation: { heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0 },
                    duration: 2
                });
            }
        }

        if ('geolocation' in navigator) {
            navigator.geolocation.watchPosition(
                pos => {
                    myLat = pos.coords.latitude;
                    myLon = pos.coords.longitude;
                    updateMyLocationDisplay();
                },
                () => { document.getElementById('myCoords').textContent = 'ÂèñÂæóÂ§±Êïó'; },
                { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
            );
        }

        // ========================================
        // UTILITIES
        // ========================================
        function shareView() {
            const p = viewer.camera.positionCartographic;
            const url = `${location.origin}${location.pathname}?lat=${Cesium.Math.toDegrees(p.latitude).toFixed(6)}&lon=${Cesium.Math.toDegrees(p.longitude).toFixed(6)}&h=${p.height.toFixed(0)}`;
            navigator.clipboard.writeText(url).then(() => alert('„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'));
        }

        // URL params
        const params = new URLSearchParams(location.search);
        if (params.has('lat') && params.has('lon')) {
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(
                    parseFloat(params.get('lon')),
                    parseFloat(params.get('lat')),
                    parseFloat(params.get('h')) || 3000
                ),
                duration: 2
            });
        }

        // Export fire points as GeoJSON (for debugging)
        window.exportFirePoints = function() {
            const geojson = {
                type: 'FeatureCollection',
                features: firePoints
            };
            console.log(JSON.stringify(geojson, null, 2));
            return geojson;
        };
    </script>
</body>
</html>
